---
title: 'vault secrets operator ì‚¬ìš©í•´ë³´ê¸°'
date: '2023-12-22'
tags: [Kubernetes, vault]
images: ['/static/images/social-banner.png']
summary: 'GitOpsì—ì„œ Secretì„ ì–´ë–»ê²Œ ê´€ë¦¬í• ì§€ ê³ ë¯¼ì„ í•˜ì˜€ê³ , ê°œë°œìë“¤ì˜ ì¸ì§€ë¶€í•˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´ì„œ Vault UIë¡œ ìì‹ ì˜ ì•±ì˜ ë¹„ë°€ê°’ì„ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì œì¼ íš¨ìœ¨ì ì´ë¼ëŠ” íŒë‹¨ì„ í–ˆë‹¤. Vault secrets operatorê°€ GAë¡œ ê³µìœ ê°€ ë˜ì—ˆê³ , Secrets Store CSIë‚˜ External secrets í”„ë¡œì íŠ¸ë³´ë‹¤ ê¹”ë”í•œ ë°©ì‹ì´ë¼ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤. Vault secrets operatorì˜ CRDë¡œ vault secretê³¼ kubernetes secretì˜ syncë¥¼ ë§ì¶”ê³ , reloaderë¡œ secretì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ ë‹¤ì‹œ podë¥¼ ë°°í¬í•˜ëŠ” ê²ƒì„ í…ŒìŠ¤íŠ¸í•´ë³´ì•˜ë‹¤.'
---

GitOpsë¡œ Secretì„ ê´€ë¦¬í•  ë•Œ, Secretì„ ì•”í˜¸í™”í•´ì„œ Gitì— ì˜¬ë¦¬ëŠ” ë°©ë²•ê³¼ Secret management toolë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ê¸°í™”í•˜ëŠ” ë°©ë²•ì„ ìƒê°í•´ë³¼ ìˆ˜ ìˆë‹¤. [Red Hat ë¸”ë¡œê·¸ì—ì„œ GitOpsì—ì„œ Secretì„ ê´€ë¦¬í•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ë“¤ì„ ì˜ ì„¤ëª…í•˜ê³  ìˆë‹¤.](https://www.redhat.com/en/blog/a-guide-to-secrets-management-with-gitops-and-kubernetes)

ê°œë°œìë“¤ì˜ ì¸ì§€ë¶€í•˜ë¥¼ ìµœì†Œí•œí™” í•˜ê³  ê°œë°œì— ì§‘ì¤‘í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ ë§Œë“œëŠ” ê²ƒì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•œë‹¤. ê·¸ë˜ì„œ ê°œë°œìë“¤ì´ ì¿ ë²„ë„¤í‹°ìŠ¤ì— ëŒ€í•´ì„œ ìµœì†Œí•œìœ¼ë¡œ ì•Œê³  ê°œë°œì„ í•  ìˆ˜ ìˆê²Œ í™˜ê²½ì„ ë§Œë“¤ê³ ì í–ˆë‹¤. VaultëŠ” Web UIë¥¼ ì œê³µí•˜ê³ , ì„¸ë¶€ì ìœ¼ë¡œ ê¶Œí•œ ì„¤ì •ì„ í•  ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ ê°œë°œìë“¤ì€ Web UIì—ë§Œ ì ‘ê·¼í•˜ì—¬ ìì‹ ì˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ê³¼ ê´€ë ¨ëœ secret ì •ë³´ë¥¼ ë°”ê¿€ ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  vaultì˜ ë‹¤ì–‘í•œ engineì„ í†µí•´ì„œ ì„ì‹œ credential ë°œê¸‰ í•˜ê±°ë‚˜ rotationì„ í•˜ëŠ” ê²ƒì„ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

ì˜¬í•´ Hashicorpê°€ ì œê³µí•˜ëŠ” Productë“¤ì˜ Licenseê°€ BSL(Business Source License)ë¡œ ë³€ê²½ë˜ì—ˆë‹¤. ë¼ì´ì„¼ìŠ¤ ë³€ê²½ ë•Œë¬¸ì— Terraformì„ forkí•œ ì˜¤í”ˆ ì†ŒìŠ¤ í”„ë¡œì íŠ¸ì¸ OpenTofuê°€ íƒ„ìƒí•˜ê¸°ë„ í–ˆë‹¤. ê¸°ì¡´ì˜ Vault versionë“¤ì€ ì—¬ì „íˆ MPL(Mozilla Public License) 2.0ë¡œ ì‚¬ìš©ê°€ëŠ¥í•˜ê³ , Hashicorpì™€ ê²½ìŸì ì¸ í”„ë¡œë•íŠ¸ë¥¼ ë§Œë“œëŠ” ê³³ì´ ì•„ë‹ˆë¼ë©´ ì—¬ì „íˆ Vaultë¥¼ ë¼ì´ì„¼ìŠ¤ êµ¬ë§¤ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.

Vaultë¥¼ í™œìš©í•˜ì—¬ Kubernetesì—ì„œ secret managementë¥¼ í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ì•„ë˜ì™€ ê°™ì´ ë‚˜ì—´í•´ë³¼ ìˆ˜ ìˆë‹¤.

- Secrets Store CSI + Vault Provider
- External Secrets
- Vault secrets operator

Secrets Store CSIëŠ” vaultì˜ secretê³¼ kubernetes secretì˜ syncë¥¼ ë§ì¶”ëŠ” [secret-auto-rotation](https://secrets-store-csi-driver.sigs.k8s.io/topics/secret-auto-rotation) ê¸°ëŠ¥ì´ ì•„ì§ë„ alpha featureë¡œ ë‚¨ì•„ ìˆë‹¤. ê·¸ë¦¬ê³  node-driver-registrarë¡œ kubeletì— binaryë¥¼ ì¶”ê°€í•˜ëŠ” ì„¤ì •ë„ í•´ì•¼ í•œë‹¤. [External Secretsì€ ì´ì „ì— ì†ŒìŠ¤ì½”ë“œë¥¼ ì‚´í´ë³¸ì ì´ ìˆëŠ”ë°](https://jayground8.github.io/blog/20230730-k8s-controller-external-secrets), ì´ í”„ë¡œì íŠ¸ë„ ì¢‹ì€ ì˜µì…˜ì´ë¼ê³  ìƒê°ì´ ë“¤ì—ˆë‹¤. í•˜ì§€ë§Œ Vaultë§Œ ì‚¬ìš©í•  ê³„íšì´ê³ , Hashicorpì—ì„œ ì œê³µí•˜ëŠ” vault secrets operatorì˜ CRDê°€ ë” ì§ê´€ì ì´ê³  ê¹”ë”í–ˆë‹¤. ê·¸ë¦¬ê³  [GAë¡œ ì œê³µí•œë‹¤ëŠ” ê³µì§€ë„](https://www.hashicorp.com/blog/vault-secrets-operator-for-kubernetes-now-ga) ìˆì—ˆê³ , ì•ìœ¼ë¡œ ê´€ë¦¬ ì¸¡ë©´ì—ì„œë„ ìœ ë¦¬í•˜ë‹¤ê³  íŒë‹¨í•˜ì˜€ë‹¤.

## vault

[HashCorp ë¬¸ì„œ](https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-raft-deployment-guide)ì—ì„œ ì¹œì ˆí•˜ê²Œ ì–´ë–»ê²Œ Vaultì„ Production í™˜ê²½ì—ì„œ ì„¤ì¹˜í•  ìˆ˜ ìˆëŠ”ì§€ ì„¤ëª…í•´ì£¼ê³  ìˆë‹¤.

### Certificate ì¤€ë¹„

opensslë¡œ keyì™€ csrë¥¼ ìƒì„±í•œë‹¤. [Kubernetes ë¬¸ì„œ](https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/)ì—ì„œ CNê³¼ Organizationdì„ ì•„ë˜ì™€ ê°™ì´ ì„¤ì •í•´ì•¼ ëœë‹¤ê³  ë‚˜ì˜¨ë‹¤. ë”°ë¼ì„œ `vault-csr.conf`ì— í•´ë‹¹ ë‚´ìš©ì´ ë°˜ì˜ë˜ì–´ ìˆë‹¤.

```
Permitted subjects - organizations are exactly ["system:nodes"], common name starts with "system:node:".
```

```bash
openssl genrsa -out vault.key 2048
```

Helmìœ¼ë¡œ resourceë¥¼ ìƒì„±í•  ë•Œ headless serviceë¡œ `vault-internal`ì´ ìƒì„±ëœë‹¤. Raftë¡œ Vault nodeë“¤ì´ clusterë¥¼ í˜•ì„±í•  ë•Œ ì´ headless serviceì˜ DNS ì´ë¦„ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— `vault-csr.conf`ì— ì¶”ê°€ë˜ì—ˆë‹¤.

`vault-csr.conf`

```bash
[req]
default_bits = 2048
prompt = no
encrypt_key = yes
default_md = sha256
distinguished_name = kubelet_serving
req_extensions = v3_req
[ kubelet_serving ]
O = system:nodes
CN = system:node:*.vault.svc.cluster.local
[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names
[alt_names]
DNS.1 = *.vault-internal
DNS.2 = *.vault-internal.vault.svc.cluster.local
DNS.3 = *.vault
DNS.4 = *.vault.svc.cluster.local
DNS.5 = *.vault.svc
IP.1 = 127.0.0.1
```

```bash
openssl req -new -key vault.key -out vault.csr -config vault-csr.conf
cat vault.csr|base64|tr -d '\n'
```

ì´ì œ Kubernetes Root CAë¡œ Signí•˜ê¸° ìœ„í•´ì„œ `CertificateSigningRequest` resourceë¥¼ ë§Œë“ ë‹¤.

`csr.yml`

```yaml
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: vault.svc
spec:
  signerName: kubernetes.io/kubelet-serving
  expirationSeconds: 8640000
  request: '{vault.csr base64 ì¸ì½”ë”© ê°’}'
  usages:
    - digital signature
    - key encipherment
    - server auth
```

```bash
kubectl apply -f csr.yml
```

ì´ë ‡ê²Œ ìƒì„±í•˜ê³  ë‚˜ë©´ `CONDITION`ì´ `Pending`ìœ¼ë¡œ ë³´ì´ê²Œ ëœë‹¤.

```bash
$ kubectl get certificatesigningrequest
NAME        AGE   SIGNERNAME                      REQUESTOR    REQUESTEDDURATION   CONDITION
vault.svc   62s   kubernetes.io/kubelet-serving   example      100d                Pending
```

ìµœì¢…ì ìœ¼ë¡œ approve ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì„œ `Approved,Issued` ìƒíƒœê°€ ë˜ë„ë¡ í•œë‹¤.

```bash
kubectl certificate approve vault.svc
```

ì´ì œ Certificateì™€ Kubernetes CA Certificateë¥¼ ë°›ëŠ”ë‹¤.

```bash
kubectl get csr vault.svc -o jsonpath='{.status.certificate}' | openssl base64 -d -A -out vault.crt
```

```bash
kubectl config view \
--raw \
--minify \
--flatten \
-o jsonpath='{.clusters[].cluster.certificate-authority-data}' \
| base64 -d > vault.ca
```

#### Cert Managerë¡œ Certificate ê´€ë¦¬

Cert Managerì™€ Trust Managerë¥¼ í†µí•´ì„œ Vaultì—ì„œ ì‚¬ìš©í•  ì¸ì¦ì„œë¥¼ ê´€ë¦¬í•  ìˆ˜ë„ ìˆë‹¤. Self Signed CAë¥¼ í†µí•´ì„œ ì…‹íŒ…ì„ í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ kubernetes manifestë¥¼ ì •ì˜í•´ì„œ ìƒì„±í•˜ë©´ ëœë‹¤.

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-cluster-issuer
  namespace: cert-manager
spec:
  selfSigned: {}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: root-ca
  namespace: cert-manager
spec:
  isCA: true
  commonName: 'Root CA'
  secretName: root-ca
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: selfsigned-cluster-issuer
    kind: ClusterIssuer
    group: cert-manager.io
---
apiVersion: trust.cert-manager.io/v1alpha1
kind: Bundle
metadata:
  name: trust-bundle
  namespace: cert-manager

spec:
  sources:
    - secret:
        name: 'root-ca'
        key: 'tls.crt'
  target:
    configMap:
      key: 'ca-trust-bundle.pem'
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: ca-issuer
  namespace: cert-manager
spec:
  ca:
    secretName: root-ca
```

vaultê°€ ì‚¬ìš©í•  ì¸ì¦ì„œë¥¼ ì•„ë˜ì™€ ê°™ì´ ìƒì„±í•˜ê³ , vault-tls Secretì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: vault-tls
  namespace: vault
spec:
  secretName: vault-tls
  duration: 17520h
  renewBefore: 8760h
  subject:
    organizations:
      - system:nodes
  commonName: system:node:*.vault.svc.cluster.local
  isCA: false
  privateKey:
    algorithm: RSA
    encoding: PKCS1
    size: 2048
  usages:
    - server auth
    - client auth
  dnsNames:
    - '*.vault-internal'
    - '*.vault-internal.vault.svc.cluster.local'
    - '*.vault'
    - '*.vault.svc.cluster.local'
    - '*.vault.svc'
  ipAddresses:
    - '127.0.0.1'
  issuerRef:
    name: ca-issuer
    kind: ClusterIssuer
    group: cert-manager.io
```

### Secretìœ¼ë¡œ ì¤€ë¹„

Kutomizeì™€ sealed-secretë¥¼ ì‚¬ìš©í•˜ì—¬ secretë¥¼ GitOps ë°©ì‹ìœ¼ë¡œ ì €ì¥í•œë‹¤.

`kustomization.yml`

```yaml
secretGenerator:
  - name: vault-ha-tls
    files:
      - vault.ca
      - vault.crt
      - vault.key
```

```bash
kustomize build > secret.yml
cat secret.yml| kubeseal --controller-namespace kube-system --controller-name sealed-secrets-controller --format yaml > sealed-secret.yml
```

namespaceë¥¼ ì¶”ê°€í•˜ê³ , sealed-secretìœ¼ë¡œ encryptionëœ yaml íŒŒì¼ë¡œ secret resourceë¥¼ ì¶”ê°€í•œë‹¤.

```bash
kubectl create namespace vault
kubectl ns vault
kubectl apply -f sealed-secret.yml
```

sealed-secretì—ì„œ decryptí•˜ì—¬ secret resourceê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•œë‹¤.

```bash
kubectl get secret
NAME                      TYPE     DATA   AGE
vault-ha-tls-ad6d57g7t2   Opaque   3      13s
```

### ArgoCDë¡œ ë°°í¬

[ArgoCD ë¬¸ì„œ](https://argo-cd.readthedocs.io/en/stable/user-guide/helm/)ì²˜ëŸ¼ Helm chartsë¥¼ í†µí•´ì„œ ArgoCD CRDë¥¼ ì •ì˜í•  ìˆ˜ ìˆë‹¤. Helmìœ¼ë¡œ ë°°í¬í•  ë•Œ `values`ì— overrideí•  ì„¤ì •ê°’ë“¤ì„ ì •ì˜í•  ìˆ˜ ìˆë‹¤. Vaultì˜ secretì„ templateìœ¼ë¡œ ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ volumeì— ì €ì¥í•  ìˆ˜ ìˆëŠ” `Vault agent injector`ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šì„ ê±°ë¼ `enabled`ì„ `false`ë¡œ ì§€ì •í–ˆë‹¤. High Avability Modeë¡œ ì„¤ì •ì„ í•˜ì˜€ê³ , 3ê°œ ì¤‘ì— í•˜ë‚˜ì˜ Nodeê°€ Active ìƒíƒœë¡œ ìˆê³ , ë‚˜ë¨¸ì§€ë“¤ì€ Stand By ìƒíƒœë¡œ ìˆê²Œ ëœë‹¤. Raft Protocolë¡œ ëª¨ë“  ë…¸ë“œë“¤ì— dataë¥¼ ì˜ replicationí•œë‹¤. Vaultì˜ UIë„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ NodePort typeìœ¼ë¡œ service resourceë¥¼ ìƒì„±í•˜ë„ë¡ í•˜ì˜€ë‹¤.

`argocd-vault.yml`

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: vault
  namespace: argocd
spec:
  project: default
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: vault
  source:
    chart: vault
    repoURL: https://helm.releases.hashicorp.com
    targetRevision: 0.27.0
    helm:
      releaseName: vault
      values: |
        global:
          enabled: true
          tlsDisable: false
        injector:
          enabled: false
          image:
            repository: "hashicorp/vault-k8s"
            tag: "1.3"
        server:
          standalone:
            enabled: false
          image:
            repository: "hashicorp/vault"
            tag: "1.15.2"
          resources:
            requests:
              memory: 1Gi
              cpu: 500m
            limit:
              memory: 2Gi
          affinity: null
          readinessProbe:
            enabled: true
            path: "/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204"
          livenessProbe:
            enabled: true
            path: "/v1/sys/health?standbyok=true"
            initialDelaySeconds: 60
          extraEnvironmentVars:
            VAULT_CACERT: /vault/userconfig/vault-ha-tls/vault.ca
            VAULT_TLSCERT: /vault/userconfig/vault-ha-tls/vault.crt
            VAULT_TLSKEY: /vault/userconfig/vault-ha-tls/vault.key
          volumes:
            - name: userconfig-vault-ha-tls
              secret:
                defaultMode: 420
                secretName: vault-ha-tls-ad6d57g7t2
          volumeMounts:
            - mountPath: /vault/userconfig/vault-ha-tls
              name: userconfig-vault-ha-tls
              readOnly: true
          auditStorage:
            enabled: true
          ha:
            enabled: true
            replicas: 3
            raft:
              enabled: true
              setNodeId: true

              config: |
                ui = true
                listener "tcp" {
                  tls_disable = 0
                  address = "[::]:8200"
                  cluster_address = "[::]:8201"
                  tls_cert_file = "/vault/userconfig/vault-ha-tls/vault.crt"
                  tls_key_file  = "/vault/userconfig/vault-ha-tls/vault.key"
                  tls_client_ca_file = "/vault/userconfig/vault-ha-tls/vault.ca"
                }

                storage "raft" {
                  path = "/vault/data"
                    retry_join {
                    leader_api_addr = "https://vault-0.vault-internal:8200"
                    leader_ca_cert_file = "/vault/userconfig/vault-ha-tls/vault.ca"
                    leader_client_cert_file = "/vault/userconfig/vault-ha-tls/vault.crt"
                    leader_client_key_file = "/vault/userconfig/vault-ha-tls/vault.key"
                  }
                  retry_join {
                    leader_api_addr = "https://vault-1.vault-internal:8200"
                    leader_ca_cert_file = "/vault/userconfig/vault-ha-tls/vault.ca"
                    leader_client_cert_file = "/vault/userconfig/vault-ha-tls/vault.crt"
                    leader_client_key_file = "/vault/userconfig/vault-ha-tls/vault.key"
                  }
                  retry_join {
                    leader_api_addr = "https://vault-2.vault-internal:8200"
                    leader_ca_cert_file = "/vault/userconfig/vault-ha-tls/vault.ca"
                    leader_client_cert_file = "/vault/userconfig/vault-ha-tls/vault.crt"
                    leader_client_key_file = "/vault/userconfig/vault-ha-tls/vault.key"
                  }
                }
                service_registration "kubernetes" {}
        ui:
          enabled: true
          serviceType: "NodePort"
          externalPort: 8200
```

ArgoCDì˜ `Application` CRD ì„¤ì •ì—ì„œ source ë¶€ë¶„ì€ ì•„ë˜ì™€ ê°™ì´ í•˜ë©´ ëœë‹¤. helm commandë¡œ repoë¥¼ ì¶”ê°€í•  ë•Œ URLì´ `repoURL`ì— ì„¤ì •ì´ ë˜ì–´ì•¼ í•œë‹¤.

```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
```

ê·¸ë¦¬ê³  `targetRevision`ì€ `CHART VERSION`ì„ ì„¤ì •í•˜ë©´ ë˜ê³ , chartëŠ” chartì´ë¦„ì„ ì¶”ê°€í•˜ë©´ ëœë‹¤.

```bash
$ helm search repo
NAME             CHART VERSION   APP VERSION   DESCRIPTION
hashicorp/vault  0.27.0          1.15.2        Official HashiCorp Vault Chart
```

ë§ˆì§€ë§‰ìœ¼ë¡œ `releaseName`ì€ helm install ëª…ë ¹ì–´ë¥¼ ì“¸ ë•Œ ì‚¬ìš©í•˜ëŠ” ì´ë¦„ì„ ì„¤ì •í•˜ë©´ ëœë‹¤.

```bash
helm install vault hashcorp/vault
```

ê·¸ë ‡ê²Œ ë°˜ì˜ì„ í•˜ë©´ vaultì˜ ê²½ìš° ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•  ìˆ˜ê°€ ìˆë‹¤.

```yaml
source:
  chart: vault
  repoURL: https://helm.releases.hashicorp.com
  targetRevision: 0.27.0
  helm:
    releaseName: vault
```

ì´ì œ ArgoCD CRDë¥¼ ë°°í¬í•˜ê³ , argocd applicationë¥¼ Syncí•œë‹¤.

```bash
kubectl apply -f argocd-vault.yml
argocd app sync vault
```

### Vault init & unseal

ì´ì œ StatefulSetìœ¼ë¡œ ì•„ë˜ì²˜ëŸ¼ podê°€ ì •ìƒì ìœ¼ë¡œ ì˜ ëœ¬ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```bash
$ kubectl get pod
NAME      READY   STATUS    RESTARTS   AGE
vault-0   1/1     Running   0          57s
vault-1   1/1     Running   0          57s
vault-2   1/1     Running   0          57s
```

ì´ì œ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ê¸° ìœ„í•´ì„œ initì„ í•´ì¤˜ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  ì´ë ‡ê²Œ initì„ í•˜ë©´ root keyë¥¼ ìƒì„±í•˜ê²Œ ë˜ëŠ”ë°, ì˜ˆì œì—ì„œëŠ” í¸ì˜ë¥¼ ìœ„í•´ì„œ `-key-shares=1`ë¡œ í•˜ì—¬ í•˜ë‚˜ë§Œ ë°œê¸‰í•˜ê²Œ í•œë‹¤. ì‹¤ì œë¡œ ìš´ì˜í•  ë•ŒëŠ” ë³µìˆ˜ì˜ keyë¥¼ ë¶„ë¦¬í•˜ê³  `-key-threshold` ê°¯ìˆ˜ë§Œí¼ keyë¡œ unsealì„ í•˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ ê°’ìœ¼ë¡œ unsealê¹Œì§€ ì™„ë£Œí•œë‹¤.

```bash
kubectl exec vault-0 -- vault operator init -key-shares=1 -key-threshold=1 -format=json > cluster-keys-0.json
kubectl exec vault-0 -- vault operator unseal {unseal_keys_b64 ê°’}
```

`etc/resolve.conf`ì—ëŠ” ì´ë ‡ê²Œ ì‘ì„±ì´ ë˜ì–´ ìˆê³ , `vault-0.vault-internal`ë¡œë§Œ DNS lookupì„ í•˜ë”ë¼ë„ í•´ë‹¹ podì˜ IPë¥¼ resolveí•  ìˆ˜ ìˆë‹¤.

```bash
$ cat /etc/resolv.conf
search vault.svc.cluster.local svc.cluster.local cluster.local
nameserver 169.254.25.10
options ndots:5
```

Raftë¡œ ì´ì œ Standby nodeê°€ cluster joiní•  ë•Œ, `https://vault-0.vault-internal:8200`ë¡œ URLë¥¼ ì •ì˜í–ˆë‹¤. ê·¸ëŸ°ë° ì´ìƒí•˜ê²Œ ì•„ë˜ì™€ ê°™ì´ ì „ì²´ Domainì„ lookupí•  ë•ŒëŠ” ì •ìƒì ìœ¼ë¡œ ë˜ì—ˆì§€ë§Œ,

```bash
$ kubectl exec -it vault-0 -- nslookup vault-0.vault-internal.vault.svc.cluster.local
Server:         169.254.25.10
Address:        169.254.25.10:53


Name:   vault-0.vault-internal.vault.svc.cluster.local
Address: 198.18.9.169
```

ì•„ë˜ì™€ ê°™ì´ ì¤„ì—¬ì„œ í•  ë•ŒëŠ” ë˜ì§€ ì•Šì•˜ë‹¤.

```bash
$ kubectl exec -it vault-0 -- nslookup vault-0.vault-internal.vault
Server:         169.254.25.10
Address:        169.254.25.10:53

** server can't find vault-0.vault-internal.vault: NXDOMAIN

** server can't find vault-0.vault-internal.vault: NXDOMAIN
```

CoreDnsì˜ ConfigMapì—ì„œ logë¥¼ ì¶”ê°€í–ˆê³ , ì—¬ê¸°ì— ë¡œê·¸ê°€ ë‚¨ì§€ê°€ ì•Šì•˜ë‹¤. ì•„ë˜ì²˜ëŸ¼ dnsutilsê°€ ìˆëŠ” podë¥¼ ì‹¤í–‰í•´ì„œ lookupì„ í•´ë³´ë‹ˆ ì •ìƒì ìœ¼ë¡œ ë˜ì—ˆë‹¤.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: dnsutils
  namespace: vault
spec:
  containers:
    - name: dnsutils
      image: registry.k8s.io/e2e-test-images/jessie-dnsutils:1.3
      command:
        - sleep
        - 'infinity'
      imagePullPolicy: IfNotPresent
  restartPolicy: Always
```

```bash
kubectl exec -it dnsutils -- nslookup vault-0.vault-internal.vault
Server:         169.254.25.10
Address:        169.254.25.10#53

Name:   vault-0.vault-internal.vault.svc.cluster.local
Address: 198.18.9.169
```

ì™œ Vault podì—ì„œëŠ” ì •ìƒì ìœ¼ë¡œ ë˜ëŠ”ì§€ íŒŒì•…í•  ìˆ˜ ì—†ì—ˆê³ , ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •ì„ í•˜ì˜€ë‹¤.

```bash
storage "raft" {
  path = "/vault/data"
    retry_join {
    leader_api_addr = "https://vault-0.vault-internal.vault.svc.cluster.local:8200"
    leader_ca_cert_file = "/vault/userconfig/vault-ha-tls/vault.ca"
    leader_client_cert_file = "/vault/userconfig/vault-ha-tls/vault.crt"
    leader_client_key_file = "/vault/userconfig/vault-ha-tls/vault.key"
  }
  retry_join {
    leader_api_addr = "https://vault-1.vault-internal.vault.svc.cluster.local:8200"
    leader_ca_cert_file = "/vault/userconfig/vault-ha-tls/vault.ca"
    leader_client_cert_file = "/vault/userconfig/vault-ha-tls/vault.crt"
    leader_client_key_file = "/vault/userconfig/vault-ha-tls/vault.key"
  }
  retry_join {
    leader_api_addr = "https://vault-2.vault-internal.vault.svc.cluster.local:8200"
    leader_ca_cert_file = "/vault/userconfig/vault-ha-tls/vault.ca"
    leader_client_cert_file = "/vault/userconfig/vault-ha-tls/vault.crt"
    leader_client_key_file = "/vault/userconfig/vault-ha-tls/vault.key"
  }
}
```

ì´ì œ vault-1ê³¼ vault-2ì—ì„œë„ unsealì„ í•´ì£¼ê³ , raftì— join í•œ ê²ƒë„ í™•ì¸ì„ í•œë‹¤.

```bash
kubectl exec vault-1 -- vault operator unseal {unseal_keys_b64 ê°’}
kubectl exec vault-2 -- vault operator unseal {unseal_keys_b64 ê°’}
```

```bash
$ vault operator raft list-peers
Node       Address                        State       Voter
----       -------                        -----       -----
vault-0    vault-0.vault-internal:8201    leader      true
vault-1    vault-1.vault-internal:8201    follower    true
vault-2    vault-2.vault-internal:8201    follower    true
```

### vault auth, engine, policy, role ì„¤ì •

ì´ì œ vaultê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ì´ ë˜ì—ˆìœ¼ë‹ˆ, ì˜ˆì œì²˜ëŸ¼ vaultì— í•„ìš”í•œ ê²ƒë“¤ì„ ì„¤ì •í•œë‹¤.

```bash
vault auth enable -path dev-auth-mount kubernetes
vault write auth/dev-auth-mount/config kubernetes_host="https://kubernetes.default.svc"
vault secrets enable -path=dev kv-v2
```

```bash
vault policy write dev - <<EOF
path "dev/*" {
   capabilities = ["read"]
}
EOF
```

```
vault write auth/dev-auth-mount/role/dev \
   bound_service_account_names=default \
   bound_service_account_namespaces=dev \
   policies=dev \
   audience=vault \
   ttl=24h
```

```bash
vault kv put dev/webapp/config username="static-user" password="static-password"
```

## vault secrets operator

ì´ì œ CRDë¡œ ê´€ë¦¬í•˜ê³ , vaultì˜ secretì„ Kubernetes secretìœ¼ë¡œ syncí•´ì£¼ëŠ” vault-secrets-operatorë¥¼ ì„¤ì¹˜í•œë‹¤. ë¨¼ì € ca.crtê°€ Secretì— ìˆì–´ì•¼ ë˜ì„œ ë™ì¼í•˜ê²Œ Kustomizeë¡œ Secret Manifestë¥¼ ìƒì„±í•˜ê³ , sealed-secretìœ¼ë¡œ ë°°í¬í•œë‹¤.

`kustomization.yml`

```yaml
secretGenerator:
  - name: vault-ca
    files:
      - ca.crt=vault.ca
```

```bash
kubectl create namespace vault-secrets-operator
kubectl ns vault-secrets-operator
cat secret-ca.yml| kubeseal --controller-namespace kube-system --controller-name sealed-secrets-controller --format yaml > sealed-secret-ca.yml
kubectl apply -f sealed-secret-ca.yml
```

ê·¸ë¦¬ê³  ArgoCD Application resourceë¥¼ ìƒì„±í•œë‹¤.

`argocd-vault-secrets-operator.yml`

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: vault-secrets-operator
  namespace: argocd
spec:
  project: default
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: vault-secrets-operator
  source:
    chart: vault-secrets-operator
    repoURL: https://helm.releases.hashicorp.com
    targetRevision: 0.4.2
    helm:
      releaseName: vault-secrets-operator
      values: |
        defaultVaultConnection:
          enabled: true
          address: "https://vault.vault.svc.cluster.local:8200"
          skipTLSVerify: false
          caCertSecret: vault-ca-a2dh3972mm
```

```bash
kubectl apply -f argocd-vault-secrets-operator.yml
```

ArgoCDë¡œ syncë¥¼ ë§ì¶°ì„œ ì •ìƒì ìœ¼ë¡œ resourceë“¤ì´ ë°°í¬ëœ ê²ƒì„ í™•ì¸í•œë‹¤.

### vault secrets operator test

ì´ì œ vault secrets operatorê°€ ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìœ¼ë‹ˆ, CRDë¥¼ ìƒì„±í•˜ì—¬ namespace devì—ì„œ vault secretì— ë”°ë¼ì„œ Kubernetes secretì´ ìƒì„±ë˜ëŠ” ê²ƒì„ í™•ì¸í•´ë³¸ë‹¤.

ìœ„ì—ì„œ vaultì— ë‹¤ìŒê³¼ ê°™ì´ ì¶”ê°€í•˜ì˜€ë‹¤.

- kubernetes auth: dev-auth-mount
- role: dev
- kv-v2: dev/webapp/config

`example-auth.yml`

```yaml
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: static-auth
  namespace: dev
spec:
  method: kubernetes
  mount: dev-auth-mount
  kubernetes:
    role: dev
    serviceAccount: default
    audiences:
      - vault
```

`example-secret.yml`

```yaml
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: vault-kv-app
  namespace: dev
spec:
  type: kv-v2

  mount: dev

  path: webapp/config

  destination:
    name: dev-secret
    create: true

  refreshAfter: 30s

  vaultAuthRef: static-auth
```

```bash
kubectl apply -f example-auth.yml
kubectl apply -f example-secret.yml
```

ì´ì œ Kubernetes namespace devì— `devSecret` Secret resourceê°€ ìƒì„±ëœë‹¤.

```bash
$ kubectl get secret -n dev
NAME              TYPE                             DATA   AGE
dev-secret        Opaque                           3      3s
```

ì´ì œ secretì´ ë³€ê²½ë˜ë©´ ìë™ìœ¼ë¡œ Deploymentì˜ podë¥¼ Rolling Updateí•  ìˆ˜ ìˆë„ë¡, [Reloader](https://github.com/stakater/Reloader)ì„ helmìœ¼ë¡œ ì„¤ì¹˜í•œë‹¤.

`argocd-reloader.yml`

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: reloader
  namespace: argocd
spec:
  project: default
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: reloader
  source:
    chart: reloader
    repoURL: https://stakater.github.io/stakater-charts
    targetRevision: 1.0.56
    helm:
      releaseName: reloader
```

ë™ì¼í•˜ê²Œ ArgoCDë¡œ ë°°í¬ë¥¼ í•˜ê³ , ê·¸ëƒ¥ secretìœ¼ë¡œë¶€í„° ê°’ì„ stdoutìœ¼ë¡œ ë‚¨ê¸°ëŠ” Podë¥¼ ìƒì„±í•˜ëŠ” Deployment Resourceë¥¼ ë°°í¬í•œë‹¤. ì´ë•Œ annotationì„ í†µí•´ì„œ ì„¤ì¹˜í•œ reloaderê°€ ë³€ê²½ëœ secretë¥¼ watchí•˜ê³  rolling updateë¥¼ í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ubuntu
  annotations:
    reloader.stakater.com/auto: 'true'
  namespace: dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ubuntu
  template:
    metadata:
      labels:
        app: ubuntu
    spec:
      containers:
        - name: ubuntu
          image: ubuntu:latest
          # Just spin & wait forever
          command: ['/bin/bash', '-c', '--']
          args: ['while true; echo ${username}; do sleep 30; done;']
          envFrom:
            - secretRef:
                name: dev-secret
```

ë°°í¬í•˜ê³  ë‚˜ì„œ logë¥¼ í™•ì¸í•˜ë©´ `dev-secret`ì— ìˆëŠ” username ê°’ì´ ì°íˆëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```
$ kubectl logs -f --selector app=ubuntu
static-user
```

ì´ì œ vaultì—ì„œ secretê°’ì„ ë³€ê²½í•˜ë©´, rolling updateê°€ ë˜ê³  static-user3ê°€ logë¡œ ë‚¨ëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```bash
vault kv put dev/webapp/config username="static-user3" password="static-password"
```

## ê²°ë¡ 

GitOpsë¡œ Kubernetes manifest fileë¥¼ ê´€ë¦¬í•˜ëŠ” ìƒí™©ì—ì„œ Secretì€ ì–´ë–»ê²Œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ì„ê¹Œ ê³ ë¯¼ì„ í–ˆì—ˆë‹¤. ì˜ˆì „ë¶€í„° Vaultë¥¼ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•´ì™”ê³ , Kubernetesì—ì„œ vaultë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì˜µì…˜ë“¤ì„ í™•ì¸í•´ë³´ì•˜ë‹¤. ê·¸ì¤‘ì—ì„œ Vault secrets operatorê°€ ê°€ì¥ ì í•©í•˜ë‹¤ê³  íŒë‹¨í•˜ì—¬, ArgoCD, Kustomize, sealed-secret ë“±ì„ ì‚¬ìš©í•˜ì—¬ ì…‹íŒ…ì„ í•´ë³´ì•˜ë‹¤. Hashicorp ë§Œì„¸! ğŸ‘ğŸ‘
