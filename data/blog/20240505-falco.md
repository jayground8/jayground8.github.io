---
title: 'Falcoë¥¼ í™œìš©í•˜ì—¬ Terminal Shell ëª…ë ¹ì–´ ë¡œê·¸ ìˆ˜ì§‘í•˜ê¸°'
date: '2024-05-04'
tags: ['kubernetes', 'falco', 'devsecops']
images: ['/static/images/social-banner.png']
summary: 'Kubernetes Worker Nodeì™€ Pod Containerì— Terminal shellë¡œ ì ‘ê·¼í•˜ì—¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ë©´ ë¡œê·¸ë¥¼ ë‚¨ê¸°ê³ , ê²½ìš°ì— ë”°ë¼ì„œ ì•Œë¦¼ì„ ë³´ë‚´ê³  ì‹¶ì—ˆë‹¤. CNCF ì¡¸ì—…í•œ Projectì¸ Falcoë¥¼ í™œìš©í•˜ë©´ ì´ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ê²Œ ë˜ì—ˆë‹¤. FalcoëŠ” kernel moduleì´ë‚˜ eBPF probeë“±ì„ í†µí•´ì„œ kernel eventë¥¼ ì €ì¥í•˜ê³ , ì„¤ì •ëœ ruleì— ë”°ë¼ì„œ í•´ë‹¹ eventë¥¼ filterí•˜ì—¬ ì›í•˜ëŠ” output í˜•íƒœë¡œ ì €ì¥í•œë‹¤. FalcoëŠ” ëª¨ë“  ë¡œê·¸ë¥¼ ì €ì¥í•˜ê¸°ë³´ë‹¤ëŠ” Ruleì— ë”°ë¼ ì„ íƒì ìœ¼ë¡œ ë³´ì•ˆ ìœ„í˜‘ì´ ìˆëŠ” ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì§‘í•˜ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ì•Œë¦¼í•˜ëŠ” ê²ƒì´ ëª©ì ì´ë‹¤. ë”°ë¼ì„œ Falcoë¥¼ í†µí•´ì„œ ì›í•˜ë˜ êµ¬í˜„ì„ í•˜ëŠ” ê²ƒì€ í•©ë¦¬ì ì¸ ë°©ë²•ì´ ì•„ë‹Œ ê²ƒìœ¼ë¡œ íŒë‹¨ëœë‹¤.'
---

Kubernetesì—ì„œ Worker Nodeë‚˜ Podì— Shellë¡œ ì ‘ê·¼í•˜ë©´ ê¸°ë¡ì„ ë‚¨ê¸°ê³ , ì›í•˜ëŠ” ê²½ìš°ì—ëŠ” ì•Œë¦¼ì„ ë°›ê³  ì‹¶ì—ˆë‹¤. ê·¸ë˜ì„œ [CNCF ì¡¸ì—…í•œ í”„ë¡œì íŠ¸ì¸ Falco](https://falco.org/)ë¥¼ í†µí•´ì„œ ì›í•˜ëŠ” ì‹œìŠ¤í…œì„ ë§Œë“¤ ìˆ˜ ìˆì„ì§€ í™•ì¸í•´ë³´ì•˜ë‹¤. [Falco Architectureê°€ ë¬¸ì„œ](https://falco.org/docs/getting-started/)ì— ì•„ë˜ ê·¸ë¦¼ê³¼ í•¨ê»˜ ì¹œì ˆíˆ ì„¤ëª…ë˜ì–´ ìˆë‹¤.

> Falco operates in both kernel and user space. In kernel space, Linux system calls (syscalls) are collected by a driver, for example, the Falco kernel module or Falco eBPF probe. Next, syscalls are placed in a ring buffer from which they are moved into user space for processing. The events are filtered using a rules engine with a Falco rule set.

<img src="/static/images/falco-architecture-v2.png" alt="Falco architecture" />

FalcoëŠ” Ruleì„ í†µí•´ì„œ ì„ íƒì ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ì €ì¥í•˜ëŠ” êµ¬ì¡°ë¡œ ë˜ì–´ ìˆë‹¤. ì •ì˜ëœ Falco Ruleë¡œ filterëœ ì´ë²¤íŠ¸ë¥¼ Standard Output, File Output, Syslog Output, Program Output, HTTP/HTTPS Output, JSON Outputë“±ì„ í†µí•´ì„œ ì›í•˜ëŠ” Output í˜•ì‹ì„ ì •ì˜í•  ìˆ˜ ìˆë‹¤. [Syslog Outputì˜ ê²½ìš°ì—ëŠ” Falcoë¥¼ Hostì— ì§ì ‘ ì„¤ì¹˜í•˜ì˜€ì„ ë•Œ, Syslog Serviceë¥¼ í†µí•´ì„œ ë‚¨ê¸°ëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.](https://github.com/falcosecurity/falco/issues/1983#issuecomment-1126171645). Kubernetesì—ì„œ Podë¡œ Falcoë¥¼ ì‹¤í–‰í•  ë•ŒëŠ” Standard Outputì„ ì‚¬ìš©í•˜ê³ , Fluentbitì´ë‚˜ Opentelemetry Filelog Receiverë“±ìœ¼ë¡œ fileì„ tailí•´ì„œ ì €ì¥í•  ìˆ˜ ìˆë‹¤.

ë˜í•œ [Falcosidekickì„ í†µí•´ì„œ Forwarding](https://falco.org/docs/outputs/forwarding/)ì„ í†µí•´ì„œ ì›í•˜ëŠ” ê³³ì— Falco Alertë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆë‹¤. ì•„ë˜ëŠ” ê³µì‹ë¬¸ì„œì— ìˆëŠ” ê·¸ë¦¼ìœ¼ë¡œ Falcosidekickì„ í†µí•´ì„œ í¸í•˜ê²Œ ë‹¤ì–‘í•œ ì‹œìŠ¤í…œì— ì „ë‹¬í•  ìˆ˜ ìˆë‹¤. Lokiì— pushí•˜ì—¬ logë¥¼ ì €ì¥í•  ìˆ˜ë„ ìˆê³ , Slackì— ë©”ì„¸ì§€ë¥¼ ë³´ë‚¼ ìˆ˜ë„ ìˆë‹¤. ì´ ë°©ë²•ì€ Falco HTTP/HTTPS Outputì„ í†µí•´ì„œ Falcosidekickì—ê²Œ Alertë¥¼ ì „ì†¡í•˜ëŠ” ê²ƒì´ë‹¤.

<img src="/static/images/falcosidekick_forwarding.png" alt="falcosidekick forwarding" />

## Helmìœ¼ë¡œ ì„¤ì¹˜

Helm Chartë¥¼ ì´ìš©í•˜ì—¬ Falcoë¥¼ ì„¤ì¹˜í•œë‹¤.

```bash
helm repo add falcosecurity https://falcosecurity.github.io/charts
helm repo update
```

```bash
$ helm search repo falcosecurity
NAME                            CHART VERSION   APP VERSION
falcosecurity/event-generator   0.3.3           0.10.0
falcosecurity/falco             4.3.0           0.37.1
falcosecurity/falco-exporter    0.10.0          0.8.3
falcosecurity/falcosidekick     0.7.17          2.28.0
falcosecurity/k8s-metacollector 0.1.7           0.1.0
```

Kernel moduleëŒ€ì‹ ì— performanceì ìœ¼ë¡œ ìœ ë¦¬í•œ ebpfë¥¼ ì‚¬ìš©í•´ì„œ syscallì„ probeí•˜ë„ë¡ í•œë‹¤. ê·¸ë¦¬ê³  falcosidekickì„ ê°™ì´ ì„¤ì¹˜í•˜ê¸° ìœ„í•´ì„œ enabledì„ trueë¡œ ì„¤ì •í•´ì£¼ê³ , lokiì™€ slackì— Falco alertë¥¼ ì „ë‹¬í•˜ë„ë¡ ì„¤ì •í•˜ì˜€ë‹¤. Falcoì—ì„œëŠ” EMERGENCY, ALERT, CRITICAL, ERROR, WARNING, NOTICE, INFORMATIONAL, DEBUG ìˆœìœ¼ë¡œ ìš°ì„ ìˆœìœ„ ì •ë³´ë¥¼ ì •ì˜í•  ìˆ˜ ìˆë‹¤. `minimumpriority`ë¥¼ í†µí•´ì„œ ì–´ëŠ ìš°ì„ ìˆœìœ„ê¹Œì§€ ë³´ë‚¼ê²ƒì¸ì§€ ì •ì˜ë¥¼ í•  ìˆ˜ ìˆëŠ”ë°, ì•„ë˜ì—ì„œëŠ” `alert`ë¡œ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì— EMERGENCYì™€ ALERTì— ëŒ€í•´ì„œ ë©”ì„¸ì§€ë¥¼ ì „ë‹¬ë°›ê²Œ ëœë‹¤. falcosidekickì˜ slack ì„¤ì •ì€ [ì´ ë¬¸ì„œ](https://github.com/falcosecurity/falcosidekick/blob/master/docs/outputs/slack.md)ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.

`values.yaml`

```yaml
driver:
  kind: ebpf
falcosidekick:
  enabled: true
  config:
    loki:
      hostport: http://loki:3100
      tenant: falco
    slack:
      webhookurl: https://hooks.slack.com/services/{something}
      minimumpriority: alert
			outputformat: fields
```

Helm Chartì˜ valueëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì´ stdout_outputì´ enableë˜ì–´ ìˆë‹¤. ë”°ë¼ì„œ Daemonsetìœ¼ë¡œ ì„¤ì¹˜ë˜ëŠ” Falcoì˜ container logë¥¼ ë³´ë©´ Falco ruleì— ë”°ë¥¸ eventë“¤ì´ ë‚¨ì•„ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```yaml
stdout_output:
	enabled: true
```

ì •ì˜í•œ `values.yaml`ì„ í†µí•´ì„œ Helm Chartë¥¼ ë°°í¬í•œë‹¤.

```bash
helm install falco falcosecurity/falco \
--create-namespace \
--namespace falco \
--values values.yaml
```

ì„¤ì¹˜ê³¼ ì™„ë£Œë˜ë©´ ì•„ë˜ì™€ ê°™ì´ falcoì˜ ì„¤ì •ê°’ë“¤ì´ ConfigMapì— ì •ì˜ëœë‹¤.

```bash
$ kubectl get cm -n falco
NAME               DATA   AGE
falco              1      1d
falco-falcoctl     1      1d
falco-rules        1      1d
```

`kubectl get cm falco -o yaml`ìœ¼ë¡œ í™•ì¸í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ json í˜•ì‹ì˜ outputì´ ì„¤ì •ë˜ê²Œ ëœë‹¤. ê·¸ë¦¬ê³  falco-facosidekick ClusterIP ì„œë¹„ìŠ¤ë¡œ ìš”ì²­í•˜ë„ë¡ http_outputì´ ì„¤ì •ë˜ê³ , stdout_outputë„ ë™ì¼í•˜ê²Œ trueë¡œ ì„¤ì •ëœë‹¤.

```yaml
json_output: true
http_output:
	ca_bundle: ""
	ca_cert: ""
	ca_path: /etc/falco/certs/
	client_cert: /etc/falco/certs/client/client.crt
	client_key: /etc/falco/certs/client/client.key
	compress_uploads: false
	echo: false
	enabled: true
	insecure: false
	keep_alive: false
	mtls: false
	url: http://falco-falcosidekick:2801
	user_agent: falcosecurity/falco
stdout_output:
	enabled: true
```

## Falco Rule

Falco rulesì„ ê¸°ë³¸ì ìœ¼ë¡œ `stable` ìƒíƒœì— ìˆëŠ” ruleë“¤ ìë™ìœ¼ë¡œ ì„¤ì •ì´ ëœë‹¤. [Communityì—ì„œ ê´€ë¦¬ë˜ëŠ” ruleë“¤ì€ ì—¬ê¸°](https://falco.org/docs/reference/rules/default-rules/)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. `incubating`, `sandbox` ìƒíƒœì˜ ruleë„ ì¶”ê°€í•˜ê³  ì‹¶ìœ¼ë©´ Helm Chart Valueì— ì •ì˜í•˜ì—¬ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

stable ìƒíƒœì˜ ruleë“¤ì€ [Github Repoì˜ falco_rules.yaml](https://github.com/falcosecurity/rules/blob/main/rules/falco_rules.yaml)ì—ì„œë„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ì„œ `falco_rules.yaml`ì—ì„œ ì•„ë˜ì™€ ê°™ì€ Ruleì´ ì •ì˜ë˜ì–´ ìˆë‹¤. `macro`ëŠ” ë‹¤ì‹œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ íŠ¹ì •í•œ ì¡°ê±´ë“¤ì„ ì •ì˜í•´ ë†“ëŠ” ê²ƒì´ê³ , `list`ë¥¼ í†µí•´ì„œ ì—¬ëŸ¬ ê°œì˜ ê°’ì„ ë¬¶ì–´ì„œ ì •ì˜í•  ìˆ˜ ìˆë‹¤. `Terminal shell in container`ì—ì„œ `macro`ì™€ `list`ë¥¼ ì‚¬ìš©í•´ì„œ ì •ì˜í•˜ê³  ìˆë‹¤.

```yaml
- macro: spawned_process
  condition: (evt.type in (execve, execveat) and evt.dir=<)

- macro: container
  condition: (container.id != host)

- macro: container_entrypoint
  condition: (not proc.pname exists or proc.pname in (runc:[0:PARENT], runc:[1:CHILD], runc, docker-runc, exe, docker-runc-cur, containerd-shim, systemd, crio))

- macro: user_expected_terminal_shell_in_container_conditions
  condition: (never_true)

- list: shell_binaries
  items: [ash, bash, csh, ksh, sh, tcsh, zsh, dash]

- macro: shell_procs
  condition: (proc.name in (shell_binaries))

- rule: Terminal shell in container
  desc: >
    A shell was used as the entrypoint/exec point into a container with an attached terminal. Parent process may have 
    legitimately already exited and be null (read container_entrypoint macro). Common when using "kubectl exec" in Kubernetes. 
    Correlate with k8saudit exec logs if possible to find user or serviceaccount token used (fuzzy correlation by namespace and pod name). 
    Rather than considering it a standalone rule, it may be best used as generic auditing rule while examining other triggered 
    rules in this container/tty.
  condition: >
    spawned_process 
    and container
    and shell_procs 
    and proc.tty != 0
    and container_entrypoint
    and not user_expected_terminal_shell_in_container_conditions
  output: A shell was spawned in a container with an attached terminal (evt_type=%evt.type user=%user.name user_uid=%user.uid user_loginuid=%user.loginuid process=%proc.name proc_exepath=%proc.exepath parent=%proc.pname command=%proc.cmdline terminal=%proc.tty exe_flags=%evt.arg.flags %container.info)
  priority: NOTICE
  tags: [maturity_stable, container, shell, mitre_execution, T1059]
```

ì´ì œ Podì— ì ‘ê·¼í•˜ë©´

```bash
kubectl exec -it nginx-pod -- /bin/sh
```

ì•„ë˜ì™€ ê°™ì€ logê°€ ë‚¨ê²Œ ëœë‹¤.

```json
{
  "hostname": "node-name",
  "output": "10:31:35.913486795: Notice A shell was spawned in a container with an attached terminal (evt_type=execve user=root user_uid=0 user_loginuid=-1 process=sh proc_exepath=/usr/bin/dash parent=containerd-shim command=sh terminal=34816 exe_flags=EXE_WRITABLE container_id=6fec6323ae4c container_image=docker.io/library/nginx container_image_tag=latest container_name=nginx k8s_ns=default k8s_pod_name=pod-name)",
  "priority": "Notice",
  "rule": "Terminal shell in container",
  "source": "syscall",
  "tags": ["T1059", "container", "maturity_stable", "mitre_execution", "shell"],
  "time": "2024-05-03T10:31:35.913486795Z",
  "output_fields": {
    "container.id": "6fec6323ae4c",
    "container.image.repository": "docker.io/library/nginx",
    "container.image.tag": "latest",
    "container.name": "nginx",
    "evt.arg.flags": "EXE_WRITABLE",
    "evt.time": 1714732295913486795,
    "evt.type": "execve",
    "k8s.ns.name": "default",
    "k8s.pod.name": "pod-name",
    "proc.cmdline": "sh",
    "proc.exepath": "/usr/bin/dash",
    "proc.name": "sh",
    "proc.pname": "containerd-shim",
    "proc.tty": 34816,
    "user.loginuid": -1,
    "user.name": "root",
    "user.uid": 0
  }
}
```

í…ŒìŠ¤íŠ¸ë¥¼ í•œ í™˜ê²½ì˜ Container Runtimeì´ containerdì´ê¸° ë•Œë¬¸ì—, parent processëª…ì€ `containerd-shim`ìœ¼ë¡œ í‘œì‹œê°€ ëœë‹¤. `evt.type`ëŠ” syscall eventì„ ê°€ì§€ëŠ”ë°, [ê³µì‹ë¬¸ì„œì˜ ì§€ì›í•˜ëŠ” events ì¢…ë¥˜](https://falco.org/docs/reference/rules/supported-events/)ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. [execveëŠ” í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•  ë•Œì˜ syscall](https://man7.org/linux/man-pages/man2/execve.2.html)ì¸ë°, `/usr/bin/dash` binary fileì´ ì‹¤í–‰ë˜ì—ˆê¸° ë•Œë¬¸ì— evt.typeì€ `execve`ê°€ ë˜ê³  proc.exepathê°€ `usr/bin/dah`ê°€ ëœë‹¤. ê·¸ë¦¬ê³  ì•„ë˜ì²˜ëŸ¼ ë¬¸ì„œì— syscallì´ ë¶ˆë ¸ì„ ë•Œ `>`, ëë‚¬ì„ ë•Œ `<`ë¡œ í‘œì‹œí•˜ê²Œ ëœë‹¤. `>`ëŠ” filepathë¡œ ì‹¤í–‰í•˜ê³ , `<`ëŠ” systemcallì´ ëë‚˜ê³  ê¸°íƒ€ ì •ë³´ë“¤ì„ ë°˜í™˜í•œë‹¤.

<img src="/static/images/falco-execve.png" alt="falco execve event" />

## Custom Rule

ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ” Ruleì„ ì‚´í´ë³´ì•˜ê³ , `marcro`, `list`, `rule` Syntaxë¡œ ì›í•˜ëŠ” custom ruleì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤. accept, listenì€ `<` ì—ì„œ fd paramsì„ ê°€ì§€ê³ , recvfrom, recvmsgëŠ” `>`ì—ì„œ fd paramsë¥¼ ê°€ì§€ê³  ìˆë‹¤. (dirì„ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜í•˜ì§€ ì•Šìœ¼ë©´ `>`ê°€ defaultë¡œ ë˜ëŠ” ê²ƒ ê°™ë‹¤.) ì´ì œ params `fd`ë¥¼ í†µí•´ì„œ `fd.sport` Server Portê°€ 22ì¸ì§€ í™•ì¸í•œë‹¤. ì´ ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ outputìœ¼ë¡œ `fd.cip` client IP addressì™€ `fd.cport` client Port ê°’ì„ ë‚¨ê¸°ë„ë¡ í•˜ì˜€ë‹¤.

`custom-rules.yaml`

```yaml
customRules:
  rules-ssh.yaml: |-
    - list: ssh_standard_ports
      items: [22]
    - macro: ssh_standard_ports_network
      condition: (fd.sport in (ssh_standard_ports))
    - rule: Inbound SSH Connection
      desc: Detect Inbound SSH Connection
      condition: >
        ((evt.type in (accept,listen) and evt.dir=<) or
          (evt.type in (recvfrom,recvmsg))) and ssh_standard_ports_network
      output: >
        Inbound SSH connection (user=%user.name client_ip=%fd.cip client_port=%fd.cport server_ip=%fd.sip)
      priority: ALERT
      tags: [network]
```

ì •ì˜í•œ costom ruleì„ ì•„ë˜ì™€ ê°™ì´ ì ìš©í•œë‹¤.

```bash
helm upgrade falco falcosecurity/falco \
-f ./custom-rules.yaml \
--namespace falco \
--values values.yaml
```

custom ruleì— ì˜í•´ì„œ ì•„ë˜ì™€ ê°™ì´ logê°€ ë‚¨ëŠ”ë‹¤. ê·¸ë¦¬ê³  `container.id`ê°€ `host`ì´ê¸° ë•Œë¬¸ì— Kubernetes ê´€ë ¨ëœ ì •ë³´ëŠ” `<NA>`ë¡œ í‘œì‹œëœë‹¤.

```json
{
  "hostname": "node-name",
  "output": "11:37:53.059395044: Alert Inbound SSH connection (user=root client_ip=x.x.x.x client_port=56483 server_ip=x.x.x.x) container_id=host container_image=<NA> container_image_tag=<NA> container_name=host k8s_ns=<NA> k8s_pod_name=<NA>",
  "priority": "Alert",
  "rule": "Inbound SSH Connection",
  "source": "syscall",
  "tags": ["network"],
  "time": "2024-05-03T11:37:53.059395044Z",
  "output_fields": {
    "container.id": "host",
    "container.image.repository": null,
    "container.image.tag": null,
    "container.name": "host",
    "evt.time": 1714736273059395044,
    "fd.cip": "x.x.x.x",
    "fd.cport": 56483,
    "fd.sip": "x.x.x.x",
    "k8s.ns.name": null,
    "k8s.pod.name": null,
    "user.name": "root"
  }
}
```

ê·¸ë¦¬ê³  ìœ„ì—ì„œ `falcosidekick`ì—ì„œ slackë„ ì„¤ì •ì„ í–ˆê¸° ë•Œë¬¸ì— ì•„ë˜ì²˜ëŸ¼ ìŠ¬ë™ ë©”ì„¸ì§€ê°€ ì˜¤ê²Œ ëœë‹¤.

<img src="/static/images/falco-slack.png" alt="falco slack message" />

## ì›í•˜ëŠ” ê²°ê³¼

ìµœì¢…ì ìœ¼ë¡œ Falcoë¡œ êµ¬í˜„í•˜ê³  ì‹¶ì€ ê²ƒì€ Worker Nodeë‚˜ Podì˜ Containerì— Terminal shellë¡œ ì—°ê²°í–ˆì„ ë•Œ, ëª¨ë“  ëª…ë ¹ì–´ë“¤ì„ ì €ì¥í•˜ê³  ì•Œë¦¼ì„ í•„ìš”ì‹œì— ë°›ê³  ì‹¶ë‹¤.

FalcoëŠ” Ruleì„ í†µí•´ì„œ íŠ¹ì • ì¡°ê±´ì— í•´ë‹¹ë˜ëŠ” Eventë¥¼ ì €ì¥í•˜ëŠ” êµ¬ì¡°ë¡œ ë˜ì–´ìˆë‹¤. ë”°ë¼ì„œ ì´ë ‡ê²Œ ëª¨ë“  ëª…ë ¹ì–´ë“¤ì„ ì €ì¥í•˜ê³  ì‹¶ë‹¤ë©´, ê·¸ë ‡ê²Œ í•  ìˆ˜ ìˆë„ë¡ Custom Ruleì„ ì •ì˜í•´ì•¼ í•œë‹¤.

```yaml
- rule: shell_in_container
	desc: notice shell activity within a container
	condition: >
		evt.type = execve and
		evt.dir = < and
		container.id != host and
		proc.pname = sh
	output: >
		shell in a container
		(user=%user.name container_id=%container.id container_name=%container.name
		shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline)
	priority: WARNING
```

`ls`ì˜ ê²½ìš°ì—ëŠ” `execve`ê°€ ì‚¬ìš©ë˜ê³  ì•„ë˜ì²˜ëŸ¼ logê°€ ë‚¨ê²Œ ëœë‹¤.

```bash
$ kubectl exec -it nginx-pod -- /bin/sh
# ls
```

```json
{
  "hostname": "node-name",
  "output": "12:03:52.176355678: Warning shell in a container (user=root container_id=6fec6323ae4c container_name=nginx  shell=ls parent=sh cmdline=ls /bin) container_id=6fec6323ae4c container_image=docker.io/library/nginx container_image_tag=latest container_name=nginx k8s_ns=default k8s_pod_name=pod-name",
  "priority": "Warning",
  "rule": "shell_in_container",
  "source": "syscall",
  "tags": [],
  "time": "2024-05-03T12:03:52.176355678Z",
  "output_fields": {
    "container.id": "6fec6323ae4c",
    "container.image.repository": "docker.io/library/nginx",
    "container.image.tag": "latest",
    "container.name": "nginx",
    "evt.time": 1714737832176355678,
    "k8s.ns.name": "default",
    "k8s.pod.name": "pod-name",
    "proc.cmdline": "ls /bin",
    "proc.name": "ls",
    "proc.pname": "sh",
    "user.name": "root"
  }
}
```

Pod containerë§ê³  hostë¥¼ í•˜ê³  ì‹¶ë‹¤ë©´ Conditionì—ì„œ `container.id = host`ë¡œ ì„¤ì •í•  ìˆ˜ ìˆë‹¤. ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ruleì„ ì¶”ê°€í•˜ë©´ ë‹¤ì–‘í•œ ëª…ë ¹ì–´ë“¤ì´ Shellì„ í†µí•´ì„œ ì‹¤í–‰ë˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```yaml
- rule: shell_in host
	desc: notice shell activity within a host
	condition: >
		evt.type = execve and
		evt.dir = < and
		container.id = host and
		proc.pname = sh
	output: >
		shell in a host
		(user=%user.name shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline)
	priority: WARNING
```

ê·¸ëŸ°ë° [`mkdir`](https://man7.org/linux/man-pages/man2/mkdir.2.html)ì˜ ê²½ìš°ì—ëŠ” `evt.type = mkdir`ë¡œ ì¶”ê°€í•´ì¤˜ì•¼í•œë‹¤. ë”°ë¼ì„œ conditionì—ì„œ `in`ìœ¼ë¡œ `mkdir`ë„ ì¶”ê°€í•œë‹¤.

```yaml
- rule: shell_in_container
	desc: notice shell activity within a container
	condition: >
		evt.type in (execve, mkdir) and
		evt.dir = < and
		container.id != host and
		proc.pname = sh
	output: >
		shell in a container
		(user=%user.name container_id=%container.id container_name=%container.name
		shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline)
	priority: WARNING
```

ê·¸ëŸ¬ë©´ ì´ì œ `mkdir`ë„ ì•„ë˜ì²˜ëŸ¼ ë¡œê·¸ê°€ ë‚¨ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```bash
$ kubectl exec -it nginx-pod -- /bin/sh
# mkdir /hellofalco
```

```json
{
  "hostname": "node-name",
  "output": "20:29:06.389110693: Warning shell in a container (user=root container_id=6fec6323ae4c container_name=nginx  shell=mkdir parent=sh cmdline=mkdir /hellofalco) container_id=6fec6323ae4c container_image=docker.io/library/nginx container_image_tag=latest container_name=nginx k8s_ns=default k8s_pod_name=pod-name",
  "priority": "Warning",
  "rule": "shell_in_container",
  "source": "syscall",
  "tags": [],
  "time": "2024-05-03T20:29:06.389110693Z",
  "output_fields": {
    "container.id": "6fec6323ae4c",
    "container.image.repository": "docker.io/library/nginx",
    "container.image.tag": "latest",
    "container.name": "nginx",
    "evt.time": 1714768146389110693,
    "k8s.ns.name": "default",
    "k8s.pod.name": "pod-name",
    "proc.cmdline": "mkdir /hellofalco",
    "proc.name": "mkdir",
    "proc.pname": "sh",
    "user.name": "root"
  }
}
```

í•˜ì§€ë§Œ `echo "hello world" > example.txt` ëª…ë ¹ì–´ë¥¼ í–ˆì„ ë•ŒëŠ” ìœ„ì˜ Ruleì— í¬í•¨ë˜ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ ì•„ë˜ì²˜ëŸ¼ ì¶”ê°€í•´ë³¸ë‹¤.

```yaml
- rule: shell_in_container
	desc: notice shell activity within a container
	condition: >
		evt.type in (open, openat, openat2) and
		evt.dir = < and
		fd.filename in (example.txt) and
		container.id != host
	output: >
		shell in a container
		(file=%fd.name evt_type=%evt.type user=%user.name container_id=%container.id container_name=%container.name
		shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline)
	priority: WARNING
```

ì´ì œ `example.txt`ë¥¼ ì•„ë˜ì™€ ê°™ì´ `echo`ë¡œ ìƒì„±í•´ë³¸ë‹¤.

```bash
$ kubectl exec -it nginx-pod -- /bin/sh
# echo "hello world" > example.txt
```

ê·¸ëŸ¬ë©´ `fd.name`ì„ í†µí•´ì„œ ìˆ˜ì •ëœ íŒŒì¼ëª…ì„ ì•Œ ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ `echo "hello world" > example.txt` ì „ì²´ ëª…ë ¹ì–´ë¥¼ ë‚¨ê¸¸ ë°©ë²•ì´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤. ğŸ¤” ê·¸ë¦¬ê³  `open`ì˜ ê²½ìš°ì—ëŠ” ë„ˆë¬´ë‚˜ ë§ì€ í”„ë¡œì„¸ìŠ¤ì—ì„œ callí•˜ê³  ìˆê¸° ë•Œë¬¸ì— ì¢€ë” êµ¬ì²´ì ì¸ ì¡°ê±´ì„ ì‘ì„±í•˜ì§€ ì•Šìœ¼ë©´ ë¶ˆí•„ìš”í•˜ê²Œ ë„ˆë¬´ ë§ì€ ì´ë²¤íŠ¸ ë¡œê·¸ê°€ ë‚¨ê²Œ ëœë‹¤. Falco stable Rule ì¤‘ì— `/var/log/auth.log`ë‚˜ `/var/log/syslog`ì²˜ëŸ¼ ì‹œìŠ¤í…œ ë¡œê·¸ë“¤ì„ ìˆ˜ì •í•˜ë©´ ì•Œë¦¼ì´ ì˜¤ë„ë¡ ì„¤ì •ë˜ì–´ ìˆë‹¤. ì´ì²˜ëŸ¼ êµ¬ì²´ì ì¸ ì¡°ê±´ì„ í†µí•´ì„œ íŠ¹ì • í–‰ìœ„ì— ëŒ€í•œ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.

```json
{
  "hostname": "node-name",
  "output": "21:41:34.978625505: Warning shell in a container (file=/example.txt evt_type=openat user=root container_id=6fec6323ae4c container_name=nginx  shell=sh parent=containerd-shim cmdline=sh) container_id=6fec6323ae4c container_image=docker.io/library/nginx container_image_tag=latest container_name=nginx k8s_ns=default k8s_pod_name=pod-name",
  "priority": "Warning",
  "rule": "shell_in_container",
  "source": "syscall",
  "tags": [],
  "time": "2024-05-03T21:41:34.978625505Z",
  "output_fields": {
    "container.id": "6fec6323ae4c",
    "container.image.repository": "docker.io/library/nginx",
    "container.image.tag": "latest",
    "container.name": "nginx",
    "evt.time": 1714772494978625505,
    "evt.type": "openat",
    "fd.name": "/example.txt",
    "k8s.ns.name": "default",
    "k8s.pod.name": "pod-name",
    "proc.cmdline": "sh",
    "proc.name": "sh",
    "proc.pname": "containerd-shim",
    "user.name": "root"
  }
}
```

## ê²°ë¡ 

Kubernetes Worker Nodeì™€ Pod Containerì— ì§ì ‘ Terminal shellì„ í†µí•´ì„œ ì–´ë– í•œ ëª…ë ¹ì–´ë“¤ì„ ì‹¤í–‰í–ˆì„ ë•Œ, ê·¸ê²ƒë“¤ì„ ëª¨ë‘ ì €ì¥í•˜ê³  íŠ¹ì •í•œ ì¡°ê±´ì— ë”°ë¼ ì‹¤ì‹œê°„ ì•Œë¦¼ì„ ë³´ë‚´ê³  ì‹¶ì—ˆë‹¤. FalcoëŠ” Rule ì •ì˜ë¥¼ í†µí•´ì„œ ì„ íƒì ìœ¼ë¡œ Kernel eventë¥¼ ë³´ì•ˆ ìœ„í˜‘ì´ ë˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ì €ì¥í•˜ê³  ì‹¤ì‹œê°„ì„±ìœ¼ë¡œ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ Falco Ruleì„ ì •ì˜í•˜ì—¬ sh, bashë“±ì´ Parent Processë¡œ ìˆìœ¼ë©´ì„œ `ls`, `cat`ë“±ì„ execve syscallë¡œ ì‹¤í–‰í•  ë•Œ eventë¥¼ ìˆ˜ì§‘í•˜ë„ë¡ í•˜ì˜€ë‹¤. í•˜ì§€ë§Œ `mkdir` ëª…ë ¹ì–´ì— ëŒ€í•´ì„œ `mkdir`ì´ë‚˜ `mkdirat` ì¡°ê±´ì„ ì¶”ê°€ í•´ì¤˜ì•¼ í•œë‹¤. `echo "hello world" > example.txt`ì˜ ê²½ìš°ì—ëŠ” example.txtë¥¼ ìˆ˜ì •/ì‚­ì œí•  ë•Œ ì´ë²¤íŠ¸ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆì§€ë§Œ, ì „ì²´ shellì—ì„œ ì‹¤í–‰í•œ ì „ì²´ ëª…ë ¹ì–´ë¥¼ ë‚¨ê¸°ëŠ” ë°©ë²•ì´ ë³´ì´ì§€ ì•Šì•˜ë‹¤. ê·¸ë¦¬ê³  ë„ˆë¬´ ë§ì€ ê³³ì—ì„œ íŒŒì¼ì„ ì½ê³  ì“°ê¸° ë•Œë¬¸ì— í•„í„° ì¡°ê±´ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ ì›í•˜ì§€ ì•Šì€ ì´ë²¤íŠ¸ë“¤ì´ ë„ˆë¬´ ë§ì´ ë‚¨ê²Œ ëœë‹¤. ë”°ë¼ì„œ ë‚´ê°€ ì›í•˜ë˜ êµ¬í˜„ì„ ìœ„í•´ì„œ FalcoëŠ” ì í•©í•˜ì§€ ì•Šë‹¤ëŠ” ê²°ë¡ ì„ ë‚´ë¦¬ê²Œ ë˜ì—ˆë‹¤.

ê·¸ëŸ¬ë©´ ì›í•˜ëŠ” êµ¬í˜„ì— ë” ì í•©í•œ ë‹¤ë¥¸ ì˜¤í”ˆì†ŒìŠ¤ ì†Œí”„íŠ¸ì›¨ì–´ê°€ ìˆì„ê¹Œ? ğŸ§
