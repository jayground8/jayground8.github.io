<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><link rel="manifest" href="/jayground8/static/favicons/manifest.json"/><link rel="manifest" href="/jayground8/static/favicons/site.webmanifest"/><link rel="shortcut icon" href="/jayground8/static/favicons/favicon.ico"/><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8773084925406986" crossorigin="anonymous"></script><title>Loki multi-tenants</title><meta name="robots" content="follow, index"/><meta name="description" content="Loki로 Log를 수집하고, Grafana로 Log를 보여줄 때 Grafana user별로 볼 수 있는 Log를 제한하고 싶었다. Grafana Enterpirse의 경우에는 Label-based access control을 제공하여, Loki label별로 Query할 수 있는 권한을 제한할 수 있는 것처럼 보인다. 하지만 아쉽게 오픈소스에서는 해당 기능을 제공하지 않는다. 그래서 Loki multi tenant를 통해서 Log를 tenent별로 그룹핑하고, tenant별로 query하는 방법을 사용했다. 그리고 Loki는 인증 layer가 존재하지 않기 때문에 Nginx를 통해서 인증을 하여 query할 수 있도록 하였다. 마지막으로 Network Policy로 Nginx 인증을 통해서 Loki에 접근하도록 강제하여 원하는 구성을 할 수 있었다."/><meta property="og:url" content="https://jayground8.github.io/blog/20240420-loki-multi-tenants"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Jayground8"/><meta property="og:description" content="Loki로 Log를 수집하고, Grafana로 Log를 보여줄 때 Grafana user별로 볼 수 있는 Log를 제한하고 싶었다. Grafana Enterpirse의 경우에는 Label-based access control을 제공하여, Loki label별로 Query할 수 있는 권한을 제한할 수 있는 것처럼 보인다. 하지만 아쉽게 오픈소스에서는 해당 기능을 제공하지 않는다. 그래서 Loki multi tenant를 통해서 Log를 tenent별로 그룹핑하고, tenant별로 query하는 방법을 사용했다. 그리고 Loki는 인증 layer가 존재하지 않기 때문에 Nginx를 통해서 인증을 하여 query할 수 있도록 하였다. 마지막으로 Network Policy로 Nginx 인증을 통해서 Loki에 접근하도록 강제하여 원하는 구성을 할 수 있었다."/><meta property="og:title" content="Loki multi-tenants"/><meta property="og:image" content="https://jayground8.github.io/static/images/social-banner.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site"/><meta name="twitter:title" content="Loki multi-tenants"/><meta name="twitter:description" content="Loki로 Log를 수집하고, Grafana로 Log를 보여줄 때 Grafana user별로 볼 수 있는 Log를 제한하고 싶었다. Grafana Enterpirse의 경우에는 Label-based access control을 제공하여, Loki label별로 Query할 수 있는 권한을 제한할 수 있는 것처럼 보인다. 하지만 아쉽게 오픈소스에서는 해당 기능을 제공하지 않는다. 그래서 Loki multi tenant를 통해서 Log를 tenent별로 그룹핑하고, tenant별로 query하는 방법을 사용했다. 그리고 Loki는 인증 layer가 존재하지 않기 때문에 Nginx를 통해서 인증을 하여 query할 수 있도록 하였다. 마지막으로 Network Policy로 Nginx 인증을 통해서 Loki에 접근하도록 강제하여 원하는 구성을 할 수 있었다."/><meta name="twitter:image" content="https://jayground8.github.io/static/images/social-banner.png"/><link rel="canonical" href="https://jayground8.github.io/blog/20240420-loki-multi-tenants"/><meta property="article:published_time" content="2024-04-20T00:00:00.000Z"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jayground8.github.io/blog/20240420-loki-multi-tenants"
  },
  "headline": "Loki multi-tenants",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://jayground8.github.io/static/images/social-banner.png"
    }
  ],
  "datePublished": "2024-04-20T00:00:00.000Z",
  "dateModified": "2024-04-20T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Jay"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Jay",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jayground8.github.ioplayground.png"
    }
  },
  "description": "Loki로 Log를 수집하고, Grafana로 Log를 보여줄 때 Grafana user별로 볼 수 있는 Log를 제한하고 싶었다. Grafana Enterpirse의 경우에는 Label-based access control을 제공하여, Loki label별로 Query할 수 있는 권한을 제한할 수 있는 것처럼 보인다. 하지만 아쉽게 오픈소스에서는 해당 기능을 제공하지 않는다. 그래서 Loki multi tenant를 통해서 Log를 tenent별로 그룹핑하고, tenant별로 query하는 방법을 사용했다. 그리고 Loki는 인증 layer가 존재하지 않기 때문에 Nginx를 통해서 인증을 하여 query할 수 있도록 하였다. 마지막으로 Network Policy로 Nginx 인증을 통해서 Loki에 접근하도록 강제하여 원하는 구성을 할 수 있었다."
}</script><meta name="next-head-count" content="24"/><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preload" href="/_next/static/css/414f98a58444a4f1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/414f98a58444a4f1.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-690364db8bfb1f01.js" defer=""></script><script src="/_next/static/chunks/main-eea1c213342d95c3.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3c8a0fd6355e4772.js" defer=""></script><script src="/_next/static/chunks/675-70b09cbf0a5309ea.js" defer=""></script><script src="/_next/static/chunks/410-35c4fb535edd9439.js" defer=""></script><script src="/_next/static/chunks/712-376d32740a4ac813.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-8ab66ff6ebabec4c.js" defer=""></script><script src="/_next/static/U7DE318orb_de6hUgWFnv/_buildManifest.js" defer=""></script><script src="/_next/static/U7DE318orb_de6hUgWFnv/_ssgManifest.js" defer=""></script><script src="/_next/static/U7DE318orb_de6hUgWFnv/_middlewareManifest.js" defer=""></script></head><body class="bg-white text-black antialiased dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex h-screen flex-col justify-between"><header class="flex items-center justify-between py-10"><div><a aria-label="Jayground8" href="/"><div class="flex items-center justify-between"><div class="mr-3"><svg xmlns="http://www.w3.org/2000/svg" width="53.87" height="43.61" viewBox="0 0 512 512" class="fill-black dark:fill-white"><path d="M368.4 17c-8.8 1.3-18.3 5-25.3 9.9-3.8 2.5-22.6 16.1-41.9 30.1-37.1 26.9-38.6 28.3-36.3 33.9 1.7 4 4.9 5.1 14.6 5.1h8.5v128h-17.9c-18.2 0-22.2.6-27.3 4.2l-2.8 1.9V116.9l2.5-2.4c1.5-1.6 3.6-2.5 5.5-2.5s4 .9 5.5 2.5l2.5 2.4v42c0 29.1.3 42.8 1.1 44.5 2.6 5.7 11.5 5.5 13.9-.3.7-1.9 1-15.6.8-46.2-.3-40.1-.4-43.7-2.2-46.9-4.8-9-11.9-13.4-21.6-13.4-13.8 0-22.8 9.1-23.8 24.1l-.5 7.3h-31.5l-1.2-2.9c-1.6-3.9-6-5.8-9.9-4.1-1.6.6-3.5 2.5-4.1 4.1l-1.2 2.9h-63.6l-1.2-2.9c-2.5-6.2-11.5-6.2-14 0l-1.2 2.9H64.3l-.5-7.3c-1-15-10-24.1-23.8-24.1-9.7 0-16.8 4.4-21.6 13.4-1.8 3.3-1.9 7.5-2.2 75-.2 50 .1 72.3.8 74.1 2.1 5.1 8.6 6.3 12.5 2.4l2.5-2.4V116.9l2.5-2.4c3.2-3.3 7.8-3.3 11 0l2.5 2.4V448H32V284.9l-2.5-2.4c-3.8-3.9-10.2-2.7-12.4 2.2-1.6 3.4-1.6 171.2 0 174.6.6 1.4 2.2 3 3.6 3.6 1.6.7 15.6 1.1 43.7 1.1 38 0 41.5-.1 43.4-1.8 1.2-.9 33.4-50.5 71.7-110.2 38.3-59.7 70.5-109.3 71.7-110.3 1.8-1.5 4.3-1.7 19.4-1.7H288v16h-12.5c-13.1 0-16.6.8-18.3 4.4-2 4.5-138.5 216.2-140.4 217.9-1.9 1.6-5.6 1.7-47.9 1.7-31.9 0-46.6.3-48.3 1.1-5.7 2.6-5.5 11.5.3 13.9 1.9.7 16.7 1 50.1.8 46.4-.3 47.6-.3 51.5-2.5 2.2-1.1 5.1-3.3 6.5-4.7 1.3-1.5 10.1-14.7 19.6-29.4l17.1-26.7 18.4-.5c10.1-.3 19.1-.9 20-1.3.9-.5 2.1-1.9 2.8-3.3 1.5-3.4 1.5-35.4 0-38.8-1.1-2.3-4-4-8-4.8-1.3-.2 1.5-5.2 11.5-20.7l13.1-20.5.5 56.5c.3 31 .9 57.1 1.3 58 1.5 3 5.6 3.9 18.2 3.9H256v14c0 14.9.7 18.1 4.7 19.9 1.7.8 34.7 1.1 115.3 1.1s113.6-.3 115.3-1.1c1.4-.6 3-2.2 3.6-3.6 1.5-3.4 1.5-83.2 0-86.6-2.2-4.9-8.6-6.1-12.4-2.2l-2.5 2.4V480H272V272h208v107.1l2.5 2.4c3.8 3.9 10.2 2.7 12.4-2.2 1.5-3.4 1.5-115.2 0-118.6-1.8-3.9-5-4.7-18.4-4.7H464v-40.5c0-27.9-.3-41.2-1.1-42.9-2.6-5.5-11.2-5.5-13.8 0-.8 1.7-1.1 15-1.1 42.9V256h-24v-34.5c0-21.3-.4-36.4-1.1-39.7-3.6-17.3-19.3-32.9-36.7-36.7-16.2-3.4-31.4 1.1-43.3 12.9-7.4 7.3-11.2 13.9-13.4 23.2-1.8 7.9-2.1 50.3-.4 54.2 1.6 3.5 6.1 5.2 9.8 3.7 4.7-2 5.1-4.2 5.1-29.6 0-21.5.2-23.9 2.2-29.2C350.6 168.4 363 160 376 160s25.4 8.4 29.8 20.3c2.1 5.5 2.2 7.4 2.2 40.7v35H304V96h144v24.5c0 16 .4 25.3 1.1 26.9 2.6 5.5 11.2 5.5 13.8 0 .7-1.6 1.1-10.9 1.1-26.9V96h8.5c9.7 0 12.9-1.1 14.6-5.1 2.1-5.2.1-7.5-17.7-20.4C446.2 53.8 445 53 442.1 53c-4.1.1-7.5 3.5-7.5 7.7 0 4 2.2 6.3 14.8 15.3l4.8 3.5-39.1.3c-21.5.1-56.7.1-78.2 0l-39.1-.3 14.9-10.7c8.2-5.9 20.7-15.1 27.8-20.4 14.5-10.8 20.5-14 29.4-15.5 11.6-2.1 22.4 1.3 36.5 11.4 4.3 3.1 9 5.7 10.3 5.7 3.9 0 7.5-4.4 7.1-8.7-.3-3.3-1.1-4.4-7.8-9.6-15.3-11.8-32.3-17.1-47.6-14.7zM96 152v8H64v-16h32v8zm80 0v8h-64v-16h64v8zm48 0v8h-32v-16h32v8zM96 280v104h-4.5c-5.5 0-9 1.5-10.4 4.7-1.5 3.3-1.5 35.4 0 38.7 1.7 3.6 3.1 4 16.2 4.6l11.9.5-5.1 7.7L99 448H64V176h32v104zm80-27.8v76.3l-17.8 27.7-17.7 27.7-14.2.1H112V176h64v76.2zm48-37.3v38.9l-15.6 24.4c-8.6 13.3-15.8 24.5-16 24.7-.2.2-.4-28.2-.4-63.2V176h32v38.9zM256 369v76h-16V317.1l7.8-12c4.2-6.7 7.8-12.1 8-12.1.1 0 .2 34.2.2 76zm-129.1 34.7c-1.2 2.1-3.6 5.7-5.1 8l-2.9 4.3H96v-16h33.2l-2.3 3.7zM192 408v8h-15.1l3.7-5.8c2-3.1 4.4-6.7 5.2-8 .8-1.2 2.4-2.2 3.8-2.2 2.3 0 2.4.2 2.4 8z"></path><path d="M322.5 114.5c-1.6 1.5-2.5 3.6-2.5 5.5s.9 4 2.5 5.5c1.5 1.6 3.6 2.5 5.5 2.5s4-.9 5.5-2.5c1.6-1.5 2.5-3.6 2.5-5.5s-.9-4-2.5-5.5c-1.5-1.6-3.6-2.5-5.5-2.5s-4 .9-5.5 2.5zM418.5 114.5c-1.6 1.5-2.5 3.6-2.5 5.5s.9 4 2.5 5.5c1.5 1.6 3.6 2.5 5.5 2.5s4-.9 5.5-2.5c1.6-1.5 2.5-3.6 2.5-5.5s-.9-4-2.5-5.5c-1.5-1.6-3.6-2.5-5.5-2.5s-4 .9-5.5 2.5zM290.2 290.3c-5 5.3-1.3 13.7 5.9 13.7 4.7 0 7.9-3.4 7.9-8.1 0-7.1-9-10.7-13.8-5.6zM450.5 290.5c-5 4.9-1.5 13.5 5.5 13.5 4.1 0 8-3.9 8-8s-3.9-8-8-8c-1.9 0-4 .9-5.5 2.5zM358.1 322c-8.3 2.2-16.5 5.7-19.8 8.6-3.3 2.8-3.9 7.3-1.4 10.6 3.3 4.1 6.4 4.3 13.8.8 23.3-10.9 47.3-7 64.8 10.5 11.5 11.4 16.5 23.6 16.5 39.7 0 15.9-5.1 28.1-16.4 39.4C404.2 443 392.1 448 376 448s-28.1-5-39.5-16.5c-11-11.1-16.5-24.2-16.5-39.5.1-9.5 1.2-14.5 5.6-24.3 3.8-8.3 3.8-10.4.1-14.5-4.7-5.1-10.8-1.7-15.4 8.6-8.6 19.5-8.4 42.7.6 61.7 9.1 19.3 28.3 34.5 49.5 39 11.9 2.6 28.4 1.7 39.3-2.2 23.9-8.6 41.3-27.9 46.9-51.9 1.9-8.5 1.9-24.4-.1-33.1-5.9-25.5-26.7-46.6-52.5-53.3-10.1-2.6-25.8-2.6-35.9 0zM290.2 450.3c-5 5.3-1.3 13.7 5.9 13.7 4.7 0 7.9-3.4 7.9-8.1 0-7.1-9-10.7-13.8-5.6zM450.2 450.3c-5 5.3-1.3 13.7 5.9 13.7 4.7 0 7.9-3.4 7.9-8.1 0-7.1-9-10.7-13.8-5.6z"></path></svg></div><div class="hidden h-6 text-2xl font-semibold sm:block">Jayground8</div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/blog">블로그</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/tags">Tags</a></div><button aria-label="Toggle Dark Mode" type="button" class="ml-1 mr-1 h-8 w-8 rounded p-1 sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="ml-1 mr-1 h-8 w-8 rounded py-1" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed top-0 left-0 z-10 h-full w-full transform bg-gray-200 opacity-95 duration-300 ease-in-out dark:bg-gray-800 translate-x-full"><div class="flex justify-end"><button type="button" class="mr-5 mt-11 h-8 w-8 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><nav class="fixed mt-8 h-full"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog">블로그</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div></nav></div></div></div></header><main class="mb-auto"><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="fixed right-8 bottom-8 hidden flex-col gap-3 md:hidden"><button aria-label="Scroll To Comment" type="button" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg></button><button aria-label="Scroll To Top" type="button" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2024-04-20T00:00:00.000Z">2024년 4월 20일 토요일</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Loki multi-tenants</h1></div></div></header><div class="divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6 xl:divide-y-0" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:border-b xl:border-gray-200 xl:pt-11 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 sm:space-x-12 xl:block xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2738%27%20height=%2738%27/%3e"/></span><img alt="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="h-10 w-10 rounded-full" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="avatar" srcSet="https://jayground8.github.io/static/images/profile.png?w=48&amp;q=75 1x, https://jayground8.github.io/static/images/profile.png?w=96&amp;q=75 2x" src="https://jayground8.github.io/static/images/profile.png?w=96&amp;q=75" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="h-10 w-10 rounded-full" loading="lazy"/></noscript></span><dl class="whitespace-nowrap text-sm font-medium leading-5"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Jay</dd><dt class="sr-only">Twitter</dt><dd></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="prose max-w-none pt-10 pb-8 dark:prose-dark"><h2 id="application-log를-분리"><a href="#application-log를-분리" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Application Log를 분리</h2><p>OpenTelemetry Collector와 Loki를 통해서 Application Log들을 수집하고, Grafana Explore를 통해서 Application Log들을 검색하고 확인할 수 있다. 그런데 Grafana Explore를 볼 수 있는 Application Log 종류를 제한하고 싶은 경우에는 어떻게 해야 할까? 예를 들어서 Grafana Account A는 Kubernetes의 main namespace안의 Pod log들만 볼 수 있게 제한하고, Grafana Account B는 Kubernetes의 test namespace에서 생성되는 log만 볼 수 있게 제한하고 싶다.</p><p>Grafana Enterprise의 경우에는 <a target="_blank" rel="noopener noreferrer" href="https://grafana.com/docs/enterprise-metrics/latest/tenant-management/lbac/">Label-based access control</a> 기능을 제공하여, 특정한 Label이 있는 경우만 볼 수 있도록 권한 설정이 가능한 것으로 보인다. 하지만 아쉽게도 오픈소스에서 해당 기능을 제공하지 않는다.</p><p>오픈소스를 사용하는 경우에는 <a target="_blank" rel="noopener noreferrer" href="https://grafana.com/docs/loki/latest/operations/multi-tenancy/">Loki에서 Multi-tenancy</a> 기능을 사용하여 분리를 고려할 수 있다. Loki에서 Log를 수집할 때 tenant별로 묶어서 저장하고, query를 할 때 해당 tenant 그룹에 속한 Log들만 가져올 수 있다. 그렇게 하기 위해서 Loki HTTP endpoint <code>/loki/api/v1/push</code>로 요청할 때, Header <code>X-Scope-OrgID</code> 값에 tenant 식별정보를 담아서 보내면 된다.</p><blockquote><p>Grafana Loki is a multi-tenant system; requests and data for tenant A are isolated from tenant B. Requests to the Loki API should include an HTTP header (X-Scope-OrgID) that identifies the tenant for the request.</p></blockquote><h2 id="loki-multi-tenant-system"><a href="#loki-multi-tenant-system" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Loki Multi Tenant System</h2><p><code>helm chart 5.42.2 버전 기준</code></p><p>Loki를 Monolithic Mode로 설치하여 테스트한다.</p><p><code>values.yaml</code></p><div class="relative"><pre><code class="language-yaml code-highlight"><span class="code-line"><span class="token atrule key">global</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token atrule key">dnsService</span><span class="token punctuation">:</span> <span class="token string">&quot;coredns&quot;</span>
</span><span class="code-line"><span class="token atrule key">loki</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token atrule key">auth_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</span><span class="code-line">	<span class="token atrule key">commonConfig</span><span class="token punctuation">:</span>
</span><span class="code-line">		<span class="token atrule key">replication_factor</span><span class="token punctuation">:</span> <span class="token number">1</span>
</span><span class="code-line">	<span class="token atrule key">storage</span><span class="token punctuation">:</span>
</span><span class="code-line">		<span class="token atrule key">type</span><span class="token punctuation">:</span> <span class="token string">&#x27;filesystem&#x27;</span>
</span><span class="code-line"><span class="token atrule key">singleBinary</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token atrule key">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
</span></code></pre></div><p><code>auth_enabled</code>를 <code>false</code>로 설정하면, single tanant를 사용하게 되고, tenant 식별명은 <code>fake</code>가 된다. <code>auth_enabled</code>의 기본값은 <code>true</code>이지만 명시적으로 설정해주었다.</p><blockquote><p>Loki defaults to running in multi-tenant mode. Multi-tenant mode is set in the configuration with auth_enabled: true.</p></blockquote><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/grafana/loki/blob/main/production/helm/loki/values.yaml">Helm chart의 value값을 확인</a>해보면 아래와 같이 설정되어 있는 것을 확인할 수 있다. Loki에서 log data를 압축해서 저장하게 되는데, 해당 chunk 파일들이 filesystem의 아래 경로로 저장된다.</p><div class="relative"><pre><code class="language-yaml code-highlight"><span class="code-line"><span class="token atrule key">filesystem</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">chunks_directory</span><span class="token punctuation">:</span> /var/loki/chunks
</span><span class="code-line">  <span class="token atrule key">rules_directory</span><span class="token punctuation">:</span> /var/loki/rules
</span></code></pre></div><p>아래와 같이 Pod에 접근하여 해당 경로를 확인해보면, tenant 이름별로 Directory가 생긴 것을 확인할 수 있다. 만약 <code>auth_enabled</code>를 <code>false</code>로 했다면, 여기에 <code>fake</code>라는 Directory명으로 파일들이 생성될 것이다.</p><div class="relative"><pre><code class="code-highlight language-bash"><span class="code-line">kubectl <span class="token builtin class-name">exec</span> -it loki-0 -- /bin/sh
</span></code></pre></div><div class="relative"><pre><code class="code-highlight language-bash"><span class="code-line"><span class="token function">ls</span> /var/loki/chunks
</span></code></pre></div><p>주의해야할 점은 <code>auth_enabled</code>은 <code>true</code>로 설정했기 때문에, Loki에 push 요청을 할 때 <code>X-Scope-OrgID</code> 해더값이 없으면 요청이 실패한다.</p><h2 id="opentelmetry-loki-exporter-설정"><a href="#opentelmetry-loki-exporter-설정" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>OpenTelmetry Loki Exporter 설정</h2><p>OpenTelemetry Collector의 Exporter로 Loki에 Log 데이터를 전달할 경우, <a target="_blank" rel="noopener noreferrer" href="https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/exporter/lokiexporter/README.md">Loki Exporter 문서</a>에 설명된 것처럼 tenant 정보를 보낼 수 있다.</p><p>고정 tenant 값을 사용할 때는 아래와 같이 전달할 수 있고,</p><div class="relative"><pre><code class="language-yaml code-highlight"><span class="code-line"><span class="token atrule key">exporters</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">loki</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3100/loki/api/v1/push
</span><span class="code-line">    <span class="token atrule key">headers</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">&quot;X-Scope-OrgID&quot;</span><span class="token punctuation">:</span> staticTenant
</span></code></pre></div><p>변수값을 보내야 하면 아래와 같이 <code>loki.tenant</code> 속성값을 정의할 수 있다. 이렇게 <code>loki.tenant</code>를 설정하면, <code>X-Scope-OrgID</code> header로 해당 값을 전달하게 된다.</p><div class="relative"><pre><code class="language-yaml code-highlight"><span class="code-line"><span class="token atrule key">processors</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">resource</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">attributes</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token punctuation">-</span> <span class="token atrule key">action</span><span class="token punctuation">:</span> insert
</span><span class="code-line">      <span class="token atrule key">key</span><span class="token punctuation">:</span> loki.tenant
</span><span class="code-line">      <span class="token atrule key">value</span><span class="token punctuation">:</span> host.name
</span></code></pre></div><p><code>opentelemetry-collector Helm chart 0.77.0 버전 기준</code></p><p>opentelemetry-collector Helm chart의 value중에 service, processors, exporters를 아래와 같이 설정할 수 있다. <code>loki.tenant</code> 속성값에 container명을 설정하였다. <a target="_blank" rel="noopener noreferrer" href="https://github.com/open-telemetry/opentelemetry-collector-contrib/pull/14930">PR을 보면 Loki index를 설정하는 <code>loki.attribute.labels</code>, <code>loki.resource.labels</code> hint와 더불어서 <code>loki.tenant</code>도 hint로 사용할수 있도록 추가되었다.</a></p><div class="relative"><pre><code class="language-yaml code-highlight"><span class="code-line"><span class="token atrule key">service</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token atrule key">telemetry</span><span class="token punctuation">:</span>
</span><span class="code-line">		<span class="token atrule key">logs</span><span class="token punctuation">:</span>
</span><span class="code-line">			<span class="token atrule key">level</span><span class="token punctuation">:</span> info
</span><span class="code-line">	<span class="token atrule key">pipelines</span><span class="token punctuation">:</span>
</span><span class="code-line">		<span class="token atrule key">traces</span><span class="token punctuation">:</span>
</span><span class="code-line">			<span class="token atrule key">receivers</span><span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token punctuation">-</span> otlp
</span><span class="code-line">			<span class="token atrule key">exporters</span><span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token punctuation">-</span> otlp
</span><span class="code-line">		<span class="token atrule key">metrics</span><span class="token punctuation">:</span>
</span><span class="code-line">			<span class="token atrule key">receivers</span><span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token punctuation">-</span> otlp
</span><span class="code-line">		<span class="token atrule key">logs</span><span class="token punctuation">:</span>
</span><span class="code-line">			<span class="token atrule key">receivers</span><span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token punctuation">-</span> filelog
</span><span class="code-line">			<span class="token atrule key">processors</span><span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token punctuation">-</span> resource
</span><span class="code-line">				<span class="token punctuation">-</span> attributes
</span><span class="code-line">			<span class="token atrule key">exporters</span><span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token punctuation">-</span> loki
</span><span class="code-line"><span class="token atrule key">processors</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token atrule key">attributes</span><span class="token punctuation">:</span>
</span><span class="code-line">		<span class="token atrule key">actions</span><span class="token punctuation">:</span>
</span><span class="code-line">			<span class="token punctuation">-</span> <span class="token atrule key">action</span><span class="token punctuation">:</span> insert
</span><span class="code-line">				<span class="token atrule key">key</span><span class="token punctuation">:</span> loki.attribute.labels
</span><span class="code-line">				<span class="token atrule key">value</span><span class="token punctuation">:</span> level<span class="token punctuation">,</span> context<span class="token punctuation">,</span> traceID
</span><span class="code-line">			<span class="token punctuation">-</span> <span class="token atrule key">action</span><span class="token punctuation">:</span> insert
</span><span class="code-line">				<span class="token atrule key">key</span><span class="token punctuation">:</span> loki.tenant
</span><span class="code-line">				<span class="token atrule key">value</span><span class="token punctuation">:</span> container
</span><span class="code-line">	<span class="token atrule key">resource</span><span class="token punctuation">:</span>
</span><span class="code-line">		<span class="token atrule key">attributes</span><span class="token punctuation">:</span>
</span><span class="code-line">			<span class="token punctuation">-</span> <span class="token atrule key">action</span><span class="token punctuation">:</span> insert
</span><span class="code-line">				<span class="token atrule key">key</span><span class="token punctuation">:</span> loki.format
</span><span class="code-line">				<span class="token atrule key">value</span><span class="token punctuation">:</span> json
</span><span class="code-line">			<span class="token punctuation">-</span> <span class="token atrule key">action</span><span class="token punctuation">:</span> insert
</span><span class="code-line">				<span class="token atrule key">key</span><span class="token punctuation">:</span> loki.resource.labels
</span><span class="code-line">				<span class="token atrule key">value</span><span class="token punctuation">:</span> pod<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> container
</span><span class="code-line"><span class="token atrule key">exporters</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token atrule key">loki</span><span class="token punctuation">:</span>
</span><span class="code-line">		<span class="token atrule key">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//loki<span class="token punctuation">:</span>3100/loki/api/v1/push
</span></code></pre></div><p>이렇게 설정하고 나면, filelog로 수집한 container명이 tenant로 설정될 수 있다.</p><h2 id="grafana-datasource-설정"><a href="#grafana-datasource-설정" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Grafana Datasource 설정</h2><p>이제 Loki에서 multi tenant를 사용하도록 설정하였고, Loki에게 log data를 전달하는 OpenTelemetry Collector에서 Tenant 정보를 보내도록 설정하였다. 이제 로그 데이터를 Query 요청을 하는 Grafana의 설정도 변경이 필요하다.</p><p>Log data를 Push하는 것 뿐만 아니라, Query 요청할 때도 <code>X-Scope-OrgID</code> 해더 정보를 같이 보내야 한다. 해당 값을 보내지 않으면 Grafana에서 로그를 검색하려고 할 때, <code>no org id</code> 에러 메세지가 뜬다.</p><p>Datasource를 정의할 때, 아래와 같이 Header 값을 설정해서 보내주면 된다. 여기 예제에서는 특정 container이름으로만 Query를 할 수 있게 하였다.</p><div class="relative"><pre><code class="language-yaml code-highlight"><span class="code-line"><span class="token atrule key">datasources.yaml</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token atrule key">apiVersion</span><span class="token punctuation">:</span> <span class="token number">1</span>
</span><span class="code-line">	<span class="token atrule key">datasources</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token punctuation">-</span> <span class="token atrule key">name</span><span class="token punctuation">:</span> Loki
</span><span class="code-line">		<span class="token atrule key">type</span><span class="token punctuation">:</span> loki
</span><span class="code-line">		<span class="token atrule key">isDefault</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</span><span class="code-line">		<span class="token atrule key">access</span><span class="token punctuation">:</span> proxy
</span><span class="code-line">		<span class="token atrule key">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//loki<span class="token punctuation">:</span><span class="token number">3100</span>
</span><span class="code-line">		<span class="token atrule key">basicAuth</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</span><span class="code-line">		<span class="token atrule key">secureJsonData</span><span class="token punctuation">:</span>
</span><span class="code-line">			<span class="token atrule key">httpHeaderValue1</span><span class="token punctuation">:</span> <span class="token string">&quot;containerName&quot;</span>
</span><span class="code-line">		<span class="token atrule key">jsonData</span><span class="token punctuation">:</span>
</span><span class="code-line">			<span class="token atrule key">httpHeaderName1</span><span class="token punctuation">:</span> <span class="token string">&quot;X-Scope-OrgID&quot;</span>
</span></code></pre></div><h2 id="loki-authentication"><a href="#loki-authentication" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Loki Authentication</h2><p>Grafana datasource에 Loki를 추가하고, tenant로 묶여 있는 로그들을 불러와서 보았다. 이렇게 Datasource를 Helm chart로 정의해서 배포했을 때는 아래처럼 UI에서 직접 수정할 수가 없다. 따라서 다른 tenant를 보도록 <code>X-Scope-OrgID</code>를 수정할 수가 없다.</p><img src="/static/images/loki-multi-tenant-grafana-datasource.png" alt="datasource in grafana settings"/><p>하지만 Grafana에서 datasource를 새롭게 만들 수 있는 Admin 권한을 가지고 있으면, 새로운 Loki connection을 추가하여 설정할 수 있다. Config파일로 정의한 Datasource로만 Log Query를 할 수 있게 제한하고 싶으면 어떻게 해야 할까?</p><p><a target="_blank" rel="noopener noreferrer" href="https://grafana.com/docs/loki/latest/operations/authentication/">Loki의 문서에 인증 관련 설명이 아래와 같이 있다.</a> Loki에서는 자체적으로 인증 layer를 두고 있지 않고, Helm chart로 설치하게 되면 Nginx가 gateway로 인증 역할을 해줄 수 있다.</p><blockquote><p>Grafana Loki does not come with any included authentication layer.</p></blockquote><p>Loki를 Helm chart을 이용해 Monolithic mode로 배포를 하면, <code>loki-gateway-</code> prefix로 시작하는 pod가 생성되는 것을 확인할 수 있다. Pod의 정보를 보면 아래와 같이 nginx가 설정되어 있는 것을 확인할 수 있다. (보안을 위해서 privileged 권한이 필요없는 <code>nginx-unpriviledged</code>를 사용하고 있다.👍)</p><div class="relative"><pre><code class="language-yaml code-highlight"><span class="code-line"><span class="token atrule key">Containers</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">nginx</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">Container ID</span><span class="token punctuation">:</span>   containerd<span class="token punctuation">:</span>//0bea78d416e7138fe1e6037b5bfc728191c3951a254d21b4f5a278c381708198
</span><span class="code-line">    <span class="token atrule key">Image</span><span class="token punctuation">:</span>          docker.io/nginxinc/nginx<span class="token punctuation">-</span>unprivileged<span class="token punctuation">:</span>1.24<span class="token punctuation">-</span>alpine
</span><span class="code-line">    <span class="token atrule key">Image ID</span><span class="token punctuation">:</span>       docker.io/nginxinc/nginx<span class="token punctuation">-</span>unprivileged@sha256<span class="token punctuation">:</span>7bef7e4c99edc6b53e55396fd181288320cfc422c8e3d0beb588c715f7bdc1b0
</span><span class="code-line">    <span class="token atrule key">Port</span><span class="token punctuation">:</span>           8080/TCP
</span></code></pre></div><p>그리고 <code>kubectl get configmap loki-gateway -o yaml</code>를 확인해보면 configmap에 nginx 설정값이 정의된 것을 확인할 수 있다.</p><p>이제 우리는 Loki Gateway를 사용해서 인증을 추가하고, 인증을 통해서만 Loki 해당 tenant 관련 Log 데이터를 가져올 수 있게 할 수 있다. 먼저 Loki Helm chart value에 아래와 같이 추가한다. <code>tenants</code>에 tenant이름과 password를 설정하고, gateway에서 Basic Authentication을 하도록 <code>basicAuth</code>를 enabled한다.</p><div class="relative"><pre><code class="language-yaml code-highlight"><span class="code-line"><span class="token atrule key">global</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token atrule key">dnsService</span><span class="token punctuation">:</span> <span class="token string">&quot;coredns&quot;</span>
</span><span class="code-line"><span class="token atrule key">loki</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token atrule key">auth_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</span><span class="code-line">	<span class="token atrule key">tenants</span><span class="token punctuation">:</span> 
</span><span class="code-line">	<span class="token punctuation">-</span> <span class="token atrule key">name</span><span class="token punctuation">:</span> containerName
</span><span class="code-line">	  <span class="token atrule key">password</span><span class="token punctuation">:</span> somethingPassword
</span><span class="code-line">	<span class="token atrule key">commonConfig</span><span class="token punctuation">:</span>
</span><span class="code-line">	  <span class="token atrule key">replication_factor</span><span class="token punctuation">:</span> <span class="token number">1</span>
</span><span class="code-line">	<span class="token atrule key">storage</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">type</span><span class="token punctuation">:</span> <span class="token string">&#x27;filesystem&#x27;</span>
</span><span class="code-line"><span class="token atrule key">gateway</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token atrule key">basicAuth</span><span class="token punctuation">:</span>
</span><span class="code-line">		<span class="token atrule key">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</span><span class="code-line"><span class="token atrule key">singleBinary</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token atrule key">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
</span></code></pre></div><p>이렇게 설정하면 <code>loki-gateway</code> ConfigMap data가 아래와 같이 설정된다. <code>auth_basic_user_file</code>이 설정되어서 Basic Authentication으로 인증을 하게 되고, <code>proxy_set_header X-Scope-OrgID $remote_user;</code> 자동으로 Header값에 Basic Authentication을 하는 user명을 넣어서 보내게 된다. 우리는 위에서 <code>containerName</code> username과 <code>somethingPassword</code>로 password를 정의했고, 그것이 <code>/etc/nginx/secrets/.htpasswd </code>에 설정된다.</p><div class="relative"><pre><code class="code-highlight language-bash"><span class="code-line">nginx.conf: <span class="token operator">|</span>
</span><span class="code-line">	worker_processes  <span class="token number">5</span><span class="token punctuation">;</span>  <span class="token comment">## Default: 1</span>
</span><span class="code-line">	error_log  /dev/stderr<span class="token punctuation">;</span>
</span><span class="code-line">	pid        /tmp/nginx.pid<span class="token punctuation">;</span>
</span><span class="code-line">	worker_rlimit_nofile <span class="token number">8192</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">	events <span class="token punctuation">{</span>
</span><span class="code-line">		worker_connections  <span class="token number">4096</span><span class="token punctuation">;</span>  <span class="token comment">## Default: 1024</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">	http <span class="token punctuation">{</span>
</span><span class="code-line">		client_body_temp_path /tmp/client_temp<span class="token punctuation">;</span>
</span><span class="code-line">		proxy_temp_path       /tmp/proxy_temp_path<span class="token punctuation">;</span>
</span><span class="code-line">		fastcgi_temp_path     /tmp/fastcgi_temp<span class="token punctuation">;</span>
</span><span class="code-line">		uwsgi_temp_path       /tmp/uwsgi_temp<span class="token punctuation">;</span>
</span><span class="code-line">		scgi_temp_path        /tmp/scgi_temp<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">		client_max_body_size  4M<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">		proxy_read_timeout    <span class="token number">600</span><span class="token punctuation">;</span> <span class="token comment">## 10 minutes</span>
</span><span class="code-line">		proxy_send_timeout    <span class="token number">600</span><span class="token punctuation">;</span>
</span><span class="code-line">		proxy_connect_timeout <span class="token number">600</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">		proxy_http_version    <span class="token number">1.1</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">		default_type application/octet-stream<span class="token punctuation">;</span>
</span><span class="code-line">		log_format   main <span class="token string">&#x27;$remote_addr - $remote_user [$time_local]  $status &#x27;</span>
</span><span class="code-line">					<span class="token string">&#x27;&quot;$request&quot; $body_bytes_sent &quot;$http_referer&quot; &#x27;</span>
</span><span class="code-line">					<span class="token string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><span class="token punctuation">;</span>
</span><span class="code-line">		access_log   /dev/stderr  main<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">		sendfile     on<span class="token punctuation">;</span>
</span><span class="code-line">		tcp_nopush   on<span class="token punctuation">;</span>
</span><span class="code-line">		resolver coredns.kube-system.svc.cluster.local.<span class="token punctuation">;</span>
</span><span class="code-line">		proxy_set_header X-Scope-OrgID <span class="token variable">$remote_user</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">		server <span class="token punctuation">{</span>
</span><span class="code-line">			listen             <span class="token number">8080</span><span class="token punctuation">;</span>
</span><span class="code-line">			listen             <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8080<span class="token punctuation">;</span>
</span><span class="code-line">			auth_basic           <span class="token string">&quot;Loki&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line">			auth_basic_user_file /etc/nginx/secrets/.htpasswd<span class="token punctuation">;</span>
</span><span class="code-line">			<span class="token punctuation">..</span>.생략
</span></code></pre></div><p>이렇게 인증을 추가했기 때문에 <code>http://loki-gateway</code>를 통해서 접속할 때 아래처럼 인증 관련 정보를 넣어야 한다.</p><img src="/static/images/loki-multi-tenant-grafana-authentication.png" alt="datasource authentication in grafana settings"/><p>이제 Network Policy로 Grafana에서 인증이 없는 Loki Service로 접근하지 못하도록 막고, Loki Gateway를 통해서 접근하도록 한다. 그러면 해당 tenant의 인증 정보를 알지못하면 연결할 수가 없다. 따라서 Grafana에서 Admin 권한이 있더라도 새로운 connection을 추가해서 다른 tenant의 log에 접근하는 것을 막을 수 있다.</p><h2 id="결론"><a href="#결론" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>결론</h2><p>Loki를 통해서 Log 데이터를 수집하고 Query할 때, 사용자에 따라서 어떤 로그에 접근할 수 있는지 제한하고 싶었다. Grafana의 Label-based access control를 통해서 그 목적을 달성할 수 있을 것 같았지만, 해당 기능은 Grafana Enterprise 버전에서만 제공한다. 따라서 Loki의 multi tenant mode를 통해서 log group를 분리하고, Query할 때 해당 log group만 할 수 있도록 하였다. 그리고 Nginx에서 인증을 하여 해당 tenant의 log group에 접근할 수 있도록 하였다.</p></div><div class="pt-6 pb-6 text-sm text-gray-700 dark:text-gray-300"></div><div id="comment"></div></div><footer><div class="divide-gray-200 text-sm font-medium leading-5 dark:divide-gray-700 xl:col-start-1 xl:row-start-2 xl:divide-y"><div class="py-4 xl:py-8"><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/kubernetes">kubernetes</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/20240324-book-review-what-can-a-body-do">책 &quot;다른 몸들을 위한 디자인&quot;을 읽고...</a></div></div><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Next Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/20240420-kubelet-imagegc">Kubelet imageGC</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog">← Back to the blog</a></div></footer></div></div></article></div></main><footer><div class="mt-16 flex flex-col items-center"><div class="mb-3 flex space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:jayground8@gmail.com"><span class="sr-only">mail</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/jayground8"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></div><div class="mb-2 flex space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Jay</div><div> • </div><div>© 2024</div><div> • </div><a href="/">Jayground8</a></div><div class="mb-8 text-sm text-gray-500 dark:text-gray-400"><a target="_blank" rel="noopener noreferrer" href="https://github.com/timlrx/tailwind-nextjs-starter-blog">Tailwind Nextjs Theme</a></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var r=Object.create;var l=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var h=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var t=a=\u003el(a,\"__esModule\",{value:!0});var u=(a,s)=\u003e()=\u003e(s||a((s={exports:{}}).exports,s),s.exports),k=(a,s)=\u003e{t(a);for(var c in s)l(a,c,{get:s[c],enumerable:!0})},N=(a,s,c)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let n of p(s))!m.call(a,n)\u0026\u0026n!==\"default\"\u0026\u0026l(a,n,{get:()=\u003es[n],enumerable:!(c=d(s,n))||c.enumerable});return a},g=a=\u003eN(t(l(a!=null?r(h(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var o=u((L,i)=\u003e{i.exports=_jsx_runtime});var _={};k(_,{default:()=\u003ef,frontmatter:()=\u003ey});var e=g(o()),y={title:\"Loki multi-tenants\",date:\"2024-04-20\",tags:[\"kubernetes\"],images:[\"/static/images/social-banner.png\"],summary:\"Loki\\uB85C Log\\uB97C \\uC218\\uC9D1\\uD558\\uACE0, Grafana\\uB85C Log\\uB97C \\uBCF4\\uC5EC\\uC904 \\uB54C Grafana user\\uBCC4\\uB85C \\uBCFC \\uC218 \\uC788\\uB294 Log\\uB97C \\uC81C\\uD55C\\uD558\\uACE0 \\uC2F6\\uC5C8\\uB2E4. Grafana Enterpirse\\uC758 \\uACBD\\uC6B0\\uC5D0\\uB294 Label-based access control\\uC744 \\uC81C\\uACF5\\uD558\\uC5EC, Loki label\\uBCC4\\uB85C Query\\uD560 \\uC218 \\uC788\\uB294 \\uAD8C\\uD55C\\uC744 \\uC81C\\uD55C\\uD560 \\uC218 \\uC788\\uB294 \\uAC83\\uCC98\\uB7FC \\uBCF4\\uC778\\uB2E4. \\uD558\\uC9C0\\uB9CC \\uC544\\uC27D\\uAC8C \\uC624\\uD508\\uC18C\\uC2A4\\uC5D0\\uC11C\\uB294 \\uD574\\uB2F9 \\uAE30\\uB2A5\\uC744 \\uC81C\\uACF5\\uD558\\uC9C0 \\uC54A\\uB294\\uB2E4. \\uADF8\\uB798\\uC11C Loki multi tenant\\uB97C \\uD1B5\\uD574\\uC11C Log\\uB97C tenent\\uBCC4\\uB85C \\uADF8\\uB8F9\\uD551\\uD558\\uACE0, tenant\\uBCC4\\uB85C query\\uD558\\uB294 \\uBC29\\uBC95\\uC744 \\uC0AC\\uC6A9\\uD588\\uB2E4. \\uADF8\\uB9AC\\uACE0 Loki\\uB294 \\uC778\\uC99D layer\\uAC00 \\uC874\\uC7AC\\uD558\\uC9C0 \\uC54A\\uAE30 \\uB54C\\uBB38\\uC5D0 Nginx\\uB97C \\uD1B5\\uD574\\uC11C \\uC778\\uC99D\\uC744 \\uD558\\uC5EC query\\uD560 \\uC218 \\uC788\\uB3C4\\uB85D \\uD558\\uC600\\uB2E4. \\uB9C8\\uC9C0\\uB9C9\\uC73C\\uB85C Network Policy\\uB85C Nginx \\uC778\\uC99D\\uC744 \\uD1B5\\uD574\\uC11C Loki\\uC5D0 \\uC811\\uADFC\\uD558\\uB3C4\\uB85D \\uAC15\\uC81C\\uD558\\uC5EC \\uC6D0\\uD558\\uB294 \\uAD6C\\uC131\\uC744 \\uD560 \\uC218 \\uC788\\uC5C8\\uB2E4.\"};function b(a={}){let{wrapper:s}=a.components||{};return s?(0,e.jsx)(s,Object.assign({},a,{children:(0,e.jsx)(c,{})})):c();function c(){let n=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",p:\"p\",code:\"code\",blockquote:\"blockquote\",pre:\"pre\"},a.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(n.h2,{id:\"application-log\\uB97C-\\uBD84\\uB9AC\",children:[(0,e.jsx)(n.a,{href:\"#application-log\\uB97C-\\uBD84\\uB9AC\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Application Log\\uB97C \\uBD84\\uB9AC\"]}),(0,e.jsx)(n.p,{children:\"OpenTelemetry Collector\\uC640 Loki\\uB97C \\uD1B5\\uD574\\uC11C Application Log\\uB4E4\\uC744 \\uC218\\uC9D1\\uD558\\uACE0, Grafana Explore\\uB97C \\uD1B5\\uD574\\uC11C Application Log\\uB4E4\\uC744 \\uAC80\\uC0C9\\uD558\\uACE0 \\uD655\\uC778\\uD560 \\uC218 \\uC788\\uB2E4. \\uADF8\\uB7F0\\uB370 Grafana Explore\\uB97C \\uBCFC \\uC218 \\uC788\\uB294 Application Log \\uC885\\uB958\\uB97C \\uC81C\\uD55C\\uD558\\uACE0 \\uC2F6\\uC740 \\uACBD\\uC6B0\\uC5D0\\uB294 \\uC5B4\\uB5BB\\uAC8C \\uD574\\uC57C \\uD560\\uAE4C? \\uC608\\uB97C \\uB4E4\\uC5B4\\uC11C Grafana Account A\\uB294 Kubernetes\\uC758 main namespace\\uC548\\uC758 Pod log\\uB4E4\\uB9CC \\uBCFC \\uC218 \\uC788\\uAC8C \\uC81C\\uD55C\\uD558\\uACE0, Grafana Account B\\uB294 Kubernetes\\uC758 test namespace\\uC5D0\\uC11C \\uC0DD\\uC131\\uB418\\uB294 log\\uB9CC \\uBCFC \\uC218 \\uC788\\uAC8C \\uC81C\\uD55C\\uD558\\uACE0 \\uC2F6\\uB2E4.\"}),(0,e.jsxs)(n.p,{children:[\"Grafana Enterprise\\uC758 \\uACBD\\uC6B0\\uC5D0\\uB294 \",(0,e.jsx)(n.a,{href:\"https://grafana.com/docs/enterprise-metrics/latest/tenant-management/lbac/\",children:\"Label-based access control\"}),\" \\uAE30\\uB2A5\\uC744 \\uC81C\\uACF5\\uD558\\uC5EC, \\uD2B9\\uC815\\uD55C Label\\uC774 \\uC788\\uB294 \\uACBD\\uC6B0\\uB9CC \\uBCFC \\uC218 \\uC788\\uB3C4\\uB85D \\uAD8C\\uD55C \\uC124\\uC815\\uC774 \\uAC00\\uB2A5\\uD55C \\uAC83\\uC73C\\uB85C \\uBCF4\\uC778\\uB2E4. \\uD558\\uC9C0\\uB9CC \\uC544\\uC27D\\uAC8C\\uB3C4 \\uC624\\uD508\\uC18C\\uC2A4\\uC5D0\\uC11C \\uD574\\uB2F9 \\uAE30\\uB2A5\\uC744 \\uC81C\\uACF5\\uD558\\uC9C0 \\uC54A\\uB294\\uB2E4.\"]}),(0,e.jsxs)(n.p,{children:[\"\\uC624\\uD508\\uC18C\\uC2A4\\uB97C \\uC0AC\\uC6A9\\uD558\\uB294 \\uACBD\\uC6B0\\uC5D0\\uB294 \",(0,e.jsx)(n.a,{href:\"https://grafana.com/docs/loki/latest/operations/multi-tenancy/\",children:\"Loki\\uC5D0\\uC11C Multi-tenancy\"}),\" \\uAE30\\uB2A5\\uC744 \\uC0AC\\uC6A9\\uD558\\uC5EC \\uBD84\\uB9AC\\uB97C \\uACE0\\uB824\\uD560 \\uC218 \\uC788\\uB2E4. Loki\\uC5D0\\uC11C Log\\uB97C \\uC218\\uC9D1\\uD560 \\uB54C tenant\\uBCC4\\uB85C \\uBB36\\uC5B4\\uC11C \\uC800\\uC7A5\\uD558\\uACE0, query\\uB97C \\uD560 \\uB54C \\uD574\\uB2F9 tenant \\uADF8\\uB8F9\\uC5D0 \\uC18D\\uD55C Log\\uB4E4\\uB9CC \\uAC00\\uC838\\uC62C \\uC218 \\uC788\\uB2E4. \\uADF8\\uB807\\uAC8C \\uD558\\uAE30 \\uC704\\uD574\\uC11C Loki HTTP endpoint \",(0,e.jsx)(n.code,{children:\"/loki/api/v1/push\"}),\"\\uB85C \\uC694\\uCCAD\\uD560 \\uB54C, Header \",(0,e.jsx)(n.code,{children:\"X-Scope-OrgID\"}),\" \\uAC12\\uC5D0 tenant \\uC2DD\\uBCC4\\uC815\\uBCF4\\uB97C \\uB2F4\\uC544\\uC11C \\uBCF4\\uB0B4\\uBA74 \\uB41C\\uB2E4.\"]}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"Grafana Loki is a multi-tenant system; requests and data for tenant A are isolated from tenant B. Requests to the Loki API should include an HTTP header (X-Scope-OrgID) that identifies the tenant for the request.\"})}),(0,e.jsxs)(n.h2,{id:\"loki-multi-tenant-system\",children:[(0,e.jsx)(n.a,{href:\"#loki-multi-tenant-system\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Loki Multi Tenant System\"]}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.code,{children:\"helm chart 5.42.2 \\uBC84\\uC804 \\uAE30\\uC900\"})}),(0,e.jsx)(n.p,{children:\"Loki\\uB97C Monolithic Mode\\uB85C \\uC124\\uCE58\\uD558\\uC5EC \\uD14C\\uC2A4\\uD2B8\\uD55C\\uB2E4.\"}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.code,{children:\"values.yaml\"})}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"global\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"dnsService\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"coredns\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"loki\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"auth_enabled\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean important\",children:\"true\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"commonConfig\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"replication_factor\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"storage\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"type\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'filesystem'\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"singleBinary\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"replicas\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"auth_enabled\"}),\"\\uB97C \",(0,e.jsx)(n.code,{children:\"false\"}),\"\\uB85C \\uC124\\uC815\\uD558\\uBA74, single tanant\\uB97C \\uC0AC\\uC6A9\\uD558\\uAC8C \\uB418\\uACE0, tenant \\uC2DD\\uBCC4\\uBA85\\uC740 \",(0,e.jsx)(n.code,{children:\"fake\"}),\"\\uAC00 \\uB41C\\uB2E4. \",(0,e.jsx)(n.code,{children:\"auth_enabled\"}),\"\\uC758 \\uAE30\\uBCF8\\uAC12\\uC740 \",(0,e.jsx)(n.code,{children:\"true\"}),\"\\uC774\\uC9C0\\uB9CC \\uBA85\\uC2DC\\uC801\\uC73C\\uB85C \\uC124\\uC815\\uD574\\uC8FC\\uC5C8\\uB2E4.\"]}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"Loki defaults to running in multi-tenant mode. Multi-tenant mode is set in the configuration with auth_enabled: true.\"})}),(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.a,{href:\"https://github.com/grafana/loki/blob/main/production/helm/loki/values.yaml\",children:\"Helm chart\\uC758 value\\uAC12\\uC744 \\uD655\\uC778\"}),\"\\uD574\\uBCF4\\uBA74 \\uC544\\uB798\\uC640 \\uAC19\\uC774 \\uC124\\uC815\\uB418\\uC5B4 \\uC788\\uB294 \\uAC83\\uC744 \\uD655\\uC778\\uD560 \\uC218 \\uC788\\uB2E4. Loki\\uC5D0\\uC11C log data\\uB97C \\uC555\\uCD95\\uD574\\uC11C \\uC800\\uC7A5\\uD558\\uAC8C \\uB418\\uB294\\uB370, \\uD574\\uB2F9 chunk \\uD30C\\uC77C\\uB4E4\\uC774 filesystem\\uC758 \\uC544\\uB798 \\uACBD\\uB85C\\uB85C \\uC800\\uC7A5\\uB41C\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"filesystem\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"chunks_directory\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` /var/loki/chunks\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"rules_directory\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` /var/loki/rules\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"\\uC544\\uB798\\uC640 \\uAC19\\uC774 Pod\\uC5D0 \\uC811\\uADFC\\uD558\\uC5EC \\uD574\\uB2F9 \\uACBD\\uB85C\\uB97C \\uD655\\uC778\\uD574\\uBCF4\\uBA74, tenant \\uC774\\uB984\\uBCC4\\uB85C Directory\\uAC00 \\uC0DD\\uAE34 \\uAC83\\uC744 \\uD655\\uC778\\uD560 \\uC218 \\uC788\\uB2E4. \\uB9CC\\uC57D \",(0,e.jsx)(n.code,{children:\"auth_enabled\"}),\"\\uB97C \",(0,e.jsx)(n.code,{children:\"false\"}),\"\\uB85C \\uD588\\uB2E4\\uBA74, \\uC5EC\\uAE30\\uC5D0 \",(0,e.jsx)(n.code,{children:\"fake\"}),\"\\uB77C\\uB294 Directory\\uBA85\\uC73C\\uB85C \\uD30C\\uC77C\\uB4E4\\uC774 \\uC0DD\\uC131\\uB420 \\uAC83\\uC774\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"code-highlight language-bash\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"kubectl \",(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\"exec\"}),` -it loki-0 -- /bin/sh\n`]})})}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"code-highlight language-bash\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"ls\"}),` /var/loki/chunks\n`]})})}),(0,e.jsxs)(n.p,{children:[\"\\uC8FC\\uC758\\uD574\\uC57C\\uD560 \\uC810\\uC740 \",(0,e.jsx)(n.code,{children:\"auth_enabled\"}),\"\\uC740 \",(0,e.jsx)(n.code,{children:\"true\"}),\"\\uB85C \\uC124\\uC815\\uD588\\uAE30 \\uB54C\\uBB38\\uC5D0, Loki\\uC5D0 push \\uC694\\uCCAD\\uC744 \\uD560 \\uB54C \",(0,e.jsx)(n.code,{children:\"X-Scope-OrgID\"}),\" \\uD574\\uB354\\uAC12\\uC774 \\uC5C6\\uC73C\\uBA74 \\uC694\\uCCAD\\uC774 \\uC2E4\\uD328\\uD55C\\uB2E4.\"]}),(0,e.jsxs)(n.h2,{id:\"opentelmetry-loki-exporter-\\uC124\\uC815\",children:[(0,e.jsx)(n.a,{href:\"#opentelmetry-loki-exporter-\\uC124\\uC815\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"OpenTelmetry Loki Exporter \\uC124\\uC815\"]}),(0,e.jsxs)(n.p,{children:[\"OpenTelemetry Collector\\uC758 Exporter\\uB85C Loki\\uC5D0 Log \\uB370\\uC774\\uD130\\uB97C \\uC804\\uB2EC\\uD560 \\uACBD\\uC6B0, \",(0,e.jsx)(n.a,{href:\"https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/exporter/lokiexporter/README.md\",children:\"Loki Exporter \\uBB38\\uC11C\"}),\"\\uC5D0 \\uC124\\uBA85\\uB41C \\uAC83\\uCC98\\uB7FC tenant \\uC815\\uBCF4\\uB97C \\uBCF4\\uB0BC \\uC218 \\uC788\\uB2E4.\"]}),(0,e.jsx)(n.p,{children:\"\\uACE0\\uC815 tenant \\uAC12\\uC744 \\uC0AC\\uC6A9\\uD560 \\uB54C\\uB294 \\uC544\\uB798\\uC640 \\uAC19\\uC774 \\uC804\\uB2EC\\uD560 \\uC218 \\uC788\\uACE0,\"}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"exporters\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"loki\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"endpoint\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" http\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"//localhost\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`3100/loki/api/v1/push\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"headers\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:'\"X-Scope-OrgID\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` staticTenant\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"\\uBCC0\\uC218\\uAC12\\uC744 \\uBCF4\\uB0B4\\uC57C \\uD558\\uBA74 \\uC544\\uB798\\uC640 \\uAC19\\uC774 \",(0,e.jsx)(n.code,{children:\"loki.tenant\"}),\" \\uC18D\\uC131\\uAC12\\uC744 \\uC815\\uC758\\uD560 \\uC218 \\uC788\\uB2E4. \\uC774\\uB807\\uAC8C \",(0,e.jsx)(n.code,{children:\"loki.tenant\"}),\"\\uB97C \\uC124\\uC815\\uD558\\uBA74, \",(0,e.jsx)(n.code,{children:\"X-Scope-OrgID\"}),\" header\\uB85C \\uD574\\uB2F9 \\uAC12\\uC744 \\uC804\\uB2EC\\uD558\\uAC8C \\uB41C\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"processors\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"resource\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"attributes\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"action\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` insert\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"key\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` loki.tenant\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"value\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` host.name\n`]})]})}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.code,{children:\"opentelemetry-collector Helm chart 0.77.0 \\uBC84\\uC804 \\uAE30\\uC900\"})}),(0,e.jsxs)(n.p,{children:[\"opentelemetry-collector Helm chart\\uC758 value\\uC911\\uC5D0 service, processors, exporters\\uB97C \\uC544\\uB798\\uC640 \\uAC19\\uC774 \\uC124\\uC815\\uD560 \\uC218 \\uC788\\uB2E4. \",(0,e.jsx)(n.code,{children:\"loki.tenant\"}),\" \\uC18D\\uC131\\uAC12\\uC5D0 container\\uBA85\\uC744 \\uC124\\uC815\\uD558\\uC600\\uB2E4. \",(0,e.jsxs)(n.a,{href:\"https://github.com/open-telemetry/opentelemetry-collector-contrib/pull/14930\",children:[\"PR\\uC744 \\uBCF4\\uBA74 Loki index\\uB97C \\uC124\\uC815\\uD558\\uB294 \",(0,e.jsx)(n.code,{children:\"loki.attribute.labels\"}),\", \",(0,e.jsx)(n.code,{children:\"loki.resource.labels\"}),\" hint\\uC640 \\uB354\\uBD88\\uC5B4\\uC11C \",(0,e.jsx)(n.code,{children:\"loki.tenant\"}),\"\\uB3C4 hint\\uB85C \\uC0AC\\uC6A9\\uD560\\uC218 \\uC788\\uB3C4\\uB85D \\uCD94\\uAC00\\uB418\\uC5C8\\uB2E4.\"]})]}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"service\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"telemetry\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"logs\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"level\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` info\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"pipelines\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"traces\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"receivers\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` otlp\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"exporters\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` otlp\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"metrics\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"receivers\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` otlp\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"logs\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"receivers\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` filelog\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"processors\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` resource\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` attributes\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"exporters\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` loki\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"processors\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"attributes\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"actions\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"action\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` insert\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"key\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` loki.attribute.labels\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"value\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" level\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" context\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),` traceID\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"action\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` insert\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"key\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` loki.tenant\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"value\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` container\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"resource\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"attributes\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"action\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` insert\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"key\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` loki.format\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"value\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` json\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"action\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` insert\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"key\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` loki.resource.labels\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"value\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" pod\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" namespace\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),` container\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"exporters\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"loki\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"endpoint\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" http\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"//loki\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`3100/loki/api/v1/push\n`]})]})}),(0,e.jsx)(n.p,{children:\"\\uC774\\uB807\\uAC8C \\uC124\\uC815\\uD558\\uACE0 \\uB098\\uBA74, filelog\\uB85C \\uC218\\uC9D1\\uD55C container\\uBA85\\uC774 tenant\\uB85C \\uC124\\uC815\\uB420 \\uC218 \\uC788\\uB2E4.\"}),(0,e.jsxs)(n.h2,{id:\"grafana-datasource-\\uC124\\uC815\",children:[(0,e.jsx)(n.a,{href:\"#grafana-datasource-\\uC124\\uC815\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Grafana Datasource \\uC124\\uC815\"]}),(0,e.jsx)(n.p,{children:\"\\uC774\\uC81C Loki\\uC5D0\\uC11C multi tenant\\uB97C \\uC0AC\\uC6A9\\uD558\\uB3C4\\uB85D \\uC124\\uC815\\uD558\\uC600\\uACE0, Loki\\uC5D0\\uAC8C log data\\uB97C \\uC804\\uB2EC\\uD558\\uB294 OpenTelemetry Collector\\uC5D0\\uC11C Tenant \\uC815\\uBCF4\\uB97C \\uBCF4\\uB0B4\\uB3C4\\uB85D \\uC124\\uC815\\uD558\\uC600\\uB2E4. \\uC774\\uC81C \\uB85C\\uADF8 \\uB370\\uC774\\uD130\\uB97C Query \\uC694\\uCCAD\\uC744 \\uD558\\uB294 Grafana\\uC758 \\uC124\\uC815\\uB3C4 \\uBCC0\\uACBD\\uC774 \\uD544\\uC694\\uD558\\uB2E4.\"}),(0,e.jsxs)(n.p,{children:[\"Log data\\uB97C Push\\uD558\\uB294 \\uAC83 \\uBFD0\\uB9CC \\uC544\\uB2C8\\uB77C, Query \\uC694\\uCCAD\\uD560 \\uB54C\\uB3C4 \",(0,e.jsx)(n.code,{children:\"X-Scope-OrgID\"}),\" \\uD574\\uB354 \\uC815\\uBCF4\\uB97C \\uAC19\\uC774 \\uBCF4\\uB0B4\\uC57C \\uD55C\\uB2E4. \\uD574\\uB2F9 \\uAC12\\uC744 \\uBCF4\\uB0B4\\uC9C0 \\uC54A\\uC73C\\uBA74 Grafana\\uC5D0\\uC11C \\uB85C\\uADF8\\uB97C \\uAC80\\uC0C9\\uD558\\uB824\\uACE0 \\uD560 \\uB54C, \",(0,e.jsx)(n.code,{children:\"no org id\"}),\" \\uC5D0\\uB7EC \\uBA54\\uC138\\uC9C0\\uAC00 \\uB72C\\uB2E4.\"]}),(0,e.jsx)(n.p,{children:\"Datasource\\uB97C \\uC815\\uC758\\uD560 \\uB54C, \\uC544\\uB798\\uC640 \\uAC19\\uC774 Header \\uAC12\\uC744 \\uC124\\uC815\\uD574\\uC11C \\uBCF4\\uB0B4\\uC8FC\\uBA74 \\uB41C\\uB2E4. \\uC5EC\\uAE30 \\uC608\\uC81C\\uC5D0\\uC11C\\uB294 \\uD2B9\\uC815 container\\uC774\\uB984\\uC73C\\uB85C\\uB9CC Query\\uB97C \\uD560 \\uC218 \\uC788\\uAC8C \\uD558\\uC600\\uB2E4.\"}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"datasources.yaml\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"apiVersion\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"datasources\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` Loki\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"type\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` loki\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"isDefault\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean important\",children:\"true\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"access\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` proxy\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"url\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" http\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"//loki\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"3100\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"basicAuth\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean important\",children:\"false\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"secureJsonData\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"httpHeaderValue1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"containerName\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"jsonData\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"httpHeaderName1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"X-Scope-OrgID\"'}),`\n`]})]})}),(0,e.jsxs)(n.h2,{id:\"loki-authentication\",children:[(0,e.jsx)(n.a,{href:\"#loki-authentication\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Loki Authentication\"]}),(0,e.jsxs)(n.p,{children:[\"Grafana datasource\\uC5D0 Loki\\uB97C \\uCD94\\uAC00\\uD558\\uACE0, tenant\\uB85C \\uBB36\\uC5EC \\uC788\\uB294 \\uB85C\\uADF8\\uB4E4\\uC744 \\uBD88\\uB7EC\\uC640\\uC11C \\uBCF4\\uC558\\uB2E4. \\uC774\\uB807\\uAC8C Datasource\\uB97C Helm chart\\uB85C \\uC815\\uC758\\uD574\\uC11C \\uBC30\\uD3EC\\uD588\\uC744 \\uB54C\\uB294 \\uC544\\uB798\\uCC98\\uB7FC UI\\uC5D0\\uC11C \\uC9C1\\uC811 \\uC218\\uC815\\uD560 \\uC218\\uAC00 \\uC5C6\\uB2E4. \\uB530\\uB77C\\uC11C \\uB2E4\\uB978 tenant\\uB97C \\uBCF4\\uB3C4\\uB85D \",(0,e.jsx)(n.code,{children:\"X-Scope-OrgID\"}),\"\\uB97C \\uC218\\uC815\\uD560 \\uC218\\uAC00 \\uC5C6\\uB2E4.\"]}),(0,e.jsx)(\"img\",{src:\"/static/images/loki-multi-tenant-grafana-datasource.png\",alt:\"datasource in grafana settings\"}),(0,e.jsx)(n.p,{children:\"\\uD558\\uC9C0\\uB9CC Grafana\\uC5D0\\uC11C datasource\\uB97C \\uC0C8\\uB86D\\uAC8C \\uB9CC\\uB4E4 \\uC218 \\uC788\\uB294 Admin \\uAD8C\\uD55C\\uC744 \\uAC00\\uC9C0\\uACE0 \\uC788\\uC73C\\uBA74, \\uC0C8\\uB85C\\uC6B4 Loki connection\\uC744 \\uCD94\\uAC00\\uD558\\uC5EC \\uC124\\uC815\\uD560 \\uC218 \\uC788\\uB2E4. Config\\uD30C\\uC77C\\uB85C \\uC815\\uC758\\uD55C Datasource\\uB85C\\uB9CC Log Query\\uB97C \\uD560 \\uC218 \\uC788\\uAC8C \\uC81C\\uD55C\\uD558\\uACE0 \\uC2F6\\uC73C\\uBA74 \\uC5B4\\uB5BB\\uAC8C \\uD574\\uC57C \\uD560\\uAE4C?\"}),(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.a,{href:\"https://grafana.com/docs/loki/latest/operations/authentication/\",children:\"Loki\\uC758 \\uBB38\\uC11C\\uC5D0 \\uC778\\uC99D \\uAD00\\uB828 \\uC124\\uBA85\\uC774 \\uC544\\uB798\\uC640 \\uAC19\\uC774 \\uC788\\uB2E4.\"}),\" Loki\\uC5D0\\uC11C\\uB294 \\uC790\\uCCB4\\uC801\\uC73C\\uB85C \\uC778\\uC99D layer\\uB97C \\uB450\\uACE0 \\uC788\\uC9C0 \\uC54A\\uACE0, Helm chart\\uB85C \\uC124\\uCE58\\uD558\\uAC8C \\uB418\\uBA74 Nginx\\uAC00 gateway\\uB85C \\uC778\\uC99D \\uC5ED\\uD560\\uC744 \\uD574\\uC904 \\uC218 \\uC788\\uB2E4.\"]}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"Grafana Loki does not come with any included authentication layer.\"})}),(0,e.jsxs)(n.p,{children:[\"Loki\\uB97C Helm chart\\uC744 \\uC774\\uC6A9\\uD574 Monolithic mode\\uB85C \\uBC30\\uD3EC\\uB97C \\uD558\\uBA74, \",(0,e.jsx)(n.code,{children:\"loki-gateway-\"}),\" prefix\\uB85C \\uC2DC\\uC791\\uD558\\uB294 pod\\uAC00 \\uC0DD\\uC131\\uB418\\uB294 \\uAC83\\uC744 \\uD655\\uC778\\uD560 \\uC218 \\uC788\\uB2E4. Pod\\uC758 \\uC815\\uBCF4\\uB97C \\uBCF4\\uBA74 \\uC544\\uB798\\uC640 \\uAC19\\uC774 nginx\\uAC00 \\uC124\\uC815\\uB418\\uC5B4 \\uC788\\uB294 \\uAC83\\uC744 \\uD655\\uC778\\uD560 \\uC218 \\uC788\\uB2E4. (\\uBCF4\\uC548\\uC744 \\uC704\\uD574\\uC11C privileged \\uAD8C\\uD55C\\uC774 \\uD544\\uC694\\uC5C6\\uB294 \",(0,e.jsx)(n.code,{children:\"nginx-unpriviledged\"}),\"\\uB97C \\uC0AC\\uC6A9\\uD558\\uACE0 \\uC788\\uB2E4.\\u{1F44D})\"]}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"Containers\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"nginx\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"Container ID\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"   containerd\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`//0bea78d416e7138fe1e6037b5bfc728191c3951a254d21b4f5a278c381708198\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"Image\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"          docker.io/nginxinc/nginx\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\"unprivileged\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"1.24\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`alpine\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"Image ID\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"       docker.io/nginxinc/nginx\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\"unprivileged@sha256\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`7bef7e4c99edc6b53e55396fd181288320cfc422c8e3d0beb588c715f7bdc1b0\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"Port\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`           8080/TCP\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"\\uADF8\\uB9AC\\uACE0 \",(0,e.jsx)(n.code,{children:\"kubectl get configmap loki-gateway -o yaml\"}),\"\\uB97C \\uD655\\uC778\\uD574\\uBCF4\\uBA74 configmap\\uC5D0 nginx \\uC124\\uC815\\uAC12\\uC774 \\uC815\\uC758\\uB41C \\uAC83\\uC744 \\uD655\\uC778\\uD560 \\uC218 \\uC788\\uB2E4.\"]}),(0,e.jsxs)(n.p,{children:[\"\\uC774\\uC81C \\uC6B0\\uB9AC\\uB294 Loki Gateway\\uB97C \\uC0AC\\uC6A9\\uD574\\uC11C \\uC778\\uC99D\\uC744 \\uCD94\\uAC00\\uD558\\uACE0, \\uC778\\uC99D\\uC744 \\uD1B5\\uD574\\uC11C\\uB9CC Loki \\uD574\\uB2F9 tenant \\uAD00\\uB828 Log \\uB370\\uC774\\uD130\\uB97C \\uAC00\\uC838\\uC62C \\uC218 \\uC788\\uAC8C \\uD560 \\uC218 \\uC788\\uB2E4. \\uBA3C\\uC800 Loki Helm chart value\\uC5D0 \\uC544\\uB798\\uC640 \\uAC19\\uC774 \\uCD94\\uAC00\\uD55C\\uB2E4. \",(0,e.jsx)(n.code,{children:\"tenants\"}),\"\\uC5D0 tenant\\uC774\\uB984\\uACFC password\\uB97C \\uC124\\uC815\\uD558\\uACE0, gateway\\uC5D0\\uC11C Basic Authentication\\uC744 \\uD558\\uB3C4\\uB85D \",(0,e.jsx)(n.code,{children:\"basicAuth\"}),\"\\uB97C enabled\\uD55C\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"global\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"dnsService\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"coredns\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"loki\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"auth_enabled\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean important\",children:\"true\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"tenants\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` \n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` containerName\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"password\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` somethingPassword\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"commonConfig\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"replication_factor\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"storage\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"type\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'filesystem'\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"gateway\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"basicAuth\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"enabled\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean important\",children:\"true\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"singleBinary\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"replicas\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"\\uC774\\uB807\\uAC8C \\uC124\\uC815\\uD558\\uBA74 \",(0,e.jsx)(n.code,{children:\"loki-gateway\"}),\" ConfigMap data\\uAC00 \\uC544\\uB798\\uC640 \\uAC19\\uC774 \\uC124\\uC815\\uB41C\\uB2E4. \",(0,e.jsx)(n.code,{children:\"auth_basic_user_file\"}),\"\\uC774 \\uC124\\uC815\\uB418\\uC5B4\\uC11C Basic Authentication\\uC73C\\uB85C \\uC778\\uC99D\\uC744 \\uD558\\uAC8C \\uB418\\uACE0, \",(0,e.jsx)(n.code,{children:\"proxy_set_header X-Scope-OrgID $remote_user;\"}),\" \\uC790\\uB3D9\\uC73C\\uB85C Header\\uAC12\\uC5D0 Basic Authentication\\uC744 \\uD558\\uB294 user\\uBA85\\uC744 \\uB123\\uC5B4\\uC11C \\uBCF4\\uB0B4\\uAC8C \\uB41C\\uB2E4. \\uC6B0\\uB9AC\\uB294 \\uC704\\uC5D0\\uC11C \",(0,e.jsx)(n.code,{children:\"containerName\"}),\" username\\uACFC \",(0,e.jsx)(n.code,{children:\"somethingPassword\"}),\"\\uB85C password\\uB97C \\uC815\\uC758\\uD588\\uACE0, \\uADF8\\uAC83\\uC774 \",(0,e.jsx)(n.code,{children:\"/etc/nginx/secrets/.htpasswd \"}),\"\\uC5D0 \\uC124\\uC815\\uB41C\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-bash\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"nginx.conf: \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"|\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tworker_processes  \",(0,e.jsx)(n.span,{className:\"token number\",children:\"5\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"  \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"## Default: 1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\terror_log  /dev/stderr\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tpid        /tmp/nginx.pid\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tworker_rlimit_nofile \",(0,e.jsx)(n.span,{className:\"token number\",children:\"8192\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tevents \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tworker_connections  \",(0,e.jsx)(n.span,{className:\"token number\",children:\"4096\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"  \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"## Default: 1024\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\thttp \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tclient_body_temp_path /tmp/client_temp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tproxy_temp_path       /tmp/proxy_temp_path\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tfastcgi_temp_path     /tmp/fastcgi_temp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tuwsgi_temp_path       /tmp/uwsgi_temp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tscgi_temp_path        /tmp/scgi_temp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tclient_max_body_size  4M\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tproxy_read_timeout    \",(0,e.jsx)(n.span,{className:\"token number\",children:\"600\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"## 10 minutes\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tproxy_send_timeout    \",(0,e.jsx)(n.span,{className:\"token number\",children:\"600\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tproxy_connect_timeout \",(0,e.jsx)(n.span,{className:\"token number\",children:\"600\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tproxy_http_version    \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1.1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tdefault_type application/octet-stream\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tlog_format   main \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'$remote_addr - $remote_user [$time_local]  $status '\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token string\",children:`'\"$request\" $body_bytes_sent \"$http_referer\" '`}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\t\t\",(0,e.jsx)(n.span,{className:\"token string\",children:`'\"$http_user_agent\" \"$http_x_forwarded_for\"'`}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\taccess_log   /dev/stderr  main\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tsendfile     on\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\ttcp_nopush   on\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tresolver coredns.kube-system.svc.cluster.local.\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tproxy_set_header X-Scope-OrgID \",(0,e.jsx)(n.span,{className:\"token variable\",children:\"$remote_user\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\tserver \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\tlisten             \",(0,e.jsx)(n.span,{className:\"token number\",children:\"8080\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\tlisten             \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"::\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\":8080\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\tauth_basic           \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"Loki\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\tauth_basic_user_file /etc/nginx/secrets/.htpasswd\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"..\"}),`.\\uC0DD\\uB7B5\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"\\uC774\\uB807\\uAC8C \\uC778\\uC99D\\uC744 \\uCD94\\uAC00\\uD588\\uAE30 \\uB54C\\uBB38\\uC5D0 \",(0,e.jsx)(n.code,{children:\"http://loki-gateway\"}),\"\\uB97C \\uD1B5\\uD574\\uC11C \\uC811\\uC18D\\uD560 \\uB54C \\uC544\\uB798\\uCC98\\uB7FC \\uC778\\uC99D \\uAD00\\uB828 \\uC815\\uBCF4\\uB97C \\uB123\\uC5B4\\uC57C \\uD55C\\uB2E4.\"]}),(0,e.jsx)(\"img\",{src:\"/static/images/loki-multi-tenant-grafana-authentication.png\",alt:\"datasource authentication in grafana settings\"}),(0,e.jsx)(n.p,{children:\"\\uC774\\uC81C Network Policy\\uB85C Grafana\\uC5D0\\uC11C \\uC778\\uC99D\\uC774 \\uC5C6\\uB294 Loki Service\\uB85C \\uC811\\uADFC\\uD558\\uC9C0 \\uBABB\\uD558\\uB3C4\\uB85D \\uB9C9\\uACE0, Loki Gateway\\uB97C \\uD1B5\\uD574\\uC11C \\uC811\\uADFC\\uD558\\uB3C4\\uB85D \\uD55C\\uB2E4. \\uADF8\\uB7EC\\uBA74 \\uD574\\uB2F9 tenant\\uC758 \\uC778\\uC99D \\uC815\\uBCF4\\uB97C \\uC54C\\uC9C0\\uBABB\\uD558\\uBA74 \\uC5F0\\uACB0\\uD560 \\uC218\\uAC00 \\uC5C6\\uB2E4. \\uB530\\uB77C\\uC11C Grafana\\uC5D0\\uC11C Admin \\uAD8C\\uD55C\\uC774 \\uC788\\uB354\\uB77C\\uB3C4 \\uC0C8\\uB85C\\uC6B4 connection\\uC744 \\uCD94\\uAC00\\uD574\\uC11C \\uB2E4\\uB978 tenant\\uC758 log\\uC5D0 \\uC811\\uADFC\\uD558\\uB294 \\uAC83\\uC744 \\uB9C9\\uC744 \\uC218 \\uC788\\uB2E4.\"}),(0,e.jsxs)(n.h2,{id:\"\\uACB0\\uB860\",children:[(0,e.jsx)(n.a,{href:\"#\\uACB0\\uB860\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\uACB0\\uB860\"]}),(0,e.jsx)(n.p,{children:\"Loki\\uB97C \\uD1B5\\uD574\\uC11C Log \\uB370\\uC774\\uD130\\uB97C \\uC218\\uC9D1\\uD558\\uACE0 Query\\uD560 \\uB54C, \\uC0AC\\uC6A9\\uC790\\uC5D0 \\uB530\\uB77C\\uC11C \\uC5B4\\uB5A4 \\uB85C\\uADF8\\uC5D0 \\uC811\\uADFC\\uD560 \\uC218 \\uC788\\uB294\\uC9C0 \\uC81C\\uD55C\\uD558\\uACE0 \\uC2F6\\uC5C8\\uB2E4. Grafana\\uC758 Label-based access control\\uB97C \\uD1B5\\uD574\\uC11C \\uADF8 \\uBAA9\\uC801\\uC744 \\uB2EC\\uC131\\uD560 \\uC218 \\uC788\\uC744 \\uAC83 \\uAC19\\uC558\\uC9C0\\uB9CC, \\uD574\\uB2F9 \\uAE30\\uB2A5\\uC740 Grafana Enterprise \\uBC84\\uC804\\uC5D0\\uC11C\\uB9CC \\uC81C\\uACF5\\uD55C\\uB2E4. \\uB530\\uB77C\\uC11C Loki\\uC758 multi tenant mode\\uB97C \\uD1B5\\uD574\\uC11C log group\\uB97C \\uBD84\\uB9AC\\uD558\\uACE0, Query\\uD560 \\uB54C \\uD574\\uB2F9 log group\\uB9CC \\uD560 \\uC218 \\uC788\\uB3C4\\uB85D \\uD558\\uC600\\uB2E4. \\uADF8\\uB9AC\\uACE0 Nginx\\uC5D0\\uC11C \\uC778\\uC99D\\uC744 \\uD558\\uC5EC \\uD574\\uB2F9 tenant\\uC758 log group\\uC5D0 \\uC811\\uADFC\\uD560 \\uC218 \\uC788\\uB3C4\\uB85D \\uD558\\uC600\\uB2E4.\"})]})}}var f=b;return _;})();\n;return Component;","toc":[{"value":"Application Log를 분리","url":"#application-log를-분리","depth":2},{"value":"Loki Multi Tenant System","url":"#loki-multi-tenant-system","depth":2},{"value":"OpenTelmetry Loki Exporter 설정","url":"#opentelmetry-loki-exporter-설정","depth":2},{"value":"Grafana Datasource 설정","url":"#grafana-datasource-설정","depth":2},{"value":"Loki Authentication","url":"#loki-authentication","depth":2},{"value":"결론","url":"#결론","depth":2}],"frontMatter":{"readingTime":{"text":"9 min read","minutes":8.375,"time":502500,"words":1675},"slug":"20240420-loki-multi-tenants","fileName":"20240420-loki-multi-tenants.md","title":"Loki multi-tenants","date":"2024-04-20T00:00:00.000Z","tags":["kubernetes"],"images":["/static/images/social-banner.png"],"summary":"Loki로 Log를 수집하고, Grafana로 Log를 보여줄 때 Grafana user별로 볼 수 있는 Log를 제한하고 싶었다. Grafana Enterpirse의 경우에는 Label-based access control을 제공하여, Loki label별로 Query할 수 있는 권한을 제한할 수 있는 것처럼 보인다. 하지만 아쉽게 오픈소스에서는 해당 기능을 제공하지 않는다. 그래서 Loki multi tenant를 통해서 Log를 tenent별로 그룹핑하고, tenant별로 query하는 방법을 사용했다. 그리고 Loki는 인증 layer가 존재하지 않기 때문에 Nginx를 통해서 인증을 하여 query할 수 있도록 하였다. 마지막으로 Network Policy로 Nginx 인증을 통해서 Loki에 접근하도록 강제하여 원하는 구성을 할 수 있었다."}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.15,"time":9000,"words":30},"slug":["default"],"fileName":"default.md","name":"Jay","avatar":"profile.png","occupation":"Software Engineer","date":null}],"prev":{"title":"책 \"다른 몸들을 위한 디자인\"을 읽고...","date":"2024-03-24T00:00:00.000Z","tags":["Book"],"images":["/static/images/social-banner.png"],"summary":"내가 일상 생활에서 장애를 직접 경험하지 않기 때문에 장애인이 경험하는 우리의 사회에 대해서 진지하게 고민할 기회가 많지 않았다. 봉사활동과 여러가지 프로젝트 참여를 통해서 장애인에 대한 여러가지 생각을 했지만, 내 삶에서 당장 중요한 문제가 아니다보니 일시적인 생각으로만 끝났다. 이 책을 읽으면서 느낀 점이나 생각들도 반복된 일상속에서 그냥 증발해버릴 것 같다는 생각이 들었다. 하지만 이러한 작은 관심과 생각들이 나의 무의식에 있던 사고들에 변화를 조금씩 가져오고, 그것이 쌓여서 나중에는 내가 무언가 사회에 조금이나마 영향을 미칠 수 있는 역할을 할 수 있지 않을까? 조금은 긍정적인 마음으로 독후감을 작성해보았다.","slug":"20240324-book-review-what-can-a-body-do"},"next":{"title":"Kubelet imageGC","date":"2024-04-20T00:00:00.000Z","tags":["kubernetes","ncloud"],"images":["/static/images/social-banner.png"],"summary":"사이즈가 큰 컨테이너 이미지를 내려받기 위해서 Containerd의 설정값 root을 새로운 스토리지를 추가한 경로로 수정하였다. Kubelet은 imageGCHighThresholdPercent로 설정된 임계치보다 disk 사용량이 많으면, 컨테이너 이미지를 정리하여 disk 공간을 확보하려고 한다. imageGCHighThresholdPercent이 기본값으로 85로 설정되어 있고, disk의 85 퍼센트 이상 사용했을 때 정리 프로세스가 실행된다. 문제는 Containerd root 경로의 volume이 거의 꽉 차더라도, 전체 volume의 사용량은 85 퍼센트가 되지 않을 수 있다는 것이다. Containerd root 경로의 volume에 여유가 없어서 새로 스케쥴된 Pod의 컨테이너 이미지를 내려 받지 못하는 문제가 발생할 수 있다. imageGCHighThresholdPercent 설정값을 조절하여 이 문제를 해결할 수 있다.","slug":"20240420-kubelet-imagegc"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["20240420-loki-multi-tenants"]},"buildId":"U7DE318orb_de6hUgWFnv","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>