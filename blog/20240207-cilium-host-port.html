<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><link rel="manifest" href="/jayground8/static/favicons/manifest.json"/><link rel="manifest" href="/jayground8/static/favicons/site.webmanifest"/><link rel="shortcut icon" href="/jayground8/static/favicons/favicon.ico"/><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8773084925406986" crossorigin="anonymous"></script><title>Cilium CNI와 HostPort</title><meta name="robots" content="follow, index"/><meta name="description" content="네이버 클라우드 쿠버네티스 서비스에서 HostPort를 설정하였는데, 정상적으로 Node Port를 통해서 Container에 접근할 수가 없었다. 처음에는 CNI plugin portmap을 설정하여 HostPort를 Iptables Rule로 적용하도록 하였다. 하지만 현재 운영하는 Kernel 버전이 kube proxy를 대체할 수 있는 것을 파악하였고, default로 설정된 KubeProxyReplacement=disabled을 KubeProxyReplacement=strict으로 설정하여 Cilium eBPF로 대체하여 사용하였다."/><meta property="og:url" content="https://jayground8.github.io/blog/20240207-cilium-host-port"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Jayground8"/><meta property="og:description" content="네이버 클라우드 쿠버네티스 서비스에서 HostPort를 설정하였는데, 정상적으로 Node Port를 통해서 Container에 접근할 수가 없었다. 처음에는 CNI plugin portmap을 설정하여 HostPort를 Iptables Rule로 적용하도록 하였다. 하지만 현재 운영하는 Kernel 버전이 kube proxy를 대체할 수 있는 것을 파악하였고, default로 설정된 KubeProxyReplacement=disabled을 KubeProxyReplacement=strict으로 설정하여 Cilium eBPF로 대체하여 사용하였다."/><meta property="og:title" content="Cilium CNI와 HostPort"/><meta property="og:image" content="https://jayground8.github.io/static/images/social-banner.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site"/><meta name="twitter:title" content="Cilium CNI와 HostPort"/><meta name="twitter:description" content="네이버 클라우드 쿠버네티스 서비스에서 HostPort를 설정하였는데, 정상적으로 Node Port를 통해서 Container에 접근할 수가 없었다. 처음에는 CNI plugin portmap을 설정하여 HostPort를 Iptables Rule로 적용하도록 하였다. 하지만 현재 운영하는 Kernel 버전이 kube proxy를 대체할 수 있는 것을 파악하였고, default로 설정된 KubeProxyReplacement=disabled을 KubeProxyReplacement=strict으로 설정하여 Cilium eBPF로 대체하여 사용하였다."/><meta name="twitter:image" content="https://jayground8.github.io/static/images/social-banner.png"/><link rel="canonical" href="https://jayground8.github.io/blog/20240207-cilium-host-port"/><meta property="article:published_time" content="2024-02-07T00:00:00.000Z"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jayground8.github.io/blog/20240207-cilium-host-port"
  },
  "headline": "Cilium CNI와 HostPort",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://jayground8.github.io/static/images/social-banner.png"
    }
  ],
  "datePublished": "2024-02-07T00:00:00.000Z",
  "dateModified": "2024-02-07T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Jay"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Jay",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jayground8.github.ioplayground.png"
    }
  },
  "description": "네이버 클라우드 쿠버네티스 서비스에서 HostPort를 설정하였는데, 정상적으로 Node Port를 통해서 Container에 접근할 수가 없었다. 처음에는 CNI plugin portmap을 설정하여 HostPort를 Iptables Rule로 적용하도록 하였다. 하지만 현재 운영하는 Kernel 버전이 kube proxy를 대체할 수 있는 것을 파악하였고, default로 설정된 KubeProxyReplacement=disabled을 KubeProxyReplacement=strict으로 설정하여 Cilium eBPF로 대체하여 사용하였다."
}</script><meta name="next-head-count" content="24"/><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preload" href="/_next/static/css/414f98a58444a4f1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/414f98a58444a4f1.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-690364db8bfb1f01.js" defer=""></script><script src="/_next/static/chunks/main-eea1c213342d95c3.js" defer=""></script><script src="/_next/static/chunks/pages/_app-df5d505270329fd9.js" defer=""></script><script src="/_next/static/chunks/675-70b09cbf0a5309ea.js" defer=""></script><script src="/_next/static/chunks/410-35c4fb535edd9439.js" defer=""></script><script src="/_next/static/chunks/712-376d32740a4ac813.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-8ab66ff6ebabec4c.js" defer=""></script><script src="/_next/static/ey5ly7YBUIi0sFNRIGYkn/_buildManifest.js" defer=""></script><script src="/_next/static/ey5ly7YBUIi0sFNRIGYkn/_ssgManifest.js" defer=""></script><script src="/_next/static/ey5ly7YBUIi0sFNRIGYkn/_middlewareManifest.js" defer=""></script></head><body class="bg-white text-black antialiased dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex h-screen flex-col justify-between"><header class="flex items-center justify-between py-10"><div><a aria-label="Jayground8" href="/"><div class="flex items-center justify-between"><div class="mr-3"><svg xmlns="http://www.w3.org/2000/svg" width="53.87" height="43.61" viewBox="0 0 512 512" class="fill-black dark:fill-white"><path d="M368.4 17c-8.8 1.3-18.3 5-25.3 9.9-3.8 2.5-22.6 16.1-41.9 30.1-37.1 26.9-38.6 28.3-36.3 33.9 1.7 4 4.9 5.1 14.6 5.1h8.5v128h-17.9c-18.2 0-22.2.6-27.3 4.2l-2.8 1.9V116.9l2.5-2.4c1.5-1.6 3.6-2.5 5.5-2.5s4 .9 5.5 2.5l2.5 2.4v42c0 29.1.3 42.8 1.1 44.5 2.6 5.7 11.5 5.5 13.9-.3.7-1.9 1-15.6.8-46.2-.3-40.1-.4-43.7-2.2-46.9-4.8-9-11.9-13.4-21.6-13.4-13.8 0-22.8 9.1-23.8 24.1l-.5 7.3h-31.5l-1.2-2.9c-1.6-3.9-6-5.8-9.9-4.1-1.6.6-3.5 2.5-4.1 4.1l-1.2 2.9h-63.6l-1.2-2.9c-2.5-6.2-11.5-6.2-14 0l-1.2 2.9H64.3l-.5-7.3c-1-15-10-24.1-23.8-24.1-9.7 0-16.8 4.4-21.6 13.4-1.8 3.3-1.9 7.5-2.2 75-.2 50 .1 72.3.8 74.1 2.1 5.1 8.6 6.3 12.5 2.4l2.5-2.4V116.9l2.5-2.4c3.2-3.3 7.8-3.3 11 0l2.5 2.4V448H32V284.9l-2.5-2.4c-3.8-3.9-10.2-2.7-12.4 2.2-1.6 3.4-1.6 171.2 0 174.6.6 1.4 2.2 3 3.6 3.6 1.6.7 15.6 1.1 43.7 1.1 38 0 41.5-.1 43.4-1.8 1.2-.9 33.4-50.5 71.7-110.2 38.3-59.7 70.5-109.3 71.7-110.3 1.8-1.5 4.3-1.7 19.4-1.7H288v16h-12.5c-13.1 0-16.6.8-18.3 4.4-2 4.5-138.5 216.2-140.4 217.9-1.9 1.6-5.6 1.7-47.9 1.7-31.9 0-46.6.3-48.3 1.1-5.7 2.6-5.5 11.5.3 13.9 1.9.7 16.7 1 50.1.8 46.4-.3 47.6-.3 51.5-2.5 2.2-1.1 5.1-3.3 6.5-4.7 1.3-1.5 10.1-14.7 19.6-29.4l17.1-26.7 18.4-.5c10.1-.3 19.1-.9 20-1.3.9-.5 2.1-1.9 2.8-3.3 1.5-3.4 1.5-35.4 0-38.8-1.1-2.3-4-4-8-4.8-1.3-.2 1.5-5.2 11.5-20.7l13.1-20.5.5 56.5c.3 31 .9 57.1 1.3 58 1.5 3 5.6 3.9 18.2 3.9H256v14c0 14.9.7 18.1 4.7 19.9 1.7.8 34.7 1.1 115.3 1.1s113.6-.3 115.3-1.1c1.4-.6 3-2.2 3.6-3.6 1.5-3.4 1.5-83.2 0-86.6-2.2-4.9-8.6-6.1-12.4-2.2l-2.5 2.4V480H272V272h208v107.1l2.5 2.4c3.8 3.9 10.2 2.7 12.4-2.2 1.5-3.4 1.5-115.2 0-118.6-1.8-3.9-5-4.7-18.4-4.7H464v-40.5c0-27.9-.3-41.2-1.1-42.9-2.6-5.5-11.2-5.5-13.8 0-.8 1.7-1.1 15-1.1 42.9V256h-24v-34.5c0-21.3-.4-36.4-1.1-39.7-3.6-17.3-19.3-32.9-36.7-36.7-16.2-3.4-31.4 1.1-43.3 12.9-7.4 7.3-11.2 13.9-13.4 23.2-1.8 7.9-2.1 50.3-.4 54.2 1.6 3.5 6.1 5.2 9.8 3.7 4.7-2 5.1-4.2 5.1-29.6 0-21.5.2-23.9 2.2-29.2C350.6 168.4 363 160 376 160s25.4 8.4 29.8 20.3c2.1 5.5 2.2 7.4 2.2 40.7v35H304V96h144v24.5c0 16 .4 25.3 1.1 26.9 2.6 5.5 11.2 5.5 13.8 0 .7-1.6 1.1-10.9 1.1-26.9V96h8.5c9.7 0 12.9-1.1 14.6-5.1 2.1-5.2.1-7.5-17.7-20.4C446.2 53.8 445 53 442.1 53c-4.1.1-7.5 3.5-7.5 7.7 0 4 2.2 6.3 14.8 15.3l4.8 3.5-39.1.3c-21.5.1-56.7.1-78.2 0l-39.1-.3 14.9-10.7c8.2-5.9 20.7-15.1 27.8-20.4 14.5-10.8 20.5-14 29.4-15.5 11.6-2.1 22.4 1.3 36.5 11.4 4.3 3.1 9 5.7 10.3 5.7 3.9 0 7.5-4.4 7.1-8.7-.3-3.3-1.1-4.4-7.8-9.6-15.3-11.8-32.3-17.1-47.6-14.7zM96 152v8H64v-16h32v8zm80 0v8h-64v-16h64v8zm48 0v8h-32v-16h32v8zM96 280v104h-4.5c-5.5 0-9 1.5-10.4 4.7-1.5 3.3-1.5 35.4 0 38.7 1.7 3.6 3.1 4 16.2 4.6l11.9.5-5.1 7.7L99 448H64V176h32v104zm80-27.8v76.3l-17.8 27.7-17.7 27.7-14.2.1H112V176h64v76.2zm48-37.3v38.9l-15.6 24.4c-8.6 13.3-15.8 24.5-16 24.7-.2.2-.4-28.2-.4-63.2V176h32v38.9zM256 369v76h-16V317.1l7.8-12c4.2-6.7 7.8-12.1 8-12.1.1 0 .2 34.2.2 76zm-129.1 34.7c-1.2 2.1-3.6 5.7-5.1 8l-2.9 4.3H96v-16h33.2l-2.3 3.7zM192 408v8h-15.1l3.7-5.8c2-3.1 4.4-6.7 5.2-8 .8-1.2 2.4-2.2 3.8-2.2 2.3 0 2.4.2 2.4 8z"></path><path d="M322.5 114.5c-1.6 1.5-2.5 3.6-2.5 5.5s.9 4 2.5 5.5c1.5 1.6 3.6 2.5 5.5 2.5s4-.9 5.5-2.5c1.6-1.5 2.5-3.6 2.5-5.5s-.9-4-2.5-5.5c-1.5-1.6-3.6-2.5-5.5-2.5s-4 .9-5.5 2.5zM418.5 114.5c-1.6 1.5-2.5 3.6-2.5 5.5s.9 4 2.5 5.5c1.5 1.6 3.6 2.5 5.5 2.5s4-.9 5.5-2.5c1.6-1.5 2.5-3.6 2.5-5.5s-.9-4-2.5-5.5c-1.5-1.6-3.6-2.5-5.5-2.5s-4 .9-5.5 2.5zM290.2 290.3c-5 5.3-1.3 13.7 5.9 13.7 4.7 0 7.9-3.4 7.9-8.1 0-7.1-9-10.7-13.8-5.6zM450.5 290.5c-5 4.9-1.5 13.5 5.5 13.5 4.1 0 8-3.9 8-8s-3.9-8-8-8c-1.9 0-4 .9-5.5 2.5zM358.1 322c-8.3 2.2-16.5 5.7-19.8 8.6-3.3 2.8-3.9 7.3-1.4 10.6 3.3 4.1 6.4 4.3 13.8.8 23.3-10.9 47.3-7 64.8 10.5 11.5 11.4 16.5 23.6 16.5 39.7 0 15.9-5.1 28.1-16.4 39.4C404.2 443 392.1 448 376 448s-28.1-5-39.5-16.5c-11-11.1-16.5-24.2-16.5-39.5.1-9.5 1.2-14.5 5.6-24.3 3.8-8.3 3.8-10.4.1-14.5-4.7-5.1-10.8-1.7-15.4 8.6-8.6 19.5-8.4 42.7.6 61.7 9.1 19.3 28.3 34.5 49.5 39 11.9 2.6 28.4 1.7 39.3-2.2 23.9-8.6 41.3-27.9 46.9-51.9 1.9-8.5 1.9-24.4-.1-33.1-5.9-25.5-26.7-46.6-52.5-53.3-10.1-2.6-25.8-2.6-35.9 0zM290.2 450.3c-5 5.3-1.3 13.7 5.9 13.7 4.7 0 7.9-3.4 7.9-8.1 0-7.1-9-10.7-13.8-5.6zM450.2 450.3c-5 5.3-1.3 13.7 5.9 13.7 4.7 0 7.9-3.4 7.9-8.1 0-7.1-9-10.7-13.8-5.6z"></path></svg></div><div class="hidden h-6 text-2xl font-semibold sm:block">Jayground8</div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/blog">블로그</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/tags">Tags</a></div><button aria-label="Toggle Dark Mode" type="button" class="ml-1 mr-1 h-8 w-8 rounded p-1 sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="ml-1 mr-1 h-8 w-8 rounded py-1" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed top-0 left-0 z-10 h-full w-full transform bg-gray-200 opacity-95 duration-300 ease-in-out dark:bg-gray-800 translate-x-full"><div class="flex justify-end"><button type="button" class="mr-5 mt-11 h-8 w-8 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><nav class="fixed mt-8 h-full"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog">블로그</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div></nav></div></div></div></header><main class="mb-auto"><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="fixed right-8 bottom-8 hidden flex-col gap-3 md:hidden"><button aria-label="Scroll To Comment" type="button" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg></button><button aria-label="Scroll To Top" type="button" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2024-02-07T00:00:00.000Z">2024년 2월 7일 수요일</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Cilium CNI와 HostPort</h1></div></div></header><div class="divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6 xl:divide-y-0" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:border-b xl:border-gray-200 xl:pt-11 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 sm:space-x-12 xl:block xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2738%27%20height=%2738%27/%3e"/></span><img alt="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="h-10 w-10 rounded-full" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="avatar" srcSet="https://jayground8.github.io/static/images/profile.png?w=48&amp;q=75 1x, https://jayground8.github.io/static/images/profile.png?w=96&amp;q=75 2x" src="https://jayground8.github.io/static/images/profile.png?w=96&amp;q=75" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="h-10 w-10 rounded-full" loading="lazy"/></noscript></span><dl class="whitespace-nowrap text-sm font-medium leading-5"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Jay</dd><dt class="sr-only">Twitter</dt><dd></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="prose max-w-none pt-10 pb-8 dark:prose-dark"><h2 id="테스트-환경"><a href="#테스트-환경" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>테스트 환경</h2><ul><li>네이버 클라우드 쿠버네티스 서비스 버전: 1.26</li><li>Cilium 버전: 1.10.16</li><li>커널 버전: 5.4.0-163-generic</li></ul><h2 id="이슈-사항"><a href="#이슈-사항" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>이슈 사항</h2><p>OpenTelemetry collector를 DaemonSet으로 설치를 하였다. 그리고 Web server가 돌고 있는 Pod가 Trace 정보를 Collector에 보내고자 했다. OpenTelemetry Collector가 HostPort로 설정이 되어 있었고, Pod는 이 HostPort로 연결을 시도했다.</p><p><code>opentelemetry collector 설정</code></p><div class="relative"><pre><code class="code-highlight language-yaml"><span class="code-line"><span class="token atrule key">Ports</span><span class="token punctuation">:</span> 4317/TCP<span class="token punctuation">,</span> 4318/TCP
</span><span class="code-line"><span class="token atrule key">Host Ports</span><span class="token punctuation">:</span> 4317/TCP<span class="token punctuation">,</span> 4318/TCP
</span></code></pre></div><p><code>Web server가 돌고 있는 Pod의 Deployment 설정</code></p><div class="relative"><pre><code class="code-highlight language-yaml"><span class="code-line"><span class="token punctuation">-</span> <span class="token atrule key">name</span><span class="token punctuation">:</span> NODE_IP
</span><span class="code-line">    <span class="token atrule key">valueFrom</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">fieldRef</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token atrule key">fieldPath</span><span class="token punctuation">:</span> status.hostIP
</span></code></pre></div><p><code>OpenTelemetry SDK를 통해서 Trace를 전송</code></p><div class="relative"><pre><code class="code-highlight language-js"><span class="code-line">traceExporter<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">OTLPTraceExporter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">  url<span class="token operator">:</span> <span class="token template-string"><span class="token string template-punctuation">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token punctuation interpolation-punctuation">${</span>process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_IP</span><span class="token punctuation interpolation-punctuation">}</span></span><span class="token string">:4318/v1/traces</span><span class="token string template-punctuation">`</span></span><span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span></code></pre></div><p>하지만 OpenTelemetry Collector가 정상적으로 실행되고 있었지만, Node에서 해당 collector로 연결하지 못하고 Connection refused가 발생하였다. 네이버 클라우드 쿠버네티스에서 Cilium이 CNI로 설정이 되어 있었고, 아래와 같이 cilium cli를 통해서 service 목록을 확인하였다. 하지만 <code>HostPort</code> Service Type은 목록에서 보이지 않았다.</p><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">kubectl <span class="token class-name builtin">exec</span> -it cilium-4d93a -n kube-system -- cilium <span class="token function">service</span> list
</span></code></pre></div><h2 id="hostport"><a href="#hostport" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>HostPort</h2><p>Kubernetes에서 아래와 같이 <code>HostPort</code>를 설정하면, Pod가 Node의 Port에서 listening할 수 있다. 아래의 경우는 Node의 8080 Port에 요청하면 Container의 80 Port에 연결할 수 있다. 일반적으로 Iptable의 nat table에 Rule들이 생성되어 이렇게 작동된다.</p><div class="relative"><pre><code class="code-highlight language-yaml"><span class="code-line"><span class="token atrule key">apiVersion</span><span class="token punctuation">:</span> apps/v1
</span><span class="code-line"><span class="token atrule key">kind</span><span class="token punctuation">:</span> Deployment
</span><span class="code-line"><span class="token atrule key">metadata</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
</span><span class="code-line"><span class="token atrule key">spec</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">selector</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">matchLabels</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">run</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
</span><span class="code-line">  <span class="token atrule key">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
</span><span class="code-line">  <span class="token atrule key">template</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">metadata</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">labels</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token atrule key">run</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
</span><span class="code-line">    <span class="token atrule key">spec</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">containers</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token punctuation">-</span> <span class="token atrule key">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
</span><span class="code-line">          <span class="token atrule key">image</span><span class="token punctuation">:</span> nginx
</span><span class="code-line">          <span class="token atrule key">ports</span><span class="token punctuation">:</span>
</span><span class="code-line">            <span class="token punctuation">-</span> <span class="token atrule key">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</span><span class="code-line">              <span class="token atrule key">hostPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</span></code></pre></div><h2 id="hostport-with-ciliums-ebpf"><a href="#hostport-with-ciliums-ebpf" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>HostPort with Cilium&#x27;s eBPF</h2><p>Cilium은 eBPF로 Kube Proxy를 대체할 수 있다. <a target="_blank" rel="noopener noreferrer" href="https://docs.cilium.io/en/v1.11/operations/system_requirements/">Cilium v1.11의 문서</a>를 보면, kube proxy를 대체하기 위해서 kernel version이 5.2이상에서 가능하다. 테스트하는 환경은 커널 버전이 5.4이상이니깐 cilium이 eBPF로 kube proxy를 대체할 수 있다.</p><img src="/static/images/cilium-required-kernel-version-1.11.png" alt="cilium required kernel version"/><p>BPF-based host routing은 kernel version 5.10 이상이어야 하는데, 따라서 해당 설정은 cilium agent log를 확인해보면 아래처럼 5.10이 아니라서 <code>enable-host-legacy-routing</code>이 자동으로 true로 셋팅되는 것을 확인할 수 있다.</p><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line"><span class="token assign-left variable">level</span><span class="token operator">=</span>info
</span><span class="code-line"><span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;BPF host routing requires kernel 5.10 or newer. Falling back to legacy host routing (enable-host-legacy-routing=true).&quot;</span>
</span><span class="code-line"><span class="token assign-left variable">subsys</span><span class="token operator">=</span>daemon
</span></code></pre></div><p>Helm chart로 Cilium을 설치하면 <code>cilium-config</code>가 ConfigMap object로 생성되는데, <a target="_blank" rel="noopener noreferrer" href="https://github.com/cilium/cilium/blob/v1.10.16/install/kubernetes/cilium/templates/cilium-configmap.yaml">ConfigMap의 값으로 Cilium의 설정이 결정된다.</a>. 여기서 관심있게 봐야할 설정값은 <code>kube-proxy-relacement</code>이다.</p><p><a target="_blank" rel="noopener noreferrer" href="https://docs.cilium.io/en/v1.11/gettingstarted/kubeproxy-free/#kube-proxy-hybrid-modes">cilium v1.11에서 kubeProxyReplacement을 아래와 같이 네 가지중에 하나로 설정할 수 있다.</a></p><ul><li>strict: eBPF로 다 대체</li><li>probe: 대체할 수 있는것만 eBPF로 대체하고 나머지는 kube proxy랑 같이 공존</li><li>partial: 원하는 부분만 enable해서 eBPF로 대체</li><li>disabled</li></ul><p>그런데 네이버 클라우드 쿠버네티스 서비스의 <code>cilium-config</code>의 <code>kube-proxy-replacement</code>가 기본으로 disabled로 되어 있었다.</p><blockquote><p>kubeProxyReplacement=disabled: This option disables any Kubernetes service handling by fully relying on kube-proxy instead, except for ClusterIP services accessed from pods (pre-v1.6 behavior).</p></blockquote><p><code>cilium status</code> CLI 명령어로 확인을 하면, HostPort가 Disabled로 나온다.</p><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ kubectl <span class="token class-name builtin">exec</span> -it cilium-4d93a -n kube-system -- cilium status --verbose
</span><span class="code-line"><span class="token punctuation">..</span>.생략
</span><span class="code-line">KubeProxyReplacement Details:
</span><span class="code-line">  Services:
</span><span class="code-line">    - ClusterIP:      Enabled
</span><span class="code-line">    - NodePort:       Disabled
</span><span class="code-line">    - LoadBalancer:   Disabled
</span><span class="code-line">    - externalIPs:    Disabled
</span><span class="code-line">    - HostPort:       Disabled
</span></code></pre></div><h2 id="cni-plugin-portmap"><a href="#cni-plugin-portmap" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>CNI plugin portmap</h2><p>처음에 <code>partial</code> 설정으로 <code>HostPort</code>만 Enabled을 해볼려고 하는데 안되었다. 그래서 eBPF로 HostPort가 대체되지 못하는 줄 알았다. 그렇게 또 한번 쓸데 없는 삽질을 하게 되었다.🥹 <code>KubeProxyReplacement</code>를 <code>disabld</code>로 유지하고, <a target="_blank" rel="noopener noreferrer" href="https://docs.cilium.io/en/latest/installation/cni-chaining-portmap/#portmap-hostport">CNI chaining으로 PortMap을 사용</a>하는 방법을 적용했다.</p><p><code>cilium-config</code> ConfigMap에서 <code>cni-chaining-mode</code>를 아래와 같이 설정하고, Opentelemetry Collector를 restart한다.</p><div class="relative"><pre><code class="code-highlight language-yml"><span class="code-line"><span class="token atrule key">apiVersion</span><span class="token punctuation">:</span> v1
</span><span class="code-line"><span class="token atrule key">kind</span><span class="token punctuation">:</span> ConfigMap
</span><span class="code-line"><span class="token punctuation">...</span>
</span><span class="code-line"><span class="token atrule key">data</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token punctuation">...</span>생략
</span><span class="code-line">  <span class="token atrule key">cni-chaining-mode</span><span class="token punctuation">:</span> portmap
</span></code></pre></div><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">kubectl rollout restart daemonset/cilium -n kube-system
</span></code></pre></div><p>이렇게 적용하고 나면 <code>/etc/cni/net.d/05-cilium.conflist</code>에 cni 설정 파일이 아래와 같이 생성된다. <code>portmap</code>이 plugin에 추가된 것을 확인 할 수 있다.</p><div class="relative"><pre><code class="code-highlight language-json"><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token property">&quot;cniVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.3.1&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;portmap&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cilium&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cilium-cni&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">      <span class="token property">&quot;enable-debug&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;portmap&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">      <span class="token property">&quot;capabilities&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;portMappings&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token punctuation">]</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>이제 다시 HostPort가 설정된 Deployment Object을 생성한다.</p><div class="relative"><pre><code class="code-highlight language-yaml"><span class="code-line"><span class="token atrule key">apiVersion</span><span class="token punctuation">:</span> v1
</span><span class="code-line"><span class="token atrule key">kind</span><span class="token punctuation">:</span> Deployment
</span><span class="code-line"><span class="token atrule key">metadata</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
</span><span class="code-line"><span class="token atrule key">spec</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">selector</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">matchLabels</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">run</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
</span><span class="code-line">  <span class="token atrule key">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
</span><span class="code-line">  <span class="token atrule key">template</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">metadata</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">labels</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token atrule key">run</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
</span><span class="code-line">    <span class="token atrule key">spec</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">containers</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token punctuation">-</span> <span class="token atrule key">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
</span><span class="code-line">          <span class="token atrule key">image</span><span class="token punctuation">:</span> nginx
</span><span class="code-line">          <span class="token atrule key">ports</span><span class="token punctuation">:</span>
</span><span class="code-line">            <span class="token punctuation">-</span> <span class="token atrule key">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</span><span class="code-line">              <span class="token atrule key">hostPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</span></code></pre></div><p>이번에는 아래와 같이 cni plugin <code>portmap</code> binary 파일이 없어서 Pod가 정상적으로 실행되지 못 했다.</p><div class="relative"><pre><code class="code-highlight language-log"><span class="code-line"><span class="token property">error killing pod:</span> failed to <span class="token string">&quot;KillPodSandbox&quot;</span> for <span class="token string">&quot;1055faa0-7449-49ba-9e25-b6e46de342b1&quot;</span> <span class="token property">with KillPodSandboxError:</span>
</span><span class="code-line">&quot;rpc error<span class="token operator">:</span> code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to destroy network for sandbox \&quot;<span class="token constant hash">79eade222dddaff28fcb79d001a47e581acfc501fe4b1c220c9f99b1415cfae3</span>\&quot;<span class="token operator">:</span>
</span><span class="code-line">plugin type<span class="token operator">=</span>\<span class="token string">&quot;portmap\&quot; failed (delete): failed to find plugin \&quot;portmap\&quot; in path [/opt/cni/bin]&quot;</span>
</span></code></pre></div><p>Worker Node에 들어가서 cni plugin binary를 확인하니 아래처럼 두 개만 존재하였다.</p><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ <span class="token function">ls</span> /opt/cni/bin
</span><span class="code-line">cilium-cni
</span><span class="code-line">loopback
</span></code></pre></div><p>그래서 Go를 설치하고 cni plugin 소스코드를 clone하여서 build하여서 <code>/opt/cni/bin</code>에 추가해주었다.</p><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line"><span class="token function">curl</span> -OL https://golang.org/dl/go1.20.4.linux-amd64.tar.gz
</span><span class="code-line"><span class="token function">sudo</span> <span class="token function">tar</span> -C /usr/local -xvf go1.20.4.linux-amd64.tar.gz
</span><span class="code-line"><span class="token class-name builtin">export</span> <span class="token assign-left variable"><span class="token constant environment">PATH</span></span><span class="token operator">=</span><span class="token constant environment">$PATH</span>:/usr/local/go/bin
</span></code></pre></div><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line"><span class="token function">git</span> clone https://github.com/containernetworking/plugins.git
</span><span class="code-line"><span class="token class-name builtin">cd</span> plugins
</span><span class="code-line">./build_linux.sh
</span><span class="code-line"><span class="token function">sudo</span> <span class="token function">cp</span> bin/portmap /opt/cni/bin/
</span></code></pre></div><p>이제 Pod가 정상적으로 작동하고, Iptable에 아래와 같이 Rule이 추가된 것을 확인할 수 있다.🥹 이제 정상적으로 Node에서 8080 포트로 해당 컨테이너에 접근할 수 있게 되었다.</p><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ iptables-save <span class="token operator">|</span> <span class="token function">grep</span> HOSTPORT
</span><span class="code-line">:CNI-HOSTPORT-DNAT - <span class="token punctuation">[</span><span class="token number">0</span>:0<span class="token punctuation">]</span>
</span><span class="code-line">:CNI-HOSTPORT-MASQ - <span class="token punctuation">[</span><span class="token number">0</span>:0<span class="token punctuation">]</span>
</span><span class="code-line">:CNI-HOSTPORT-SETMARK - <span class="token punctuation">[</span><span class="token number">0</span>:0<span class="token punctuation">]</span>
</span><span class="code-line">-A PREROUTING -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT
</span><span class="code-line">-A OUTPUT -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT
</span><span class="code-line">-A POSTROUTING -m comment --comment <span class="token string">&quot;CNI portfwd requiring masquerade&quot;</span> -j CNI-HOSTPORT-MASQ
</span><span class="code-line">-A CNI-DN-dae2e2caa00ed8d022728 -s <span class="token number">198.18</span>.2.27/32 -p tcp -m tcp --dport <span class="token number">8080</span> -j CNI-HOSTPORT-SETMARK
</span><span class="code-line">-A CNI-DN-dae2e2caa00ed8d022728 -s <span class="token number">127.0</span>.0.1/32 -p tcp -m tcp --dport <span class="token number">8080</span> -j CNI-HOSTPORT-SETMARK
</span><span class="code-line">-A CNI-HOSTPORT-DNAT -p tcp -m comment --comment <span class="token string">&quot;dnat name: <span class="token entity" title="\&quot;">\&quot;</span>portmap<span class="token entity" title="\&quot;">\&quot;</span> id: <span class="token entity" title="\&quot;">\&quot;</span>d629b42b837dcb40bc6a45f2486e76616c72ca15a3dc5cefe2f881ebd0d8222c<span class="token entity" title="\&quot;">\&quot;</span>&quot;</span> -m multiport --dports <span class="token number">8080</span> -j CNI-DN-dae2e2caa00ed8d022728
</span><span class="code-line">-A CNI-HOSTPORT-MASQ -m mark --mark 0x2000/0x2000 -j MASQUERADE
</span><span class="code-line">-A CNI-HOSTPORT-SETMARK -m comment --comment <span class="token string">&quot;CNI portfwd masquerade mark&quot;</span> -j MARK --set-xmark 0x2000/0x2000
</span></code></pre></div><h2 id="ebpf로-대체"><a href="#ebpf로-대체" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>eBPF로 대체</h2><p>뒤늦게 cilium으로 kube proxy를 완전 대체할 수 있는 환경이라는 것이 파악이 되었다. 그래서 아래와 같이 <code>cilium-config</code>를 변경하고, cilium agent를 재시작하였다.</p><div class="relative"><pre><code class="code-highlight language-yml"><span class="code-line"><span class="token atrule key">apiVersion</span><span class="token punctuation">:</span> v1
</span><span class="code-line"><span class="token atrule key">kind</span><span class="token punctuation">:</span> ConfigMap
</span><span class="code-line"><span class="token punctuation">...</span>
</span><span class="code-line"><span class="token atrule key">data</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token punctuation">...</span>생략
</span><span class="code-line">  <span class="token atrule key">kube-proxy-replacement</span><span class="token punctuation">:</span> strict
</span></code></pre></div><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">kubectl rollout restart daemonset/cilium -n kube-system
</span></code></pre></div><p>재시작하고 cilium status를 확인하면 이제 Service들이 다 Enabled된 것을 확인할 수 있다.</p><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ kubectl <span class="token class-name builtin">exec</span> -it cilium-tpxvv -- cilium status --verbose
</span><span class="code-line"><span class="token punctuation">..</span>.생략
</span><span class="code-line">KubeProxyReplacement Details:
</span><span class="code-line">  Status:                Strict
</span><span class="code-line">  Socket LB Protocols:   TCP, UDP
</span><span class="code-line">  Devices:               eth0 <span class="token number">192.168</span>.1.10 <span class="token punctuation">(</span>Direct Routing<span class="token punctuation">)</span>
</span><span class="code-line">  Mode:                  SNAT
</span><span class="code-line">  Backend Selection:     Random
</span><span class="code-line">  Session Affinity:      Enabled
</span><span class="code-line">  XDP Acceleration:      Disabled
</span><span class="code-line">  Services:
</span><span class="code-line">  - ClusterIP:      Enabled
</span><span class="code-line">  - NodePort:       Enabled <span class="token punctuation">(</span>Range: <span class="token number">30000</span>-32767<span class="token punctuation">)</span>
</span><span class="code-line">  - LoadBalancer:   Enabled
</span><span class="code-line">  - externalIPs:    Enabled
</span><span class="code-line">  - HostPort:       Enabled
</span></code></pre></div><p>이제 다시 HostPort가 설정된 Deployment Object를 배포하고, 아래와 같이 Cilium service 목록을 확인해본다. 그러면 우리가 hostPort 8080, container 80 설정했던 것이 등록되는 것을 확인할 수 있다.</p><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ kubectl <span class="token class-name builtin">exec</span> -it cilium-tpxvv -n kube-system -- cilium <span class="token function">service</span> list
</span><span class="code-line"><span class="token number">159</span>   <span class="token number">192.168</span>.1.10:8080      HostPort       <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">198.18</span>.0.24:80
</span><span class="code-line"><span class="token number">160</span>   <span class="token number">0.0</span>.0.0:8080           HostPort       <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">198.18</span>.0.24:80
</span></code></pre></div><p><code>partial</code>의 경우에는 아래처럼 <code>externalIPs</code>만 false로 설정하면 그것만 Disabled할 수도 있다.</p><div class="relative"><pre><code class="code-highlight language-yml"><span class="code-line"><span class="token atrule key">apiVersion</span><span class="token punctuation">:</span> v1
</span><span class="code-line"><span class="token atrule key">kind</span><span class="token punctuation">:</span> ConfigMap
</span><span class="code-line"><span class="token punctuation">...</span>
</span><span class="code-line"><span class="token atrule key">data</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token punctuation">...</span>생략
</span><span class="code-line">  <span class="token atrule key">kube-proxy-replacement</span><span class="token punctuation">:</span> partial
</span><span class="code-line">  <span class="token atrule key">enable-remote-node-identity</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
</span><span class="code-line">  <span class="token atrule key">enable-external-ips</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span>
</span><span class="code-line">  <span class="token atrule key">enable-host-port</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
</span><span class="code-line">  <span class="token atrule key">enable-health-check-nodeport</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span>
</span></code></pre></div><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">KubeProxyReplacement Details:
</span><span class="code-line">  Status:              Partial
</span><span class="code-line">  Devices:             eth0 <span class="token number">192.168</span>.1.10 <span class="token punctuation">(</span>Direct Routing<span class="token punctuation">)</span>
</span><span class="code-line">  Mode:                SNAT
</span><span class="code-line">  Backend Selection:   Random
</span><span class="code-line">  Session Affinity:    Enabled
</span><span class="code-line">  XDP Acceleration:    Disabled
</span><span class="code-line">  Services:
</span><span class="code-line">  - ClusterIP:      Enabled
</span><span class="code-line">  - NodePort:       Enabled <span class="token punctuation">(</span>Range: <span class="token number">30000</span>-32767<span class="token punctuation">)</span>
</span><span class="code-line">  - LoadBalancer:   Enabled
</span><span class="code-line">  - externalIPs:    Disabled
</span><span class="code-line">  - HostPort:       Enabled
</span></code></pre></div><p>그런데 처음에 portmap을 사용해서 Iptabls rule이 생겼고, HostPort를 사용하는 Pod가 있는 상태에서 Cilium의 eBPF로 대체하도록 수정하였다. 그래서 기존 Iptables rule이 Pod가 삭제될 때 같이 삭제되지 않았다. 그래서 HostPort 설정관련 Iptable rule들이 남아 있었다. eBPF로 사용할 때는 Iptable rule이 있어도 상관없었지만, 테스트를 위해서 다시 portmap을 사용하여 Iptables을 쓸려고 할 때 기존 Iptables rule과 충돌이 생겼다.</p><h2 id="결론"><a href="#결론" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>결론</h2><p>처음에 <code>HostPort</code> 기능만 사용하려고 <code>kube-proxy-replacement</code>를 <code>partial</code>로 하고 <code>enable-host-port</code>를 <code>true</code>로 설정했다. 하지만 cilium의 status에서 HostPort가 Enabled로 변경되지 않고 계속 Disabled 상태로 남아 있었다. 문서를 잘 못 읽고 커널 버전이 낮아서 지원을 안하는 줄 착각했다. 그래서 <code>chainMode</code>로 <code>portmap</code>을 사용하여 테스트를 하게 되었는데, <code>cilium-config</code> ConfigMap을 수정하는 것뿐만 아니라, portmap plugin binary는 Worker node에 없어서 해당 source code를 build해서 binary 파일을 적절한 경로에 넣어주는 작업까지 해줘야했다. 네이버 클라우드 쿠버네티스 서비스에서는 Custom Image를 제공하지 않기 때문에, 이렇게 해야 되는 것이 너무 불편하다고 생각했다. 하지만 내가 문서를 잘 못 읽었던 것이고, <code>enable-host-port</code>가 <code>enable-node-port</code>와 함께 설정될 때 Enabled이 되었다. 해당 Worker Node 환경에서 <code>strict</code> 설정으로 kube proxy를 Cilium eBPF로 대체해도 문제가 없었다. <code>cilium-config</code>의 <code>kube-proxy-replacement</code>을 <code>probe</code> 혹은 <code>strict</code>로 설정하면 간단하게 해결될 수 있는 문제였다. 🤪</p></div><div class="pt-6 pb-6 text-sm text-gray-700 dark:text-gray-300"></div><div id="comment"></div></div><footer><div class="divide-gray-200 text-sm font-medium leading-5 dark:divide-gray-700 xl:col-start-1 xl:row-start-2 xl:divide-y"><div class="py-4 xl:py-8"><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/kubernetes">kubernetes</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/cilium">cilium</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/20240124-cert-manager-webhook">Cert Manager Webhook 작성하여 Naver Cloud에서 DNS-01 challeng로 Lets Encrypt 인증서 발급하기</a></div></div><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Next Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/20240208-tekton-chain">Tekton Chain</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog">← Back to the blog</a></div></footer></div></div></article></div></main><footer><div class="mt-16 flex flex-col items-center"><div class="mb-3 flex space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:jayground8@gmail.com"><span class="sr-only">mail</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/jayground8"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></div><div class="mb-2 flex space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Jay</div><div> • </div><div>© 2024</div><div> • </div><a href="/">Jayground8</a></div><div class="mb-8 text-sm text-gray-500 dark:text-gray-400"><a target="_blank" rel="noopener noreferrer" href="https://github.com/timlrx/tailwind-nextjs-starter-blog">Tailwind Nextjs Theme</a></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var o=Object.create;var c=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var h=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var i=a=\u003ec(a,\"__esModule\",{value:!0});var u=(a,s)=\u003e()=\u003e(s||a((s={exports:{}}).exports,s),s.exports),N=(a,s)=\u003e{i(a);for(var l in s)c(a,l,{get:s[l],enumerable:!0})},k=(a,s,l)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let n of p(s))!m.call(a,n)\u0026\u0026n!==\"default\"\u0026\u0026c(a,n,{get:()=\u003es[n],enumerable:!(l=d(s,n))||l.enumerable});return a},g=a=\u003ek(i(c(a!=null?o(h(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var r=u((C,t)=\u003e{t.exports=_jsx_runtime});var f={};N(f,{default:()=\u003eP,frontmatter:()=\u003eb});var e=g(r()),b={title:\"Cilium CNI\\uC640 HostPort\",date:\"2024-02-07\",tags:[\"kubernetes\",\"cilium\"],images:[\"/static/images/social-banner.png\"],summary:\"\\uB124\\uC774\\uBC84 \\uD074\\uB77C\\uC6B0\\uB4DC \\uCFE0\\uBC84\\uB124\\uD2F0\\uC2A4 \\uC11C\\uBE44\\uC2A4\\uC5D0\\uC11C HostPort\\uB97C \\uC124\\uC815\\uD558\\uC600\\uB294\\uB370, \\uC815\\uC0C1\\uC801\\uC73C\\uB85C Node Port\\uB97C \\uD1B5\\uD574\\uC11C Container\\uC5D0 \\uC811\\uADFC\\uD560 \\uC218\\uAC00 \\uC5C6\\uC5C8\\uB2E4. \\uCC98\\uC74C\\uC5D0\\uB294 CNI plugin portmap\\uC744 \\uC124\\uC815\\uD558\\uC5EC HostPort\\uB97C Iptables Rule\\uB85C \\uC801\\uC6A9\\uD558\\uB3C4\\uB85D \\uD558\\uC600\\uB2E4. \\uD558\\uC9C0\\uB9CC \\uD604\\uC7AC \\uC6B4\\uC601\\uD558\\uB294 Kernel \\uBC84\\uC804\\uC774 kube proxy\\uB97C \\uB300\\uCCB4\\uD560 \\uC218 \\uC788\\uB294 \\uAC83\\uC744 \\uD30C\\uC545\\uD558\\uC600\\uACE0, default\\uB85C \\uC124\\uC815\\uB41C KubeProxyReplacement=disabled\\uC744 KubeProxyReplacement=strict\\uC73C\\uB85C \\uC124\\uC815\\uD558\\uC5EC Cilium eBPF\\uB85C \\uB300\\uCCB4\\uD558\\uC5EC \\uC0AC\\uC6A9\\uD558\\uC600\\uB2E4.\"};function y(a={}){let{wrapper:s}=a.components||{};return s?(0,e.jsx)(s,Object.assign({},a,{children:(0,e.jsx)(l,{})})):l();function l(){let n=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",ul:\"ul\",li:\"li\",p:\"p\",code:\"code\",pre:\"pre\",blockquote:\"blockquote\"},a.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(n.h2,{id:\"\\uD14C\\uC2A4\\uD2B8-\\uD658\\uACBD\",children:[(0,e.jsx)(n.a,{href:\"#\\uD14C\\uC2A4\\uD2B8-\\uD658\\uACBD\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\uD14C\\uC2A4\\uD2B8 \\uD658\\uACBD\"]}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"\\uB124\\uC774\\uBC84 \\uD074\\uB77C\\uC6B0\\uB4DC \\uCFE0\\uBC84\\uB124\\uD2F0\\uC2A4 \\uC11C\\uBE44\\uC2A4 \\uBC84\\uC804: 1.26\"}),(0,e.jsx)(n.li,{children:\"Cilium \\uBC84\\uC804: 1.10.16\"}),(0,e.jsx)(n.li,{children:\"\\uCEE4\\uB110 \\uBC84\\uC804: 5.4.0-163-generic\"})]}),(0,e.jsxs)(n.h2,{id:\"\\uC774\\uC288-\\uC0AC\\uD56D\",children:[(0,e.jsx)(n.a,{href:\"#\\uC774\\uC288-\\uC0AC\\uD56D\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\uC774\\uC288 \\uC0AC\\uD56D\"]}),(0,e.jsx)(n.p,{children:\"OpenTelemetry collector\\uB97C DaemonSet\\uC73C\\uB85C \\uC124\\uCE58\\uB97C \\uD558\\uC600\\uB2E4. \\uADF8\\uB9AC\\uACE0 Web server\\uAC00 \\uB3CC\\uACE0 \\uC788\\uB294 Pod\\uAC00 Trace \\uC815\\uBCF4\\uB97C Collector\\uC5D0 \\uBCF4\\uB0B4\\uACE0\\uC790 \\uD588\\uB2E4. OpenTelemetry Collector\\uAC00 HostPort\\uB85C \\uC124\\uC815\\uC774 \\uB418\\uC5B4 \\uC788\\uC5C8\\uACE0, Pod\\uB294 \\uC774 HostPort\\uB85C \\uC5F0\\uACB0\\uC744 \\uC2DC\\uB3C4\\uD588\\uB2E4.\"}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.code,{children:\"opentelemetry collector \\uC124\\uC815\"})}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yaml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"Ports\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" 4317/TCP\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),` 4318/TCP\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"Host Ports\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" 4317/TCP\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),` 4318/TCP\n`]})]})}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.code,{children:\"Web server\\uAC00 \\uB3CC\\uACE0 \\uC788\\uB294 Pod\\uC758 Deployment \\uC124\\uC815\"})}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yaml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` NODE_IP\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"valueFrom\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"fieldRef\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"fieldPath\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` status.hostIP\n`]})]})}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.code,{children:\"OpenTelemetry SDK\\uB97C \\uD1B5\\uD574\\uC11C Trace\\uB97C \\uC804\\uC1A1\"})}),(0,e.jsx)(n.pre,{className:\"language-js\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-js\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"traceExporter\",(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"new\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"OTLPTraceExporter\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  url\",(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsxs)(n.span,{className:\"token template-string\",children:[(0,e.jsx)(n.span,{className:\"token string template-punctuation\",children:\"`\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"http://\"}),(0,e.jsxs)(n.span,{className:\"token interpolation\",children:[(0,e.jsx)(n.span,{className:\"token punctuation interpolation-punctuation\",children:\"${\"}),\"process\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access\",children:\"env\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"NODE_IP\"}),(0,e.jsx)(n.span,{className:\"token punctuation interpolation-punctuation\",children:\"}\"})]}),(0,e.jsx)(n.span,{className:\"token string\",children:\":4318/v1/traces\"}),(0,e.jsx)(n.span,{className:\"token string template-punctuation\",children:\"`\"})]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"\\uD558\\uC9C0\\uB9CC OpenTelemetry Collector\\uAC00 \\uC815\\uC0C1\\uC801\\uC73C\\uB85C \\uC2E4\\uD589\\uB418\\uACE0 \\uC788\\uC5C8\\uC9C0\\uB9CC, Node\\uC5D0\\uC11C \\uD574\\uB2F9 collector\\uB85C \\uC5F0\\uACB0\\uD558\\uC9C0 \\uBABB\\uD558\\uACE0 Connection refused\\uAC00 \\uBC1C\\uC0DD\\uD558\\uC600\\uB2E4. \\uB124\\uC774\\uBC84 \\uD074\\uB77C\\uC6B0\\uB4DC \\uCFE0\\uBC84\\uB124\\uD2F0\\uC2A4\\uC5D0\\uC11C Cilium\\uC774 CNI\\uB85C \\uC124\\uC815\\uC774 \\uB418\\uC5B4 \\uC788\\uC5C8\\uACE0, \\uC544\\uB798\\uC640 \\uAC19\\uC774 cilium cli\\uB97C \\uD1B5\\uD574\\uC11C service \\uBAA9\\uB85D\\uC744 \\uD655\\uC778\\uD558\\uC600\\uB2E4. \\uD558\\uC9C0\\uB9CC \",(0,e.jsx)(n.code,{children:\"HostPort\"}),\" Service Type\\uC740 \\uBAA9\\uB85D\\uC5D0\\uC11C \\uBCF4\\uC774\\uC9C0 \\uC54A\\uC558\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"kubectl \",(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\"exec\"}),\" -it cilium-4d93a -n kube-system -- cilium \",(0,e.jsx)(n.span,{className:\"token function\",children:\"service\"}),` list\n`]})})}),(0,e.jsxs)(n.h2,{id:\"hostport\",children:[(0,e.jsx)(n.a,{href:\"#hostport\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"HostPort\"]}),(0,e.jsxs)(n.p,{children:[\"Kubernetes\\uC5D0\\uC11C \\uC544\\uB798\\uC640 \\uAC19\\uC774 \",(0,e.jsx)(n.code,{children:\"HostPort\"}),\"\\uB97C \\uC124\\uC815\\uD558\\uBA74, Pod\\uAC00 Node\\uC758 Port\\uC5D0\\uC11C listening\\uD560 \\uC218 \\uC788\\uB2E4. \\uC544\\uB798\\uC758 \\uACBD\\uC6B0\\uB294 Node\\uC758 8080 Port\\uC5D0 \\uC694\\uCCAD\\uD558\\uBA74 Container\\uC758 80 Port\\uC5D0 \\uC5F0\\uACB0\\uD560 \\uC218 \\uC788\\uB2E4. \\uC77C\\uBC18\\uC801\\uC73C\\uB85C Iptable\\uC758 nat table\\uC5D0 Rule\\uB4E4\\uC774 \\uC0DD\\uC131\\uB418\\uC5B4 \\uC774\\uB807\\uAC8C \\uC791\\uB3D9\\uB41C\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yaml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"apiVersion\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` apps/v1\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"kind\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` Deployment\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"metadata\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" my\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`nginx\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"spec\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"selector\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"matchLabels\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"run\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" my\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`nginx\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"replicas\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"template\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"metadata\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"labels\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"run\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" my\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`nginx\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"spec\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"containers\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" my\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`nginx\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"image\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` nginx\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"ports\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"containerPort\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"80\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"              \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"hostPort\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"8080\"}),`\n`]})]})}),(0,e.jsxs)(n.h2,{id:\"hostport-with-ciliums-ebpf\",children:[(0,e.jsx)(n.a,{href:\"#hostport-with-ciliums-ebpf\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"HostPort with Cilium's eBPF\"]}),(0,e.jsxs)(n.p,{children:[\"Cilium\\uC740 eBPF\\uB85C Kube Proxy\\uB97C \\uB300\\uCCB4\\uD560 \\uC218 \\uC788\\uB2E4. \",(0,e.jsx)(n.a,{href:\"https://docs.cilium.io/en/v1.11/operations/system_requirements/\",children:\"Cilium v1.11\\uC758 \\uBB38\\uC11C\"}),\"\\uB97C \\uBCF4\\uBA74, kube proxy\\uB97C \\uB300\\uCCB4\\uD558\\uAE30 \\uC704\\uD574\\uC11C kernel version\\uC774 5.2\\uC774\\uC0C1\\uC5D0\\uC11C \\uAC00\\uB2A5\\uD558\\uB2E4. \\uD14C\\uC2A4\\uD2B8\\uD558\\uB294 \\uD658\\uACBD\\uC740 \\uCEE4\\uB110 \\uBC84\\uC804\\uC774 5.4\\uC774\\uC0C1\\uC774\\uB2C8\\uAE50 cilium\\uC774 eBPF\\uB85C kube proxy\\uB97C \\uB300\\uCCB4\\uD560 \\uC218 \\uC788\\uB2E4.\"]}),(0,e.jsx)(\"img\",{src:\"/static/images/cilium-required-kernel-version-1.11.png\",alt:\"cilium required kernel version\"}),(0,e.jsxs)(n.p,{children:[\"BPF-based host routing\\uC740 kernel version 5.10 \\uC774\\uC0C1\\uC774\\uC5B4\\uC57C \\uD558\\uB294\\uB370, \\uB530\\uB77C\\uC11C \\uD574\\uB2F9 \\uC124\\uC815\\uC740 cilium agent log\\uB97C \\uD655\\uC778\\uD574\\uBCF4\\uBA74 \\uC544\\uB798\\uCC98\\uB7FC 5.10\\uC774 \\uC544\\uB2C8\\uB77C\\uC11C \",(0,e.jsx)(n.code,{children:\"enable-host-legacy-routing\"}),\"\\uC774 \\uC790\\uB3D9\\uC73C\\uB85C true\\uB85C \\uC14B\\uD305\\uB418\\uB294 \\uAC83\\uC744 \\uD655\\uC778\\uD560 \\uC218 \\uC788\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token assign-left variable\",children:\"level\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),`info\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token assign-left variable\",children:\"msg\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"BPF host routing requires kernel 5.10 or newer. Falling back to legacy host routing (enable-host-legacy-routing=true).\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token assign-left variable\",children:\"subsys\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),`daemon\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"Helm chart\\uB85C Cilium\\uC744 \\uC124\\uCE58\\uD558\\uBA74 \",(0,e.jsx)(n.code,{children:\"cilium-config\"}),\"\\uAC00 ConfigMap object\\uB85C \\uC0DD\\uC131\\uB418\\uB294\\uB370, \",(0,e.jsx)(n.a,{href:\"https://github.com/cilium/cilium/blob/v1.10.16/install/kubernetes/cilium/templates/cilium-configmap.yaml\",children:\"ConfigMap\\uC758 \\uAC12\\uC73C\\uB85C Cilium\\uC758 \\uC124\\uC815\\uC774 \\uACB0\\uC815\\uB41C\\uB2E4.\"}),\". \\uC5EC\\uAE30\\uC11C \\uAD00\\uC2EC\\uC788\\uAC8C \\uBD10\\uC57C\\uD560 \\uC124\\uC815\\uAC12\\uC740 \",(0,e.jsx)(n.code,{children:\"kube-proxy-relacement\"}),\"\\uC774\\uB2E4.\"]}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.a,{href:\"https://docs.cilium.io/en/v1.11/gettingstarted/kubeproxy-free/#kube-proxy-hybrid-modes\",children:\"cilium v1.11\\uC5D0\\uC11C kubeProxyReplacement\\uC744 \\uC544\\uB798\\uC640 \\uAC19\\uC774 \\uB124 \\uAC00\\uC9C0\\uC911\\uC5D0 \\uD558\\uB098\\uB85C \\uC124\\uC815\\uD560 \\uC218 \\uC788\\uB2E4.\"})}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"strict: eBPF\\uB85C \\uB2E4 \\uB300\\uCCB4\"}),(0,e.jsx)(n.li,{children:\"probe: \\uB300\\uCCB4\\uD560 \\uC218 \\uC788\\uB294\\uAC83\\uB9CC eBPF\\uB85C \\uB300\\uCCB4\\uD558\\uACE0 \\uB098\\uBA38\\uC9C0\\uB294 kube proxy\\uB791 \\uAC19\\uC774 \\uACF5\\uC874\"}),(0,e.jsx)(n.li,{children:\"partial: \\uC6D0\\uD558\\uB294 \\uBD80\\uBD84\\uB9CC enable\\uD574\\uC11C eBPF\\uB85C \\uB300\\uCCB4\"}),(0,e.jsx)(n.li,{children:\"disabled\"})]}),(0,e.jsxs)(n.p,{children:[\"\\uADF8\\uB7F0\\uB370 \\uB124\\uC774\\uBC84 \\uD074\\uB77C\\uC6B0\\uB4DC \\uCFE0\\uBC84\\uB124\\uD2F0\\uC2A4 \\uC11C\\uBE44\\uC2A4\\uC758 \",(0,e.jsx)(n.code,{children:\"cilium-config\"}),\"\\uC758 \",(0,e.jsx)(n.code,{children:\"kube-proxy-replacement\"}),\"\\uAC00 \\uAE30\\uBCF8\\uC73C\\uB85C disabled\\uB85C \\uB418\\uC5B4 \\uC788\\uC5C8\\uB2E4.\"]}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"kubeProxyReplacement=disabled: This option disables any Kubernetes service handling by fully relying on kube-proxy instead, except for ClusterIP services accessed from pods (pre-v1.6 behavior).\"})}),(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"cilium status\"}),\" CLI \\uBA85\\uB839\\uC5B4\\uB85C \\uD655\\uC778\\uC744 \\uD558\\uBA74, HostPort\\uAC00 Disabled\\uB85C \\uB098\\uC628\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ kubectl \",(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\"exec\"}),` -it cilium-4d93a -n kube-system -- cilium status --verbose\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"..\"}),`.\\uC0DD\\uB7B5\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`KubeProxyReplacement Details:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Services:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    - ClusterIP:      Enabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    - NodePort:       Disabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    - LoadBalancer:   Disabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    - externalIPs:    Disabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    - HostPort:       Disabled\n`})]})}),(0,e.jsxs)(n.h2,{id:\"cni-plugin-portmap\",children:[(0,e.jsx)(n.a,{href:\"#cni-plugin-portmap\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"CNI plugin portmap\"]}),(0,e.jsxs)(n.p,{children:[\"\\uCC98\\uC74C\\uC5D0 \",(0,e.jsx)(n.code,{children:\"partial\"}),\" \\uC124\\uC815\\uC73C\\uB85C \",(0,e.jsx)(n.code,{children:\"HostPort\"}),\"\\uB9CC Enabled\\uC744 \\uD574\\uBCFC\\uB824\\uACE0 \\uD558\\uB294\\uB370 \\uC548\\uB418\\uC5C8\\uB2E4. \\uADF8\\uB798\\uC11C eBPF\\uB85C HostPort\\uAC00 \\uB300\\uCCB4\\uB418\\uC9C0 \\uBABB\\uD558\\uB294 \\uC904 \\uC54C\\uC558\\uB2E4. \\uADF8\\uB807\\uAC8C \\uB610 \\uD55C\\uBC88 \\uC4F8\\uB370 \\uC5C6\\uB294 \\uC0BD\\uC9C8\\uC744 \\uD558\\uAC8C \\uB418\\uC5C8\\uB2E4.\\u{1F979} \",(0,e.jsx)(n.code,{children:\"KubeProxyReplacement\"}),\"\\uB97C \",(0,e.jsx)(n.code,{children:\"disabld\"}),\"\\uB85C \\uC720\\uC9C0\\uD558\\uACE0, \",(0,e.jsx)(n.a,{href:\"https://docs.cilium.io/en/latest/installation/cni-chaining-portmap/#portmap-hostport\",children:\"CNI chaining\\uC73C\\uB85C PortMap\\uC744 \\uC0AC\\uC6A9\"}),\"\\uD558\\uB294 \\uBC29\\uBC95\\uC744 \\uC801\\uC6A9\\uD588\\uB2E4.\"]}),(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"cilium-config\"}),\" ConfigMap\\uC5D0\\uC11C \",(0,e.jsx)(n.code,{children:\"cni-chaining-mode\"}),\"\\uB97C \\uC544\\uB798\\uC640 \\uAC19\\uC774 \\uC124\\uC815\\uD558\\uACE0, Opentelemetry Collector\\uB97C restart\\uD55C\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-yml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"apiVersion\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` v1\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"kind\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` ConfigMap\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"...\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"data\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"...\"}),`\\uC0DD\\uB7B5\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"cni-chaining-mode\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` portmap\n`]})]})}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`kubectl rollout restart daemonset/cilium -n kube-system\n`})})}),(0,e.jsxs)(n.p,{children:[\"\\uC774\\uB807\\uAC8C \\uC801\\uC6A9\\uD558\\uACE0 \\uB098\\uBA74 \",(0,e.jsx)(n.code,{children:\"/etc/cni/net.d/05-cilium.conflist\"}),\"\\uC5D0 cni \\uC124\\uC815 \\uD30C\\uC77C\\uC774 \\uC544\\uB798\\uC640 \\uAC19\\uC774 \\uC0DD\\uC131\\uB41C\\uB2E4. \",(0,e.jsx)(n.code,{children:\"portmap\"}),\"\\uC774 plugin\\uC5D0 \\uCD94\\uAC00\\uB41C \\uAC83\\uC744 \\uD655\\uC778 \\uD560 \\uC218 \\uC788\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-json\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-json\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"cniVersion\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"0.3.1\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"name\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"portmap\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"plugins\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"name\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"cilium\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"type\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"cilium-cni\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"enable-debug\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"false\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"type\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"portmap\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"capabilities\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,e.jsx)(n.span,{className:\"token property\",children:'\"portMappings\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean\",children:\"true\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"\\uC774\\uC81C \\uB2E4\\uC2DC HostPort\\uAC00 \\uC124\\uC815\\uB41C Deployment Object\\uC744 \\uC0DD\\uC131\\uD55C\\uB2E4.\"}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yaml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"apiVersion\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` v1\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"kind\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` Deployment\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"metadata\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" my\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`nginx\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"spec\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"selector\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"matchLabels\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"run\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" my\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`nginx\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"replicas\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"template\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"metadata\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"labels\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"run\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" my\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`nginx\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"spec\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"containers\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" my\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`nginx\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"image\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` nginx\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"ports\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"containerPort\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"80\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"              \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"hostPort\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"8080\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"\\uC774\\uBC88\\uC5D0\\uB294 \\uC544\\uB798\\uC640 \\uAC19\\uC774 cni plugin \",(0,e.jsx)(n.code,{children:\"portmap\"}),\" binary \\uD30C\\uC77C\\uC774 \\uC5C6\\uC5B4\\uC11C Pod\\uAC00 \\uC815\\uC0C1\\uC801\\uC73C\\uB85C \\uC2E4\\uD589\\uB418\\uC9C0 \\uBABB \\uD588\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-log\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-log\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token property\",children:\"error killing pod:\"}),\" failed to \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"KillPodSandbox\"'}),\" for \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"1055faa0-7449-49ba-9e25-b6e46de342b1\"'}),\" \",(0,e.jsx)(n.span,{className:\"token property\",children:\"with KillPodSandboxError:\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:['\"rpc error',(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" code \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" Unknown desc \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),' failed to destroy network for sandbox \\\\\"',(0,e.jsx)(n.span,{className:\"token constant hash\",children:\"79eade222dddaff28fcb79d001a47e581acfc501fe4b1c220c9f99b1415cfae3\"}),'\\\\\"',(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"plugin type\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\"\\\\\",(0,e.jsx)(n.span,{className:\"token string\",children:'\"portmap\\\\\" failed (delete): failed to find plugin \\\\\"portmap\\\\\" in path [/opt/cni/bin]\"'}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"Worker Node\\uC5D0 \\uB4E4\\uC5B4\\uAC00\\uC11C cni plugin binary\\uB97C \\uD655\\uC778\\uD558\\uB2C8 \\uC544\\uB798\\uCC98\\uB7FC \\uB450 \\uAC1C\\uB9CC \\uC874\\uC7AC\\uD558\\uC600\\uB2E4.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ \",(0,e.jsx)(n.span,{className:\"token function\",children:\"ls\"}),` /opt/cni/bin\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`cilium-cni\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`loopback\n`})]})}),(0,e.jsxs)(n.p,{children:[\"\\uADF8\\uB798\\uC11C Go\\uB97C \\uC124\\uCE58\\uD558\\uACE0 cni plugin \\uC18C\\uC2A4\\uCF54\\uB4DC\\uB97C clone\\uD558\\uC5EC\\uC11C build\\uD558\\uC5EC\\uC11C \",(0,e.jsx)(n.code,{children:\"/opt/cni/bin\"}),\"\\uC5D0 \\uCD94\\uAC00\\uD574\\uC8FC\\uC5C8\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"curl\"}),` -OL https://golang.org/dl/go1.20.4.linux-amd64.tar.gz\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"sudo\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"tar\"}),` -C /usr/local -xvf go1.20.4.linux-amd64.tar.gz\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\"export\"}),\" \",(0,e.jsx)(n.span,{className:\"token assign-left variable\",children:(0,e.jsx)(n.span,{className:\"token constant environment\",children:\"PATH\"})}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token constant environment\",children:\"$PATH\"}),`:/usr/local/go/bin\n`]})]})}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"git\"}),` clone https://github.com/containernetworking/plugins.git\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\"cd\"}),` plugins\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`./build_linux.sh\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"sudo\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"cp\"}),` bin/portmap /opt/cni/bin/\n`]})]})}),(0,e.jsx)(n.p,{children:\"\\uC774\\uC81C Pod\\uAC00 \\uC815\\uC0C1\\uC801\\uC73C\\uB85C \\uC791\\uB3D9\\uD558\\uACE0, Iptable\\uC5D0 \\uC544\\uB798\\uC640 \\uAC19\\uC774 Rule\\uC774 \\uCD94\\uAC00\\uB41C \\uAC83\\uC744 \\uD655\\uC778\\uD560 \\uC218 \\uC788\\uB2E4.\\u{1F979} \\uC774\\uC81C \\uC815\\uC0C1\\uC801\\uC73C\\uB85C Node\\uC5D0\\uC11C 8080 \\uD3EC\\uD2B8\\uB85C \\uD574\\uB2F9 \\uCEE8\\uD14C\\uC774\\uB108\\uC5D0 \\uC811\\uADFC\\uD560 \\uC218 \\uC788\\uAC8C \\uB418\\uC5C8\\uB2E4.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ iptables-save \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"|\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"grep\"}),` HOSTPORT\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\":CNI-HOSTPORT-DNAT - \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),\":0\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\":CNI-HOSTPORT-MASQ - \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),\":0\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\":CNI-HOSTPORT-SETMARK - \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),\":0\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`-A PREROUTING -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`-A OUTPUT -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"-A POSTROUTING -m comment --comment \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"CNI portfwd requiring masquerade\"'}),` -j CNI-HOSTPORT-MASQ\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"-A CNI-DN-dae2e2caa00ed8d022728 -s \",(0,e.jsx)(n.span,{className:\"token number\",children:\"198.18\"}),\".2.27/32 -p tcp -m tcp --dport \",(0,e.jsx)(n.span,{className:\"token number\",children:\"8080\"}),` -j CNI-HOSTPORT-SETMARK\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"-A CNI-DN-dae2e2caa00ed8d022728 -s \",(0,e.jsx)(n.span,{className:\"token number\",children:\"127.0\"}),\".0.1/32 -p tcp -m tcp --dport \",(0,e.jsx)(n.span,{className:\"token number\",children:\"8080\"}),` -j CNI-HOSTPORT-SETMARK\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"-A CNI-HOSTPORT-DNAT -p tcp -m comment --comment \",(0,e.jsxs)(n.span,{className:\"token string\",children:['\"dnat name: ',(0,e.jsx)(n.span,{className:\"token entity\",title:'\\\\\"',children:'\\\\\"'}),\"portmap\",(0,e.jsx)(n.span,{className:\"token entity\",title:'\\\\\"',children:'\\\\\"'}),\" id: \",(0,e.jsx)(n.span,{className:\"token entity\",title:'\\\\\"',children:'\\\\\"'}),\"d629b42b837dcb40bc6a45f2486e76616c72ca15a3dc5cefe2f881ebd0d8222c\",(0,e.jsx)(n.span,{className:\"token entity\",title:'\\\\\"',children:'\\\\\"'}),'\"']}),\" -m multiport --dports \",(0,e.jsx)(n.span,{className:\"token number\",children:\"8080\"}),` -j CNI-DN-dae2e2caa00ed8d022728\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`-A CNI-HOSTPORT-MASQ -m mark --mark 0x2000/0x2000 -j MASQUERADE\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"-A CNI-HOSTPORT-SETMARK -m comment --comment \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"CNI portfwd masquerade mark\"'}),` -j MARK --set-xmark 0x2000/0x2000\n`]})]})}),(0,e.jsxs)(n.h2,{id:\"ebpf\\uB85C-\\uB300\\uCCB4\",children:[(0,e.jsx)(n.a,{href:\"#ebpf\\uB85C-\\uB300\\uCCB4\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"eBPF\\uB85C \\uB300\\uCCB4\"]}),(0,e.jsxs)(n.p,{children:[\"\\uB4A4\\uB2A6\\uAC8C cilium\\uC73C\\uB85C kube proxy\\uB97C \\uC644\\uC804 \\uB300\\uCCB4\\uD560 \\uC218 \\uC788\\uB294 \\uD658\\uACBD\\uC774\\uB77C\\uB294 \\uAC83\\uC774 \\uD30C\\uC545\\uC774 \\uB418\\uC5C8\\uB2E4. \\uADF8\\uB798\\uC11C \\uC544\\uB798\\uC640 \\uAC19\\uC774 \",(0,e.jsx)(n.code,{children:\"cilium-config\"}),\"\\uB97C \\uBCC0\\uACBD\\uD558\\uACE0, cilium agent\\uB97C \\uC7AC\\uC2DC\\uC791\\uD558\\uC600\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-yml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"apiVersion\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` v1\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"kind\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` ConfigMap\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"...\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"data\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"...\"}),`\\uC0DD\\uB7B5\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"kube-proxy-replacement\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` strict\n`]})]})}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`kubectl rollout restart daemonset/cilium -n kube-system\n`})})}),(0,e.jsx)(n.p,{children:\"\\uC7AC\\uC2DC\\uC791\\uD558\\uACE0 cilium status\\uB97C \\uD655\\uC778\\uD558\\uBA74 \\uC774\\uC81C Service\\uB4E4\\uC774 \\uB2E4 Enabled\\uB41C \\uAC83\\uC744 \\uD655\\uC778\\uD560 \\uC218 \\uC788\\uB2E4.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ kubectl \",(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\"exec\"}),` -it cilium-tpxvv -- cilium status --verbose\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"..\"}),`.\\uC0DD\\uB7B5\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`KubeProxyReplacement Details:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Status:                Strict\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Socket LB Protocols:   TCP, UDP\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  Devices:               eth0 \",(0,e.jsx)(n.span,{className:\"token number\",children:\"192.168\"}),\".1.10 \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"Direct Routing\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Mode:                  SNAT\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Backend Selection:     Random\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Session Affinity:      Enabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  XDP Acceleration:      Disabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Services:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  - ClusterIP:      Enabled\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  - NodePort:       Enabled \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"Range: \",(0,e.jsx)(n.span,{className:\"token number\",children:\"30000\"}),\"-32767\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  - LoadBalancer:   Enabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  - externalIPs:    Enabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  - HostPort:       Enabled\n`})]})}),(0,e.jsx)(n.p,{children:\"\\uC774\\uC81C \\uB2E4\\uC2DC HostPort\\uAC00 \\uC124\\uC815\\uB41C Deployment Object\\uB97C \\uBC30\\uD3EC\\uD558\\uACE0, \\uC544\\uB798\\uC640 \\uAC19\\uC774 Cilium service \\uBAA9\\uB85D\\uC744 \\uD655\\uC778\\uD574\\uBCF8\\uB2E4. \\uADF8\\uB7EC\\uBA74 \\uC6B0\\uB9AC\\uAC00 hostPort 8080, container 80 \\uC124\\uC815\\uD588\\uB358 \\uAC83\\uC774 \\uB4F1\\uB85D\\uB418\\uB294 \\uAC83\\uC744 \\uD655\\uC778\\uD560 \\uC218 \\uC788\\uB2E4.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ kubectl \",(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\"exec\"}),\" -it cilium-tpxvv -n kube-system -- cilium \",(0,e.jsx)(n.span,{className:\"token function\",children:\"service\"}),` list\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token number\",children:\"159\"}),\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"192.168\"}),\".1.10:8080      HostPort       \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"198.18\"}),`.0.24:80\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token number\",children:\"160\"}),\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0.0\"}),\".0.0:8080           HostPort       \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"198.18\"}),`.0.24:80\n`]})]})}),(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"partial\"}),\"\\uC758 \\uACBD\\uC6B0\\uC5D0\\uB294 \\uC544\\uB798\\uCC98\\uB7FC \",(0,e.jsx)(n.code,{children:\"externalIPs\"}),\"\\uB9CC false\\uB85C \\uC124\\uC815\\uD558\\uBA74 \\uADF8\\uAC83\\uB9CC Disabled\\uD560 \\uC218\\uB3C4 \\uC788\\uB2E4.\"]}),(0,e.jsx)(n.pre,{className:\"language-yml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"apiVersion\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` v1\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"kind\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` ConfigMap\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"...\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"data\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"...\"}),`\\uC0DD\\uB7B5\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"kube-proxy-replacement\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` partial\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"enable-remote-node-identity\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"true\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"enable-external-ips\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"false\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"enable-host-port\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"true\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"enable-health-check-nodeport\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"false\"'}),`\n`]})]})}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`KubeProxyReplacement Details:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Status:              Partial\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  Devices:             eth0 \",(0,e.jsx)(n.span,{className:\"token number\",children:\"192.168\"}),\".1.10 \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"Direct Routing\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Mode:                SNAT\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Backend Selection:   Random\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Session Affinity:    Enabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  XDP Acceleration:    Disabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  Services:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  - ClusterIP:      Enabled\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  - NodePort:       Enabled \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"Range: \",(0,e.jsx)(n.span,{className:\"token number\",children:\"30000\"}),\"-32767\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  - LoadBalancer:   Enabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  - externalIPs:    Disabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`  - HostPort:       Enabled\n`})]})}),(0,e.jsx)(n.p,{children:\"\\uADF8\\uB7F0\\uB370 \\uCC98\\uC74C\\uC5D0 portmap\\uC744 \\uC0AC\\uC6A9\\uD574\\uC11C Iptabls rule\\uC774 \\uC0DD\\uACBC\\uACE0, HostPort\\uB97C \\uC0AC\\uC6A9\\uD558\\uB294 Pod\\uAC00 \\uC788\\uB294 \\uC0C1\\uD0DC\\uC5D0\\uC11C Cilium\\uC758 eBPF\\uB85C \\uB300\\uCCB4\\uD558\\uB3C4\\uB85D \\uC218\\uC815\\uD558\\uC600\\uB2E4. \\uADF8\\uB798\\uC11C \\uAE30\\uC874 Iptables rule\\uC774 Pod\\uAC00 \\uC0AD\\uC81C\\uB420 \\uB54C \\uAC19\\uC774 \\uC0AD\\uC81C\\uB418\\uC9C0 \\uC54A\\uC558\\uB2E4. \\uADF8\\uB798\\uC11C HostPort \\uC124\\uC815\\uAD00\\uB828 Iptable rule\\uB4E4\\uC774 \\uB0A8\\uC544 \\uC788\\uC5C8\\uB2E4. eBPF\\uB85C \\uC0AC\\uC6A9\\uD560 \\uB54C\\uB294 Iptable rule\\uC774 \\uC788\\uC5B4\\uB3C4 \\uC0C1\\uAD00\\uC5C6\\uC5C8\\uC9C0\\uB9CC, \\uD14C\\uC2A4\\uD2B8\\uB97C \\uC704\\uD574\\uC11C \\uB2E4\\uC2DC portmap\\uC744 \\uC0AC\\uC6A9\\uD558\\uC5EC Iptables\\uC744 \\uC4F8\\uB824\\uACE0 \\uD560 \\uB54C \\uAE30\\uC874 Iptables rule\\uACFC \\uCDA9\\uB3CC\\uC774 \\uC0DD\\uACBC\\uB2E4.\"}),(0,e.jsxs)(n.h2,{id:\"\\uACB0\\uB860\",children:[(0,e.jsx)(n.a,{href:\"#\\uACB0\\uB860\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\uACB0\\uB860\"]}),(0,e.jsxs)(n.p,{children:[\"\\uCC98\\uC74C\\uC5D0 \",(0,e.jsx)(n.code,{children:\"HostPort\"}),\" \\uAE30\\uB2A5\\uB9CC \\uC0AC\\uC6A9\\uD558\\uB824\\uACE0 \",(0,e.jsx)(n.code,{children:\"kube-proxy-replacement\"}),\"\\uB97C \",(0,e.jsx)(n.code,{children:\"partial\"}),\"\\uB85C \\uD558\\uACE0 \",(0,e.jsx)(n.code,{children:\"enable-host-port\"}),\"\\uB97C \",(0,e.jsx)(n.code,{children:\"true\"}),\"\\uB85C \\uC124\\uC815\\uD588\\uB2E4. \\uD558\\uC9C0\\uB9CC cilium\\uC758 status\\uC5D0\\uC11C HostPort\\uAC00 Enabled\\uB85C \\uBCC0\\uACBD\\uB418\\uC9C0 \\uC54A\\uACE0 \\uACC4\\uC18D Disabled \\uC0C1\\uD0DC\\uB85C \\uB0A8\\uC544 \\uC788\\uC5C8\\uB2E4. \\uBB38\\uC11C\\uB97C \\uC798 \\uBABB \\uC77D\\uACE0 \\uCEE4\\uB110 \\uBC84\\uC804\\uC774 \\uB0AE\\uC544\\uC11C \\uC9C0\\uC6D0\\uC744 \\uC548\\uD558\\uB294 \\uC904 \\uCC29\\uAC01\\uD588\\uB2E4. \\uADF8\\uB798\\uC11C \",(0,e.jsx)(n.code,{children:\"chainMode\"}),\"\\uB85C \",(0,e.jsx)(n.code,{children:\"portmap\"}),\"\\uC744 \\uC0AC\\uC6A9\\uD558\\uC5EC \\uD14C\\uC2A4\\uD2B8\\uB97C \\uD558\\uAC8C \\uB418\\uC5C8\\uB294\\uB370, \",(0,e.jsx)(n.code,{children:\"cilium-config\"}),\" ConfigMap\\uC744 \\uC218\\uC815\\uD558\\uB294 \\uAC83\\uBFD0\\uB9CC \\uC544\\uB2C8\\uB77C, portmap plugin binary\\uB294 Worker node\\uC5D0 \\uC5C6\\uC5B4\\uC11C \\uD574\\uB2F9 source code\\uB97C build\\uD574\\uC11C binary \\uD30C\\uC77C\\uC744 \\uC801\\uC808\\uD55C \\uACBD\\uB85C\\uC5D0 \\uB123\\uC5B4\\uC8FC\\uB294 \\uC791\\uC5C5\\uAE4C\\uC9C0 \\uD574\\uC918\\uC57C\\uD588\\uB2E4. \\uB124\\uC774\\uBC84 \\uD074\\uB77C\\uC6B0\\uB4DC \\uCFE0\\uBC84\\uB124\\uD2F0\\uC2A4 \\uC11C\\uBE44\\uC2A4\\uC5D0\\uC11C\\uB294 Custom Image\\uB97C \\uC81C\\uACF5\\uD558\\uC9C0 \\uC54A\\uAE30 \\uB54C\\uBB38\\uC5D0, \\uC774\\uB807\\uAC8C \\uD574\\uC57C \\uB418\\uB294 \\uAC83\\uC774 \\uB108\\uBB34 \\uBD88\\uD3B8\\uD558\\uB2E4\\uACE0 \\uC0DD\\uAC01\\uD588\\uB2E4. \\uD558\\uC9C0\\uB9CC \\uB0B4\\uAC00 \\uBB38\\uC11C\\uB97C \\uC798 \\uBABB \\uC77D\\uC5C8\\uB358 \\uAC83\\uC774\\uACE0, \",(0,e.jsx)(n.code,{children:\"enable-host-port\"}),\"\\uAC00 \",(0,e.jsx)(n.code,{children:\"enable-node-port\"}),\"\\uC640 \\uD568\\uAED8 \\uC124\\uC815\\uB420 \\uB54C Enabled\\uC774 \\uB418\\uC5C8\\uB2E4. \\uD574\\uB2F9 Worker Node \\uD658\\uACBD\\uC5D0\\uC11C \",(0,e.jsx)(n.code,{children:\"strict\"}),\" \\uC124\\uC815\\uC73C\\uB85C kube proxy\\uB97C Cilium eBPF\\uB85C \\uB300\\uCCB4\\uD574\\uB3C4 \\uBB38\\uC81C\\uAC00 \\uC5C6\\uC5C8\\uB2E4. \",(0,e.jsx)(n.code,{children:\"cilium-config\"}),\"\\uC758 \",(0,e.jsx)(n.code,{children:\"kube-proxy-replacement\"}),\"\\uC744 \",(0,e.jsx)(n.code,{children:\"probe\"}),\" \\uD639\\uC740 \",(0,e.jsx)(n.code,{children:\"strict\"}),\"\\uB85C \\uC124\\uC815\\uD558\\uBA74 \\uAC04\\uB2E8\\uD558\\uAC8C \\uD574\\uACB0\\uB420 \\uC218 \\uC788\\uB294 \\uBB38\\uC81C\\uC600\\uB2E4. \\u{1F92A}\"]})]})}}var P=y;return f;})();\n;return Component;","toc":[{"value":"테스트 환경","url":"#테스트-환경","depth":2},{"value":"이슈 사항","url":"#이슈-사항","depth":2},{"value":"HostPort","url":"#hostport","depth":2},{"value":"HostPort with Cilium's eBPF","url":"#hostport-with-ciliums-ebpf","depth":2},{"value":"CNI plugin portmap","url":"#cni-plugin-portmap","depth":2},{"value":"eBPF로 대체","url":"#ebpf로-대체","depth":2},{"value":"결론","url":"#결론","depth":2}],"frontMatter":{"readingTime":{"text":"9 min read","minutes":8.43,"time":505800,"words":1686},"slug":"20240207-cilium-host-port","fileName":"20240207-cilium-host-port.md","title":"Cilium CNI와 HostPort","date":"2024-02-07T00:00:00.000Z","tags":["kubernetes","cilium"],"images":["/static/images/social-banner.png"],"summary":"네이버 클라우드 쿠버네티스 서비스에서 HostPort를 설정하였는데, 정상적으로 Node Port를 통해서 Container에 접근할 수가 없었다. 처음에는 CNI plugin portmap을 설정하여 HostPort를 Iptables Rule로 적용하도록 하였다. 하지만 현재 운영하는 Kernel 버전이 kube proxy를 대체할 수 있는 것을 파악하였고, default로 설정된 KubeProxyReplacement=disabled을 KubeProxyReplacement=strict으로 설정하여 Cilium eBPF로 대체하여 사용하였다."}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.15,"time":9000,"words":30},"slug":["default"],"fileName":"default.md","name":"Jay","avatar":"profile.png","occupation":"Software Engineer","date":null}],"prev":{"title":"Cert Manager Webhook 작성하여 Naver Cloud에서 DNS-01 challeng로 Lets Encrypt 인증서 발급하기","date":"2024-01-24T00:00:00.000Z","tags":["kubernetes","ncloud"],"images":["/static/images/social-banner.png"],"summary":"Cert Manager의 DNS provider 목록에 Naver Cloud DNS는 없었다. 하지만 Cert Manager에서 새로운 DNS provider를 직접 연결해서 사용할 수 있도록 webhook solver라는 것을 제공한다. 따라서 Naver Cloud API를 사용하여 webhook 코드를 작성하고, Github Action을 통해서 Image와 Helm chart를 배포해서 사용했다. Cert Manager에서 Boilerplate code와 test framework를 제공하여 비교적 쉽게 작성해서 사용할 수 있었다.","slug":"20240124-cert-manager-webhook"},"next":{"title":"Tekton Chain","date":"2024-02-11T00:00:00.000Z","tags":["kubernetes","tekton","devsecops"],"images":["/static/images/social-banner.png"],"summary":"Kubernetes에서 Tekton Chain을 통해서 어떻게 Software Supply Chain Security를 구성할 수 있는지 확인했다. Tekton Pipeline으로 git clone을 하고, container image를 build하고, 최종적으로 OCI registry에 push하도록 구성했다. 그리고 Tekton Chain이 어떻게 in-toto spec의 Attestation 정보를 남기는지 확인하였다.","slug":"20240208-tekton-chain"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["20240207-cilium-host-port"]},"buildId":"ey5ly7YBUIi0sFNRIGYkn","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>