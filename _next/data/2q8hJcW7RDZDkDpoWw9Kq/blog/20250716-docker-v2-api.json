{"pageProps":{"post":{"mdxSource":"var Component=(()=>{var o=Object.create;var s=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var d=Object.getOwnPropertyNames;var p=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var r=a=>s(a,\"__esModule\",{value:!0});var u=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports),g=(a,t)=>{r(a);for(var i in t)s(a,i,{get:t[i],enumerable:!0})},N=(a,t,i)=>{if(t&&typeof t==\"object\"||typeof t==\"function\")for(let n of d(t))!m.call(a,n)&&n!==\"default\"&&s(a,n,{get:()=>t[n],enumerable:!(i=h(t,n))||i.enumerable});return a},k=a=>N(r(s(a!=null?o(p(a)):{},\"default\",a&&a.__esModule&&\"default\"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var l=u((I,c)=>{c.exports=_jsx_runtime});var v={};g(v,{default:()=>y,frontmatter:()=>f});var e=k(l()),f={title:\"How To Authenticate With Docker API\",date:\"2025-07-16\",tags:[\"docker\",\"LLM\"],images:[\"/static/images/thumbnail/write-bash-script.png\"],summary:\"I needed to iterate through all image repositories in my private container registry, find the latest build for each, and save them as individual tar files. Although an LLM can generate code for this task quickly, it's worth knowing how to issue an authentication token for the Docker API. This could be important for guiding the LLM to produce a correct final version.\"};function w(a={}){let{wrapper:t}=a.components||{};return t?(0,e.jsx)(t,Object.assign({},a,{children:(0,e.jsx)(i,{})})):i();function i(){let n=Object.assign({p:\"p\",h2:\"h2\",a:\"a\",span:\"span\",pre:\"pre\",code:\"code\",h3:\"h3\",blockquote:\"blockquote\"},a.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"I needed to write a simple bash script to iterate through all the image repositories in my private container registry, find the latest build for each, and save them as individual .tar files. I didn't want to do this manually because there are too many images, and I knew I would have to do it again later.\"}),(0,e.jsx)(n.p,{children:\"Since we're in the age of AI, I asked an LLM to generate the script. Instead of trying to remember all the bash syntax, an LLM can generate code in just a few seconds. However, it's common to encounter errors when you run the generated script. You then have to report the errors back to the AI to fix the problem, sometimes repeating the process over and over. This shows how important it is to give LLMs clear and correct instructions.\"}),(0,e.jsx)(n.p,{children:\"For instance, when I asked Gemini to generate a script for this task, the code it produced was almost perfect. But depending on how you write the prompt, it can miss crucial steps. In my case, it initially forgot to include the function to generate an authentication token.\"}),(0,e.jsxs)(n.h2,{id:\"how-to-authenticate\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#how-to-authenticate\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"How To Authenticate\"]}),(0,e.jsx)(n.p,{children:\"You can get information on how to authenticate to your registry from the Www-Authenticate response header. For example, if your registry supports the Docker V2 API, an unauthenticated request to list an image's tags will fail.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"curl\"}),\" -i \",(0,e.jsxs)(n.span,{className:\"token string\",children:['\"https://my-private-repository.com/v2/',(0,e.jsx)(n.span,{className:\"token variable\",children:\"$name\"}),'/tags/list\"']}),`\n`]})})}),(0,e.jsx)(n.p,{children:\"You'll get a 401 Unauthorized status code back, and the response will include a Www-Authenticate header. This header contains information about where you need to request a token (realm), and which service and scope to use. This information can vary depending on the container registry.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"www-authenticate: Bearer \",(0,e.jsx)(n.span,{className:\"token variable assign-left\",children:\"realm\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"https://my-private-repository.com/auth/token\"'}),\",service\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"ncr\"'}),\",scope\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"repository:tutorial:pull\"'}),`\n`]})})}),(0,e.jsx)(n.p,{children:\"With this information, you can get an authentication token using basic authentication, like so:\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"curl\"}),\" -u \",(0,e.jsxs)(n.span,{className:\"token string\",children:['\"',(0,e.jsx)(n.span,{className:\"token variable\",children:\"$USERNAME\"}),\":\",(0,e.jsx)(n.span,{className:\"token variable\",children:\"$PASSWORD\"}),'\"']}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"https://my-private-repository.com/auth/token?service=ncr&scope=repository:tutorial:pull\"'}),`\n`]})})}),(0,e.jsx)(n.p,{children:\"Now that you have the token, you can make an authorized request to get all the tags.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"curl\"}),\" -H \",(0,e.jsxs)(n.span,{className:\"token string\",children:['\"Authorization: Bearer ',(0,e.jsx)(n.span,{className:\"token variable\",children:\"${TOKEN}\"}),'\"']}),\" \",(0,e.jsxs)(n.span,{className:\"token string\",children:['\"https://my-private-repository.com/v2/',(0,e.jsx)(n.span,{className:\"token variable\",children:\"$name\"}),'$/tags/list\"']}),`\n`]})})}),(0,e.jsxs)(n.p,{children:[\"You can get a list of all image repositories in your container registry using the \",(0,e.jsx)(n.code,{children:\"v2/_catalog\"}),\" API. However, the Www-Authenticate header for this endpoint doesn't explicitly state the required scope.\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"curl\"}),` -i https://my-private-repository.com/v2/_catalog\n`]})})}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"www-authenticate: Bearer \",(0,e.jsx)(n.span,{className:\"token variable assign-left\",children:\"realm\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"https://my-private-repository.com/auth/token\"'}),\",service\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"ncr\"'}),`\n`]})})}),(0,e.jsx)(n.p,{children:\"To get a token with the correct permissions, you must set the scope to registry:catalog:*.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"curl\"}),\" -u \",(0,e.jsxs)(n.span,{className:\"token string\",children:['\"',(0,e.jsx)(n.span,{className:\"token variable\",children:\"$USERNAME\"}),\":\",(0,e.jsx)(n.span,{className:\"token variable\",children:\"$PASSWORD\"}),'\"']}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"https://my-private-repository.com/auth/token?service=ncr&scope=registry:catalog:*\"'}),`\n`]})})}),(0,e.jsxs)(n.h2,{id:\"generating-with-llm\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#generating-with-llm\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Generating with LLM\"]}),(0,e.jsxs)(n.p,{children:[\"From the explanation above, you probably have a good idea of the process. You can get a list of all image repositories from your container registry using the \",(0,e.jsx)(n.code,{children:\"v2/_catalog\"}),\" API and then iterate through them to find the latest build for each. You also know that you need to authenticate with the private registry and how to do it.\"]}),(0,e.jsx)(n.p,{children:\"Now, let's have an LLM do the work.\"}),(0,e.jsxs)(n.h3,{id:\"claude-sonnet-4\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#claude-sonnet-4\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Claude Sonnet 4\"]}),(0,e.jsx)(n.p,{children:\"My first prompt was:\"}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"please write a bash script. I needed to iterate through all image repositories in my private container registry, find the latest build for each, and save them as individual tar files.\"})}),(0,e.jsx)(n.p,{children:\"Claude generated a nice bash script. However, instead of first requesting a token from the realm URL, the script attempted to use basic authentication for every API call.\"}),(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight language-sh\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`get_repositories() {\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    local auth_header\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    auth_header=$(echo -n \"$REGISTRY_USERNAME:$REGISTRY_PASSWORD\" | base64)\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    log \"Fetching repository list from registry...\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    # For Docker Registry API v2\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    local repos_url=\"https://$REGISTRY_URL/v2/_catalog\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    if ! curl -s -H \"Authorization: Basic $auth_header\" \"$repos_url\" | jq -r '.repositories[]' 2>/dev/null; then\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        error \"Failed to fetch repositories. Make sure your registry supports Docker Registry API v2\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        exit 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    fi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`}\n`})]})}),(0,e.jsx)(n.p,{children:\"After I gave it additional guidance, it generated the code I was expecting.\"}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"basic authentication is not working. You should issue a authentication token to authenticate to API.\"})}),(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight language-sh\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`get_auth_token() {\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    local service=\"$1\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    local scope=\"$2\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    # First, try to get the authentication realm from the registry\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    local auth_challenge\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    auth_challenge=$(curl -s -I \"https://$REGISTRY_URL/v2/\" | grep -i \"www-authenticate\" | head -1)\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    if [[ -z \"$auth_challenge\" ]]; then\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        error \"Could not get authentication challenge from registry\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        exit 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    fi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    # Extract realm, service, and scope from the challenge\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    local realm\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    realm=$(echo \"$auth_challenge\" | sed -n 's/.*realm=\"\\\\([^\"]*\\\\)\".*/\\\\1/p')\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    if [[ -z \"$realm\" ]]; then\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        error \"Could not extract authentication realm\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        exit 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    fi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    log \"Getting authentication token from: $realm\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    # Request token with proper parameters\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    local token_url=\"$realm\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    local token_params=\"service=$service\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    if [[ -n \"$scope\" ]]; then\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        token_params=\"$token_params&scope=$scope\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    fi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    local token_response\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    token_response=$(curl -s -u \"$REGISTRY_USERNAME:$REGISTRY_PASSWORD\" \"$token_url?$token_params\")\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    if [[ $? -ne 0 ]]; then\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        error \"Failed to get authentication token\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        exit 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    fi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    # Extract token from response\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    local token\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    token=$(echo \"$token_response\" | jq -r '.token // .access_token' 2>/dev/null)\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    if [[ -z \"$token\" || \"$token\" == \"null\" ]]; then\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        error \"Could not extract token from response\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        exit 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    fi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    echo \"$token\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`}\n`})]})}),(0,e.jsxs)(n.p,{children:['I had to provide more instructions to fix other parts as well. For instance, Claude initially interpreted \"latest build\" as simply getting the image with the tag name \"latest\". In the end, the script was able to retrieve all image repositories and find the true latest build by using two additional API calls: ',(0,e.jsx)(n.code,{children:\"v2/${repo}/manifests/${tag}\"}),\" and \",(0,e.jsx)(n.code,{children:\"v2/${repo}/blobs/${config_digest}\"}),\".\"]}),(0,e.jsxs)(n.h3,{id:\"gemini-25-pro\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#gemini-25-pro\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Gemini 2.5 Pro\"]}),(0,e.jsx)(n.p,{children:\"I prefer to use Gemini because its token allowance is more generous, and I don't have to pay extra on my current plan. I sent the same prompt to Gemini.\"}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"please write a bash script. I needed to iterate through all image repositories in my private container registry, find the latest build for each, and save them as individual tar files.\"})}),(0,e.jsx)(n.p,{children:\"It turned out that the authentication part was completely missing, so I provided an additional instruction.\"}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"it need to issue a token to authenticate to my private container registry.\"})}),(0,e.jsx)(n.p,{children:\"However, this time it just defined an AUTH_URL variable instead of getting it dynamically from the Www-Authenticate header. I had to give it a more specific instruction.\"}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"you need to get auth url from www-authenticate insead.\"})}),(0,e.jsx)(n.p,{children:\"Just like with Claude, I had to chat a little bit more with Gemini to fix minor issues. In the end, the result was quite similar.\"}),(0,e.jsxs)(n.h2,{id:\"conclusion\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#conclusion\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Conclusion\"]}),(0,e.jsx)(n.p,{children:\"Gemini and Claude did the boring job of writing a simple bash script for me. However, they didn't generate perfect code on the first try. It was worthwhile to understand how authentication works with the www-authenticate response header and the Docker API. Based on this knowledge, you can give the LLM more specific guidance to generate a final, working version of the code.\"})]})}}var y=w;return v;})();\n;return Component;","toc":[{"value":"How To Authenticate","url":"#how-to-authenticate","depth":2},{"value":"Generating with LLM","url":"#generating-with-llm","depth":2},{"value":"Claude Sonnet 4","url":"#claude-sonnet-4","depth":3},{"value":"Gemini 2.5 Pro","url":"#gemini-25-pro","depth":3},{"value":"Conclusion","url":"#conclusion","depth":2}],"frontMatter":{"readingTime":{"text":"7 min read","minutes":6.035,"time":362100,"words":1207},"slug":"20250716-docker-v2-api","fileName":"20250716-docker-v2-api.md","title":"How To Authenticate With Docker API","date":"2025-07-16T00:00:00.000Z","tags":["docker","LLM"],"images":["/static/images/thumbnail/write-bash-script.png"],"summary":"I needed to iterate through all image repositories in my private container registry, find the latest build for each, and save them as individual tar files. Although an LLM can generate code for this task quickly, it's worth knowing how to issue an authentication token for the Docker API. This could be important for guiding the LLM to produce a correct final version."}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.15,"time":9000,"words":30},"slug":["default"],"fileName":"default.md","name":"Jay","avatar":"profile.png","occupation":"Software Engineer","date":null}],"prev":{"title":"Configuring Private Runner Images for Gitea Runner","date":"2025-07-12T00:00:00.000Z","tags":["gitea"],"images":["/static/images/thumbnail/gitea.png"],"summary":"I needed to set up a self-hosted Git system and was looking for an open-source tool that would fit my requirements. Gitea seemed like a great fit, and I was particularly interested in Gitea Actions, which is compatible with GitHub Actions. However, I struggled to correctly configure a Gitea Actions runner to use a container image from a private repository. Through that process, I gained a much better understanding of how Gitea offers a CI/CD system compatible with GitHub Actions. In this post, I'll share what I learned.","slug":"20250712-gitea-action"},"next":null},"__N_SSG":true}