{"pageProps":{"post":{"mdxSource":"var Component=(()=>{var r=Object.create;var c=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var h=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var i=a=>c(a,\"__esModule\",{value:!0});var u=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports),N=(a,t)=>{i(a);for(var s in t)c(a,s,{get:t[s],enumerable:!0})},k=(a,t,s)=>{if(t&&typeof t==\"object\"||typeof t==\"function\")for(let n of p(t))!m.call(a,n)&&n!==\"default\"&&c(a,n,{get:()=>t[n],enumerable:!(s=d(t,n))||s.enumerable});return a},g=a=>k(i(c(a!=null?r(h(a)):{},\"default\",a&&a.__esModule&&\"default\"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var l=u((v,o)=>{o.exports=_jsx_runtime});var w={};N(w,{default:()=>f,frontmatter:()=>b});var e=g(l()),b={title:\"Unexpected Trace Data Behavior in Google Cloud Trace with OpenTelemetry\",date:\"2025-07-24\",tags:[\"opentelemetry\",\"nodejs\"],images:[\"/static/images/thumbnail/trace-data.png\"],summary:\"My system exports telemetry data from a Node.js application using OpenTelemetry. I configured the OpenTelemetry Collector to send that data to a GCP-managed service via the Google Cloud Exporter. Later, while reviewing database query information from the application, I noticed something odd in the trace data. As I dug deeper, I discovered some limitations of GCP Cloud Trace and how the mysql2 instrumentation package sets attribute values. That investigation helped explain the strange behavior I was seeing in the trace data.\"};function y(a={}){let{wrapper:t}=a.components||{};return t?(0,e.jsx)(t,Object.assign({},a,{children:(0,e.jsx)(s,{})})):s();function s(){let n=Object.assign({p:\"p\",a:\"a\",h2:\"h2\",span:\"span\",code:\"code\",pre:\"pre\",blockquote:\"blockquote\"},a.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"I have applications running on GKE (Google Kubernetes Engine), and I\\u2019ve configured OpenTelemetry to collect telemetry data\\u2014including logs, metrics, and traces. In other cloud environments, I used tools like Tempo, Loki, and Thanos to store this telemetry data.\"}),(0,e.jsxs)(n.p,{children:[\"However, Google Cloud offers a fully managed monitoring service that can significantly reduce the operational overhead of running these tools yourself. Thanks to the \",(0,e.jsx)(n.a,{href:\"https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/v0.130.0/exporter/googlecloudexporter/README.md\",children:\"Google Cloud Exporter\"}),\", integrating with the OpenTelemetry Collector is straightforward.\"]}),(0,e.jsx)(n.p,{children:\"Everything was working well and the setup was simple. But then I noticed something odd in the trace data later. That\\u2019s where my story begins.\"}),(0,e.jsxs)(n.h2,{id:\"unexpected-jdbc-format-in-nodejs-trace-data\",children:[(0,e.jsx)(n.a,{href:\"#unexpected-jdbc-format-in-nodejs-trace-data\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Unexpected JDBC Format in Node.js Trace Data\"]}),(0,e.jsxs)(n.p,{children:[\"While analyzing trace data from a Node.js application, I noticed something odd in the \",(0,e.jsx)(n.code,{children:\"db.connection_string\"}),\" attribute:\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"code-highlight language-bash\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`jdbc:mysql://127.0.0.1:3306/my_db\n`})})}),(0,e.jsx)(n.p,{children:\"Wait, JDBC? That caught me off guard. why is a Node.js application emitting a JDBC-style connection string?\"}),(0,e.jsxs)(n.p,{children:[\"The trace was generated by the \",(0,e.jsx)(n.a,{href:\"https://www.npmjs.com/package/@opentelemetry/instrumentation-mysql2\",children:\"mysql2 instrumentation package\"}),\". Naturally, I wanted to understand why a JDBC prefix was appearing in trace data from a JavaScript runtime. So I did some digging.\"]}),(0,e.jsxs)(n.p,{children:[\"It turns out the MySQL2 instrumentation itself generates this format! \",(0,e.jsx)(n.a,{href:\"https://github.com/open-telemetry/opentelemetry-js-contrib/blob/winston-transport-v0.14.0/packages/instrumentation-mysql2/src/utils.ts\",children:\"Here\\u2019s the relevant code from the library\"}),\":\"]}),(0,e.jsx)(n.pre,{className:\"language-js\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-js\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword module\",children:\"export\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"function\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"getConnectionAttributes\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsxs)(n.span,{className:\"token parameter\",children:[\"config\",(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Config\"})]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Attributes\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),\" host\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" port\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" database\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" user \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"getConfig\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"config\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" portNumber \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"parseInt\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"port\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword control-flow\",children:\"if\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"!\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"isNaN\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"portNumber\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword control-flow\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_NET_PEER_NAME\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" host\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_NET_PEER_PORT\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" portNumber\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_CONNECTION_STRING\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"getJDBCString\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"host\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" port\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" database\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_NAME\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" database\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_USER\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" user\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword control-flow\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_NET_PEER_NAME\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" host\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_CONNECTION_STRING\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"getJDBCString\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"host\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" port\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" database\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_NAME\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" database\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_USER\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" user\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"As you can see, the instrumentation calls \",(0,e.jsx)(n.code,{children:\"getJDBCString\"}),\" to generate the connection string, even in a Node.js context.\"]}),(0,e.jsx)(n.p,{children:\"But why did they choose to use a JDBC-style format?\"}),(0,e.jsxs)(n.p,{children:[\"To investigate further, I checked \",(0,e.jsx)(n.a,{href:\"https://github.com/open-telemetry/opentelemetry-js-contrib/blob/instrumentation-mysql2-v0.49.0/packages/instrumentation-mysql2/README.md\",children:\"the README of the MySQL2 instrumentation package\"}),\". It states:\"]}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"This package uses @opentelemetry/semantic-conventions version 1.22+, which implements Semantic Convention Version 1.7.0\"})}),(0,e.jsxs)(n.p,{children:[\"So I followed the trail to \",(0,e.jsx)(n.a,{href:\"https://github.com/open-telemetry/opentelemetry-specification/blob/v1.7.0/semantic_conventions/trace/database.yaml\",children:\"the OpenTelemetry Specification for Semantic Conventions v1.7.0\"}),\", specifically the section related to databases. Here\\u2019s the relevant snippet:\"]}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yaml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"id\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` connection_string\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"tag\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" connection\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`level\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"type\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` string\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"brief\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\">\"}),(0,e.jsx)(n.span,{className:\"token string scalar\",children:`\n`})]}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token string scalar\",children:`\t\t\tThe connection string used to connect to the database.\n`})}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token string scalar\",children:\"\t\t\tIt is recommended to remove embedded credentials.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"examples\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'Server=(localdb)\\\\v11.0;Integrated Security=true;'\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"Unfortunately, it doesn\\u2019t directly mention the JDBC format. Still curious, I browsed through related GitHub issues and eventually found \",(0,e.jsx)(n.a,{href:\"https://github.com/open-telemetry/opentelemetry-js-contrib/issues/473\",children:\"this one\"}),\", which indirectly suggested that earlier specifications or conventions may have encouraged using JDBC-style strings\\u2014even outside of Java environments.\"]}),(0,e.jsx)(n.p,{children:\"So in the end, it turns out that seeing a JDBC-style connection string in Node.js trace data is normal behavior, at least when using this instrumentation. It\\u2019s hardcoded by the library itself.\"}),(0,e.jsxs)(n.h2,{id:\"dbstatement-information-was-truncated\",children:[(0,e.jsx)(n.a,{href:\"#dbstatement-information-was-truncated\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),(0,e.jsx)(n.code,{children:\"db.statement\"}),\" information Was Truncated\"]}),(0,e.jsxs)(n.p,{children:[\"I discovered a limitation with the GCP-managed Cloud Trace service: the \",(0,e.jsx)(n.code,{children:\"db.statement\"}),\" attribute was being truncated. This attribute is particularly useful for identifying which query a client is executing for each URL, but in GCP Cloud Trace, the query information was incomplete and cut off.\"]}),(0,e.jsxs)(n.p,{children:[\"According to \",(0,e.jsx)(n.a,{href:\"https://cloud.google.com/trace/docs/quotas\",children:\"the GCP official documentation\"}),\", there\\u2019s a strict limit:\"]}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"Maximum size of value for a label or attribute: 256 bytes\"})}),(0,e.jsx)(n.p,{children:\"This explains why the full SQL query wasn\\u2019t visible in the trace.\"}),(0,e.jsxs)(n.h2,{id:\"dbname-is-not-following-the-spec\",children:[(0,e.jsx)(n.a,{href:\"#dbname-is-not-following-the-spec\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),(0,e.jsx)(n.code,{children:\"db.name\"}),\" Is Not Following the Spec\"]}),(0,e.jsxs)(n.p,{children:[\"Since I couldn\\u2019t always determine which database a client was querying based solely on the (truncated) \",(0,e.jsx)(n.code,{children:\"db.statement\"}),\", I started paying more attention to the \",(0,e.jsx)(n.code,{children:\"db.name\"}),\" attribute.\"]}),(0,e.jsxs)(n.p,{children:[\"Even if you configure a single database for the initial connection using the mysql2 library, you can still issue queries to other logical databases. According to the OpenTelemetry semantic conventions (version 1.7.0), the \",(0,e.jsx)(n.code,{children:\"db.name\"}),\" attribute is \",(0,e.jsx)(n.code,{children:\"call-level\"}),\" and should reflect the actual database targeted by a given statement.\"]}),(0,e.jsx)(n.p,{children:\"From the spec:\"}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yaml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"id\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` name\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"tag\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" call\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`level\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"type\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` string\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"required\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"conditional\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\">\"}),(0,e.jsx)(n.span,{className:\"token string scalar\",children:`\n`})]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token string scalar\",children:\"\t\t\tRequired, if applicable and no more-specific attribute is defined.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"brief\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\">\"}),(0,e.jsx)(n.span,{className:\"token string scalar\",children:`\n`})]}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token string scalar\",children:`\t\tIf no [tech-specific attribute](#call-level-attributes-for-specific-technologies)\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token string scalar\",children:`\t\tis defined, this attribute is used to report the name of the database being accessed.\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token string scalar\",children:`\t\tFor commands that switch the database, this should be set to the target database\n`})}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token string scalar\",children:\"\t\t(even if the command fails).\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"note\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\">\"}),(0,e.jsx)(n.span,{className:\"token string scalar\",children:`\n`})]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token string scalar\",children:'\t\tIn some SQL databases, the database name to be used is called \"schema name\".'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"examples\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'customers'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'main'\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"So what happens when you run a query like this?\"}),(0,e.jsx)(n.pre,{className:\"language-sql\",children:(0,e.jsx)(n.code,{className:\"code-highlight language-sql\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"SELECT\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"FROM\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"`\"}),\"other_db\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"some_table\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"`\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]})})}),(0,e.jsxs)(n.p,{children:[\"According to the spec, the \",(0,e.jsx)(n.code,{children:\"db.name\"}),\" should be \",(0,e.jsx)(n.code,{children:\"other_db\"}),\". However, in practice, \",(0,e.jsx)(n.code,{children:\"db.name\"}),\" always reflects the database configured during the initial connection.\"]}),(0,e.jsxs)(n.p,{children:[\"This behavior can be traced to the implementation of the mysql2 instrumentation package, which sets \",(0,e.jsx)(n.code,{children:\"db.name\"}),\" based on the connection config rather than parsing the query dynamically:\"]}),(0,e.jsx)(n.pre,{className:\"language-js\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-js\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword module\",children:\"export\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"function\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"getConnectionAttributes\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsxs)(n.span,{className:\"token parameter\",children:[\"config\",(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Config\"})]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Attributes\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),\" host\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" port\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" database\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" user \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"getConfig\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"config\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" portNumber \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"parseInt\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"port\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword control-flow\",children:\"if\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"!\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"isNaN\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"portNumber\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword control-flow\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_NET_PEER_NAME\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" host\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_NET_PEER_PORT\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" portNumber\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_CONNECTION_STRING\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"getJDBCString\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"host\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" port\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" database\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_NAME\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" database\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_USER\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" user\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword control-flow\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_NET_PEER_NAME\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" host\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_CONNECTION_STRING\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"getJDBCString\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"host\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" port\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" database\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_NAME\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" database\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"SEMATTRS_DB_USER\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" user\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"This means that even if you query a different logical database, the instrumentation will always report the original connection database as \",(0,e.jsx)(n.code,{children:\"db.name\"}),\".\"]}),(0,e.jsxs)(n.h2,{id:\"attributes-were-not-consistent-from-the-same-source\",children:[(0,e.jsx)(n.a,{href:\"#attributes-were-not-consistent-from-the-same-source\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Attributes Were Not Consistent from the Same Source\"]}),(0,e.jsx)(n.p,{children:\"I noticed another strange behavior in GCP Cloud Trace: the attribute keys in the trace data were not consistent. Initially, I assumed that this might be because two different sources were sending trace data. However, the real cause turned out to be a strict limitation in GCP Cloud Trace:\"}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"Maximum number of labels or attributes per span: 32\"})}),(0,e.jsx)(n.p,{children:\"Since the spans had more than 32 attributes, Cloud Trace may simply drop the excess ones. Because the order of attributes isn\\u2019t guaranteed, it might drop different attributes even for spans from the same source. As a result, the attributes displayed in the UI can vary between otherwise identical spans, giving the impression that the attribute keys are inconsistent.\"}),(0,e.jsxs)(n.h2,{id:\"conclusion\",children:[(0,e.jsx)(n.a,{href:\"#conclusion\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Conclusion\"]}),(0,e.jsxs)(n.p,{children:[\"I noticed some odd behavior in the trace data from GCP Cloud Trace and initially suspected that my system wasn\\u2019t storing trace data correctly. In the end, there was no issue with my setup. The problem came from the mysql2 instrumentation package, which strictly adheres to OpenTelemetry Specification \",(0,e.jsx)(n.code,{children:\"v1.7.0\"}),\" and sets the JDBC string format to the \",(0,e.jsx)(n.code,{children:\"db.connection_string\"}),\" attribute.\"]}),(0,e.jsx)(n.p,{children:\"Due to GCP Cloud Trace limits\\u2014specifically, the maximum size of an attribute value and the maximum number of attributes per span\\u2014some attribute values were truncated, and others were dropped entirely. This made the trace data appear inconsistent, even though it came from a single, identical source.\"}),(0,e.jsxs)(n.p,{children:[\"While digging deeper to understand the issue, I also noticed that the \",(0,e.jsx)(n.code,{children:\"db.name\"}),\" attribute is defined at the call level in the OpenTelemetry spec. However, the mysql2 instrumentation doesn\\u2019t fully follow this when you\\u2019re querying other logical databases from the same application. This could be an interesting problem to explore further\\u2014perhaps as a future side project to improve the library.\"]}),(0,e.jsxs)(n.p,{children:[\"Another idea that came to mind: it would be useful if users could choose which version of the semantic conventions an instrumentation library follows. At the time of writing, the latest OpenTelemetry specification version is \",(0,e.jsx)(n.code,{children:\"v1.36.0\"}),\", while the \",(0,e.jsx)(n.code,{children:\"db.connection_string\"}),\" attribute was removed in \",(0,e.jsx)(n.code,{children:\"v1.25.0\"}),\".\"]}),(0,e.jsxs)(n.p,{children:[\"I understand that upgrading to newer spec versions is difficult due to compatibility concerns. especially if your monitoring systems rely on certain attributes. But currently, for example, the mysql2 instrumentation is locked into \",(0,e.jsx)(n.code,{children:\"v1.7.0\"}),\". What if the library allowed users to select a semantic version, and the instrumentation adapted its behavior accordingly?\"]})]})}}var f=y;return w;})();\n;return Component;","toc":[{"value":"Unexpected JDBC Format in Node.js Trace Data","url":"#unexpected-jdbc-format-in-nodejs-trace-data","depth":2},{"value":"db.statement information Was Truncated","url":"#dbstatement-information-was-truncated","depth":2},{"value":"db.name Is Not Following the Spec","url":"#dbname-is-not-following-the-spec","depth":2},{"value":"Attributes Were Not Consistent from the Same Source","url":"#attributes-were-not-consistent-from-the-same-source","depth":2},{"value":"Conclusion","url":"#conclusion","depth":2}],"frontMatter":{"readingTime":{"text":"9 min read","minutes":8.105,"time":486300,"words":1621},"slug":"20250724-nodejs-trace-database-data","fileName":"20250724-nodejs-trace-database-data.md","title":"Unexpected Trace Data Behavior in Google Cloud Trace with OpenTelemetry","date":"2025-07-24T00:00:00.000Z","tags":["opentelemetry","nodejs"],"images":["/static/images/thumbnail/trace-data.png"],"summary":"My system exports telemetry data from a Node.js application using OpenTelemetry. I configured the OpenTelemetry Collector to send that data to a GCP-managed service via the Google Cloud Exporter. Later, while reviewing database query information from the application, I noticed something odd in the trace data. As I dug deeper, I discovered some limitations of GCP Cloud Trace and how the mysql2 instrumentation package sets attribute values. That investigation helped explain the strange behavior I was seeing in the trace data."}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.15,"time":9000,"words":30},"slug":["default"],"fileName":"default.md","name":"Jay","avatar":"profile.png","occupation":"Software Engineer","date":null}],"prev":{"title":"Configuring Sentry's SAML2 Provider with Keycloak","date":"2025-07-22T00:00:00.000Z","tags":["sentry","keycloak","saml2"],"images":["/static/images/thumbnail/sentry-saml2-keycloak.png"],"summary":"This time, I integrated Sentry with Keycloak. There are several helpful blog posts available that make the process easy to follow. However, out of curiosity, I wanted to understand exactly what was happening behind the scenesâ€”and clarify which steps are truly necessary.","slug":"20250722-sentry-saml2"},"next":null},"__N_SSG":true}